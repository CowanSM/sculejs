var Scule={namespaces:{}};(function(){Scule.registerNamespace=function(t,e){if(t in Scule)throw"namespace "+t+" is already registered";Scule[t]=e},Scule.registerComponent=function(t,e,n,i){var s=Scule.require(t);if(!(e in s))throw"type "+e+" is not registered inside "+t+" namespace";s[e][n]=i},Scule.require=function(t){if(!(t in Scule))throw"namespace "+t+" has not been registered, require failed";return Scule[t]},Scule.registerNamespace("global",{constants:{ID_FIELD:"_id",REF_FIELD:"_ref",OBJECT_WILDCARD:"*"},classes:{},functions:{},system:{},variables:{debug:!1}}),Scule.registerNamespace("datastructures",{constants:Scule.require("global").constants,classes:{},variables:{}}),Scule.registerNamespace("instrumentation",{constants:Scule.require("global").constants,classes:{}}),Scule.registerNamespace("interpreter",{functions:{},classes:{},objects:{},variables:{},symbols:{table:{}},arities:{expression:-1,logical:0,binary:1,selective:2,negative:3,range:4,mutate:5,array:6,geospatial:7,variable:8,operand:9,index:10},constants:Scule.require("global").constants}),Scule.registerNamespace("db",{constants:Scule.require("global").constants,functions:{},classes:{},plugins:{},engines:{},objects:{core:{collections:{}}}}),Scule.registerNamespace("events",{functions:{},classes:{},objects:{}}),Scule.registerNamespace("messaging",{functions:{},classes:{},objects:{}})})(),function(){Scule.global.system.installHashFunctions=function(){Scule.global.classes.sha1=function(){this.hexcase=0,this.b64pad="",this.hex_sha1=function(t){return this.rstr2hex(this.rstr_sha1(this.str2rstr_utf8(t)))},this.hash=function(t){return this.hex_sha1(t)},this.b64_sha1=function(t){return this.rstr2b64(this.rstr_sha1(this.str2rstr_utf8(t)))},this.any_sha1=function(t,e){return this.rstr2any(this.rstr_sha1(this.str2rstr_utf8(t)),e)},this.hex_hmac_sha1=function(t,e){return this.rstr2hex(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)))},this.b64_hmac_sha1=function(t,e){return this.rstr2b64(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)))},this.any_hmac_sha1=function(t,e,n){return this.rstr2any(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)),n)},this.sha1_vm_test=function(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==this.hex_sha1("abc").toLowerCase()},this.rstr_sha1=function(t){return this.binb2rstr(this.binb_sha1(this.rstr2binb(t),8*t.length))},this.rstr_hmac_sha1=function(t,e){var n=this.rstr2binb(t);n.length>16&&(n=this.binb_sha1(n,8*t.length));for(var i=Array(16),s=Array(16),r=0;16>r;r++)i[r]=909522486^n[r],s[r]=1549556828^n[r];var a=this.binb_sha1(i.concat(this.rstr2binb(e)),512+8*e.length);return this.binb2rstr(this.binb_sha1(s.concat(a),672))},this.rstr2hex=function(t){this.hexcase=0;for(var e,n=this.hexcase?"0123456789ABCDEF":"0123456789abcdef",i="",s=0;t.length>s;s++)e=t.charCodeAt(s),i+=n.charAt(15&e>>>4)+n.charAt(15&e);return i},this.rstr2b64=function(t){this.b64pad="";for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="",i=t.length,s=0;i>s;s+=3)for(var r=t.charCodeAt(s)<<16|(i>s+1?t.charCodeAt(s+1)<<8:0)|(i>s+2?t.charCodeAt(s+2):0),a=0;4>a;a++)n+=8*s+6*a>8*t.length?this.b64pad:e.charAt(63&r>>>6*(3-a));return n},this.rstr2any=function(t,e){var n,i,s,r,a=e.length,u=[],c=Array(Math.ceil(t.length/2));for(n=0;c.length>n;n++)c[n]=t.charCodeAt(2*n)<<8|t.charCodeAt(2*n+1);for(;c.length>0;){for(r=[],s=0,n=0;c.length>n;n++)s=(s<<16)+c[n],i=Math.floor(s/a),s-=i*a,(r.length>0||i>0)&&(r[r.length]=i);u[u.length]=s,c=r}var o="";for(n=u.length-1;n>=0;n--)o+=e.charAt(u[n]);var l=Math.ceil(8*t.length/(Math.log(e.length)/Math.log(2)));for(n=o.length;l>n;n++)o=e[0]+o;return o},this.str2rstr_utf8=function(t){for(var e,n,i="",s=-1;++s<t.length;)e=t.charCodeAt(s),n=t.length>s+1?t.charCodeAt(s+1):0,e>=55296&&56319>=e&&n>=56320&&57343>=n&&(e=65536+((1023&e)<<10)+(1023&n),s++),127>=e?i+=String.fromCharCode(e):2047>=e?i+=String.fromCharCode(192|31&e>>>6,128|63&e):65535>=e?i+=String.fromCharCode(224|15&e>>>12,128|63&e>>>6,128|63&e):2097151>=e&&(i+=String.fromCharCode(240|7&e>>>18,128|63&e>>>12,128|63&e>>>6,128|63&e));return i},this.str2rstr_utf16le=function(t){for(var e="",n=0;t.length>n;n++)e+=String.fromCharCode(255&t.charCodeAt(n),255&t.charCodeAt(n)>>>8);return e},this.str2rstr_utf16be=function(t){for(var e="",n=0;t.length>n;n++)e+=String.fromCharCode(255&t.charCodeAt(n)>>>8,255&t.charCodeAt(n));return e},this.rstr2binb=function(t){var e=Array(t.length>>2),n=null;for(n=0;e.length>n;n++)e[n]=0;for(n=0;8*t.length>n;n+=8)e[n>>5]|=(255&t.charCodeAt(n/8))<<24-n%32;return e},this.binb2rstr=function(t){for(var e="",n=0;32*t.length>n;n+=8)e+=String.fromCharCode(255&t[n>>5]>>>24-n%32);return e},this.binb_sha1=function(t,e){t[e>>5]|=128<<24-e%32,t[(e+64>>9<<4)+15]=e;for(var n=Array(80),i=1732584193,s=-271733879,r=-1732584194,a=271733878,u=-1009589776,c=0;t.length>c;c+=16){for(var o=i,l=s,h=r,f=a,g=u,d=0;80>d;d++){n[d]=16>d?t[c+d]:this.bit_rol(n[d-3]^n[d-8]^n[d-14]^n[d-16],1);var S=this.safe_add(this.safe_add(this.bit_rol(i,5),this.sha1_ft(d,s,r,a)),this.safe_add(this.safe_add(u,n[d]),this.sha1_kt(d)));u=a,a=r,r=this.bit_rol(s,30),s=i,i=S}i=this.safe_add(i,o),s=this.safe_add(s,l),r=this.safe_add(r,h),a=this.safe_add(a,f),u=this.safe_add(u,g)}return Array(i,s,r,a,u)},this.sha1_ft=function(t,e,n,i){return 20>t?e&n|~e&i:40>t?e^n^i:60>t?e&n|e&i|n&i:e^n^i},this.sha1_kt=function(t){return 20>t?1518500249:40>t?1859775393:60>t?-1894007588:-899497514},this.safe_add=function(t,e){var n=(65535&t)+(65535&e),i=(t>>16)+(e>>16)+(n>>16);return i<<16|65535&n},this.bit_rol=function(t,e){return t<<e|t>>>32-e}},Scule.sha1=new Scule.global.classes.sha1,Scule.global.classes.md5=function(){this.md5cycle=function(t,e){var n=t[0],i=t[1],s=t[2],r=t[3];n=this.ff(n,i,s,r,e[0],7,-680876936),r=this.ff(r,n,i,s,e[1],12,-389564586),s=this.ff(s,r,n,i,e[2],17,606105819),i=this.ff(i,s,r,n,e[3],22,-1044525330),n=this.ff(n,i,s,r,e[4],7,-176418897),r=this.ff(r,n,i,s,e[5],12,1200080426),s=this.ff(s,r,n,i,e[6],17,-1473231341),i=this.ff(i,s,r,n,e[7],22,-45705983),n=this.ff(n,i,s,r,e[8],7,1770035416),r=this.ff(r,n,i,s,e[9],12,-1958414417),s=this.ff(s,r,n,i,e[10],17,-42063),i=this.ff(i,s,r,n,e[11],22,-1990404162),n=this.ff(n,i,s,r,e[12],7,1804603682),r=this.ff(r,n,i,s,e[13],12,-40341101),s=this.ff(s,r,n,i,e[14],17,-1502002290),i=this.ff(i,s,r,n,e[15],22,1236535329),n=this.gg(n,i,s,r,e[1],5,-165796510),r=this.gg(r,n,i,s,e[6],9,-1069501632),s=this.gg(s,r,n,i,e[11],14,643717713),i=this.gg(i,s,r,n,e[0],20,-373897302),n=this.gg(n,i,s,r,e[5],5,-701558691),r=this.gg(r,n,i,s,e[10],9,38016083),s=this.gg(s,r,n,i,e[15],14,-660478335),i=this.gg(i,s,r,n,e[4],20,-405537848),n=this.gg(n,i,s,r,e[9],5,568446438),r=this.gg(r,n,i,s,e[14],9,-1019803690),s=this.gg(s,r,n,i,e[3],14,-187363961),i=this.gg(i,s,r,n,e[8],20,1163531501),n=this.gg(n,i,s,r,e[13],5,-1444681467),r=this.gg(r,n,i,s,e[2],9,-51403784),s=this.gg(s,r,n,i,e[7],14,1735328473),i=this.gg(i,s,r,n,e[12],20,-1926607734),n=this.hh(n,i,s,r,e[5],4,-378558),r=this.hh(r,n,i,s,e[8],11,-2022574463),s=this.hh(s,r,n,i,e[11],16,1839030562),i=this.hh(i,s,r,n,e[14],23,-35309556),n=this.hh(n,i,s,r,e[1],4,-1530992060),r=this.hh(r,n,i,s,e[4],11,1272893353),s=this.hh(s,r,n,i,e[7],16,-155497632),i=this.hh(i,s,r,n,e[10],23,-1094730640),n=this.hh(n,i,s,r,e[13],4,681279174),r=this.hh(r,n,i,s,e[0],11,-358537222),s=this.hh(s,r,n,i,e[3],16,-722521979),i=this.hh(i,s,r,n,e[6],23,76029189),n=this.hh(n,i,s,r,e[9],4,-640364487),r=this.hh(r,n,i,s,e[12],11,-421815835),s=this.hh(s,r,n,i,e[15],16,530742520),i=this.hh(i,s,r,n,e[2],23,-995338651),n=this.ii(n,i,s,r,e[0],6,-198630844),r=this.ii(r,n,i,s,e[7],10,1126891415),s=this.ii(s,r,n,i,e[14],15,-1416354905),i=this.ii(i,s,r,n,e[5],21,-57434055),n=this.ii(n,i,s,r,e[12],6,1700485571),r=this.ii(r,n,i,s,e[3],10,-1894986606),s=this.ii(s,r,n,i,e[10],15,-1051523),i=this.ii(i,s,r,n,e[1],21,-2054922799),n=this.ii(n,i,s,r,e[8],6,1873313359),r=this.ii(r,n,i,s,e[15],10,-30611744),s=this.ii(s,r,n,i,e[6],15,-1560198380),i=this.ii(i,s,r,n,e[13],21,1309151649),n=this.ii(n,i,s,r,e[4],6,-145523070),r=this.ii(r,n,i,s,e[11],10,-1120210379),s=this.ii(s,r,n,i,e[2],15,718787259),i=this.ii(i,s,r,n,e[9],21,-343485551),t[0]=this.add32(n,t[0]),t[1]=this.add32(i,t[1]),t[2]=this.add32(s,t[2]),t[3]=this.add32(r,t[3])},this.cmn=function(t,e,n,i,s,r){return e=this.add32(this.add32(e,t),this.add32(i,r)),this.add32(e<<s|e>>>32-s,n)},this.ff=function(t,e,n,i,s,r,a){return this.cmn(e&n|~e&i,t,e,s,r,a)},this.gg=function(t,e,n,i,s,r,a){return this.cmn(e&i|n&~i,t,e,s,r,a)},this.hh=function(t,e,n,i,s,r,a){return this.cmn(e^n^i,t,e,s,r,a)},this.ii=function(t,e,n,i,s,r,a){return this.cmn(n^(e|~i),t,e,s,r,a)},this.md51=function(t){/[\x80-\xFF]/.test(t)&&(t=unescape(encodeURI(t)));var e,n=t.length,i=[1732584193,-271733879,-1732584194,271733878];for(e=64;t.length>=e;e+=64)this.md5cycle(i,this.md5blk(t.substring(e-64,e)));t=t.substring(e-64);var s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;t.length>e;e++)s[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(this.md5cycle(i,s),e=0;16>e;e++)s[e]=0;return s[14]=8*n,this.md5cycle(i,s),i},this.md5blk=function(t){var e,n=[];for(e=0;64>e;e+=4)n[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return n},this.hex_chr="0123456789abcdef".split(""),this.rhex=function(t){for(var e="",n=0;4>n;n++)e+=this.hex_chr[15&t>>8*n+4]+this.hex_chr[15&t>>8*n];return e},this.hex=function(t){for(var e=0;t.length>e;e++)t[e]=this.rhex(t[e]);return t.join("")},this.hash=function(t){return this.hex(this.md51(t))},this.add32=function(t,e){return 4294967295&t+e}},Scule.md5=new Scule.global.classes.md5}}(),function(){Scule.global.functions.hasOwnProperty=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},Scule.global.functions.extractTrueValues=function(t){var e={};for(var n in t)if(Scule.global.functions.hasOwnProperty(t,n)){if(n.match(/^\$/))continue;t[n]&&(e[n]=!0)}return e},Scule.global.functions.pushIfNotNull=function(t,e){e&&t.push(e)},Scule.global.functions.pushIfExists=function(t,e,n){n in e&&t.push(e[n])},Scule.global.functions.getObjectAttribute=function(t,e,n){return e in t?t[e]:n},Scule.global.functions.getObjectId=function(t,e){return void 0===e&&(e=!1),e?""+t[Scule.global.constants.ID_FIELD]:t[Scule.global.constants.ID_FIELD]},Scule.global.functions.cloneObject=function(t){var e={};Scule.global.functions.isArray(t)&&(e=[]);for(var n in t)e[n]="object"==typeof t[n]?t[n]instanceof RegExp?RegExp(""+t[n]):Scule.global.functions.cloneObject(t[n]):t[n];return e},Scule.global.functions.traverseObject=function(t,e){var n=0,i=null,s=function(t){for(var e in t)if(Scule.global.functions.hasOwnProperty(t,e)){if(t[e]===!0){i=e;break}n++,s(t[e])}};s(t);var r=0,a=function(t,e){if(r==n)return e;for(var i in t)if(Scule.global.functions.hasOwnProperty(t,i))return Scule.global.functions.hasOwnProperty(e,i)?t[i]===!0?e:(r++,a(t[i],e[i])):null};return[i,a(t,e)]},Scule.global.functions.sortObjectKeys=function(t){var e={},n=[];for(var i in t)Scule.global.functions.hasOwnProperty(t,i)&&n.push(i);return n.sort(function(t,e){var n=!1;t.match(/^\$/)&&(t=t.substr(1),n=!0);var i=!1;return e.match(/^\$/)&&(e=e.substr(1),i=!0),n&&!i?1:i&&!n?-1:e>t?-1:t>e?1:0}),n.forEach(function(n){e[n]=t[n]}),e},Scule.global.functions.objectValues=function(t){var e=[];for(var n in t)Scule.global.functions.hasOwnProperty(t,n)&&e.push(t[n]);return e},Scule.global.functions.objectKeys=function(t){var e=[];for(var n in t)Scule.global.functions.hasOwnProperty(t,n)&&e.push(n);return e},Scule.global.functions.sizeOf=function(t){if(t instanceof Array||"string"==typeof t)return t.length;var e,n=0;for(e in t)Scule.global.functions.hasOwnProperty(t,e)&&n++;return n},Scule.global.functions.shuffle=function(t){var e,n,i=t.length;if(i)for(;--i;)n=Math.floor(Math.random()*(i+1)),e=t[n],t[n]=t[i],t[i]=e},Scule.global.functions.unique=function(t){for(var e={},n=0;t.length>n;n++)e[t[n]]=!0;var i=[];for(var s in e)e.hasOwnProperty(s)&&i.push(s);return i},Scule.global.functions.contains=function(t,e){return Scule.global.functions.hasOwnProperty(t,e)},Scule.global.functions.stringify=function(t){var e={};for(var n in t)e[n]="function"==typeof t[n]?""+t[n]:t[n];return JSON.stringify(e)},Scule.global.functions.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},Scule.global.functions.isInteger=function(t){return parseInt(t,10)==t},Scule.global.functions.isDouble=function(t){return parseFloat(t)==t},Scule.global.functions.isScalar=function(t){return null!==t&&!(t instanceof Object)},Scule.global.functions.randomFromTo=function(t,e){return Math.floor(Math.random()*(e-t+1)+t)},Scule.global.functions.compare=function(t,e){return t===e?0:t>e?1:-1},Scule.global.functions.compareElementKey=function(t,e){return Scule.global.functions.compare(t.key,e.key)},Scule.global.functions.compareElementValue=function(t,e){return Scule.global.functions.compare(t.value,e.value)},Scule.global.functions.compareArray=function(t,e){if(!Scule.global.functions.isArray(t)&&Scule.global.functions.isArray(e))return 1;if(Scule.global.functions.isArray(t)&&!Scule.global.functions.isArray(e))return-1;if(t.length>e.length)return 1;if(e.length>t.length)return-1;for(var n=!0,i=0,s=t.length,r=0;s>r;r++)i+=Scule.global.functions.isArray(t[r])?Scule.global.functions.compareArray(t[r],e[r]):Scule.global.functions.compare(t[r],e[r]),0!==i&&(n=!1);return 0!==i||n||(i=JSON.stringify(t[0]).localeCompare(JSON.stringify(e[0]))),i>0?i=1:0>i&&(i=-1),i},Scule.global.functions.sort=function(t,e,n){switch(t){case-1:e.sort(function(t,e){return e[n]-t[n]});break;case 0:Scule.global.functions.shuffle(e);break;case 1:e.sort(function(t,e){return t[n]-e[n]});break;case 2:e.sort(function(t,e){return e[n]>t[n]?-1:e[n]<t[n]?1:0});break;case 3:e.reverse()}},Scule.global.functions.trim=function(t){return String.prototype.trim?t.trim():t.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},Scule.global.functions.getMACAddress=function(){return Scule.global.variables.hasOwnProperty("SimulatedMacAddress")||(Scule.global.variables.SimulatedMacAddress=(""+(new Date).getTime()).substring(9,11)+""+Scule.global.functions.randomFromTo(100,999)),Scule.global.variables.SimulatedMacAddress},Scule.global.functions.parseAttributes=function(t){if(!Scule.global.functions.isArray(t))return Scule.global.functions.parseAttributes(t.split(","));var e=function(t,n,i){var s=Scule.global.functions.trim(n[i]);if(i==n.length-1)t[s]=!0;else{var r={};t[s]=r,e(r,n,i+1)}},n={};return t.forEach(function(t){e(n,t.split("."),0)}),n},Scule.global.functions.searchObject=function(t,e){var n=function(t,e,i){if(e)for(var s in t)t[s]===!0?Scule.global.functions.isInteger(s)&&Scule.global.functions.isArray(e)?i.push(e[s]):s in e&&i.push(e[s]):s in e&&!Scule.global.functions.isScalar(e[s])&&n(t[s],e[s],i)},i=[];return n(t,e,i),i},Scule.global.functions.traverse=function(t,e){var n=function(t,e){if(void 0===e)return void 0;if(1===t.length)return e[t.pop()];var i=t.shift();return n(t,e[i])};return n(t.split("."),e)}}(),function(){Scule.events.classes.Event=function(t,e){this.name=t,this.body=e,this.getName=function(){return this.name},this.getBody=function(){return this.body}},Scule.events.classes.EventEmitter=function(){this.listeners=Scule.getHashTable(),this.createBucket=function(t){this.listeners.contains(t)||this.listeners.put(t,[])},this.addEventListener=function(t,e){e instanceof Scule.events.classes.EventListener||(e=new Scule.events.classes.EventListener(e)),this.createBucket(t);var n=this.listeners.get(t);n.push(e)},this.removeEventListener=function(t,e){this.createBucket(t),e instanceof Scule.events.classes.EventListener&&(e=e.getClosure());for(var n=this.listeners.get(t),i=[],s=0;n.length>s;s++)n[s].getClosure()!=e&&i.push(e);this.listeners.put(t,i)},this.removeEventListeners=function(t){this.listeners.remove(t)},this.fireEvent=function(t,e){this.createBucket(t),e instanceof Scule.events.classes.Event||(e=new Scule.events.classes.Event(t,e));var n=this.listeners.get(t);n.forEach(function(t){t.consume(e)})}},Scule.events.classes.EventListener=function(t){this.closure=t,this.consume=function(t){this.closure(t)},this.getClosure=function(){return this.closure}},Scule.getEventListener=function(t){return new Scule.events.classes.EventListener(t)},Scule.getEventEmitter=function(){return new Scule.events.classes.EventEmitter},Scule.getEvent=function(t,e){return new Scule.events.classes.Event(t,e)}}(),function(){Scule.messaging.classes.Message=function(t,e){this.key=t,this.body=e,this.getKey=function(){return this.key},this.getBody=function(){return this.body}},Scule.messaging.classes.MessageQueue=function(t){this.name=t,this.subscribers=[],Scule.datastructures.classes.Queue.call(this),this.getName=function(){return this.name},this.addSubscriber=function(t){this.subscribers.push(t)},this.getSubscribers=function(){return this.subscribers},this.removeSubscribers=function(){this.subscribers=[]}},Scule.messaging.classes.MessageExchange=function(t){this.name=t,this.queues=Scule.getHashTable(),this.getName=function(){return this.name},this.addQueue=function(e,n){if(!(e instanceof Scule.messaging.classes.MessageQueue))throw"provided object is not a messge queue";if(this.queues.contains(e.getName()))throw"exchange "+t+" is already bound to queue "+e.getName();return this.queues.put(e.getName(),e),this.addRoute(e,n),!0},this.addRoute=function(){return!0},this.removeQueue=function(t){return this.queues.contains(t.getName())?(this.queues.remove(t.getName()),this.removeRoute(t),!0):!1},this.removeRoute=function(){return!0},this.route=function(){throw"routing is not supported in abstract exchange class"}},Scule.messaging.classes.FanOutMessageExchange=function(t){Scule.messaging.classes.MessageExchange.call(this,t),this.route=function(t){var e=this,n=this.queues.getKeys();n.forEach(function(n){e.queues.get(n).enqueue(t)})}},Scule.messaging.classes.DirectMessageExchange=function(t){this.routes=Scule.getHashTable(),Scule.messaging.classes.MessageExchange.call(this,t),this.addRoute=function(t,e){var n=Scule.md5.hash(""+e);this.routes.contains(n)||this.routes.put(n,{key:e,queues:[]}),this.routes.get(n).queues.push(t)},this.removeRoute=function(t){var e=this,n=this.routes.getKeys();n.forEach(function(n){for(var i=e.routes.get(n),s=i.queues.length;s--;)i.queues[s]==t&&i.queues.splice(s,1)})},this.route=function(t){var e=this,n=this.routes.getKeys();n.forEach(function(n){var i=e.routes.get(n);if(t.getKey().match(i.key))for(var s=0;i.queues.length>s;s++)i.queues[s].enqueue(t)})}},Scule.messaging.classes.MessageChannel=function(){this.bindings=Scule.getHashTable(),this.bind=function(t,e,n){var i=t.getName()+","+e.getName();if(this.bindings.contains(i))throw"binding for "+i+" already exists";this.bindings.put(i,{exchange:t,queue:e}),t.addQueue(e,n)},this.unbind=function(t,e){var n=t.getName()+","+e.getName();if(!this.bindings.contains(n))throw"binding for "+n+" does not exist";var i=this.bindings.get(n);this.bindings.remove(n),i.exchange.removeQueue(i.queue)}},Scule.messaging.classes.MessageSubscriber=function(t,e){this.queue=t,this.callback=e,this.interval=null,this.start=function(){var t=this;this.interval=setInterval(function(){var e=t.queue.dequeue();e&&t.callback(e)},10+Scule.global.functions.randomFromTo(3,8))},this.stop=function(){clearInterval(this.interval)}},Scule.messaging.classes.MessagingDirector=function(){this.queues=Scule.getHashTable(),this.exchanges=Scule.getHashTable(),this.channel=new Scule.messaging.classes.MessageChannel,this.bind=function(t,e,n){void 0!==n?this.bindDirect(t,e,n):this.bindFanOut(t,e)},this.bindDirect=function(t,e,n){var i=null,s=null;if(this.exchanges.contains(t)){if(i=this.exchanges.get(t),!(i instanceof Scule.messaging.classes.DirectMessageExchange))throw"unable to bind directly to a fan-out exchange"}else i=new Scule.messaging.classes.DirectMessageExchange(t),this.exchanges.put(t,i);this.queues.contains(e)?s=this.queues.get(e):(s=new Scule.messaging.classes.MessageQueue(e),this.queues.put(e,s)),this.channel.bind(i,s,n)},this.bindFanOut=function(t,e){var n=null,i=null;if(this.exchanges.contains(t)){if(n=this.exchanges.get(t),!(n instanceof Scule.messaging.classes.FanOutMessageExchange))throw"unable to bind to direct exchange without a routing key"}else n=new Scule.messaging.classes.FanOutMessageExchange(t),this.exchanges.put(t,n);this.queues.contains(e)?i=this.queues.get(e):(i=new Scule.messaging.classes.MessageQueue(e),this.queues.put(e,i)),this.channel.bind(n,i)},this.publish=function(t,e,n){var i=new Scule.messaging.classes.Message(e,n);if(!this.exchanges.contains(t))throw"exchange "+t+" does not exist";var s=this.exchanges.get(t);s.route(i)},this.subscribe=function(t,e){if(!this.queues.contains(t))throw"queue "+t+" does not exist";var n=this.queues.get(t),i=new Scule.messaging.classes.MessageSubscriber(n,e);n.addSubscriber(i),i.start()},this.unsubscribeAll=function(t){if(void 0===t)throw"queue name is required";if(!this.queues.contains(t))throw"queue "+t+" does not exist";var e=this.queues.get(t),n=e.getSubscribers();n.forEach(function(t){t.stop()}),e.subscribers=[]}},Scule.getMessage=function(t,e){return new Scule.messaging.classes.Message(t,e)},Scule.getMessageQueue=function(t){return new Scule.messaging.classes.MessageQueue(t)},Scule.getMessageExchange=function(t){return new Scule.messaging.classes.MessageExchange(t)},Scule.getFanOutMessageExchange=function(t){return new Scule.messaging.classes.FanOutMessageExchange(t)},Scule.getDirectMessageExchange=function(t,e){return new Scule.messaging.classes.DirectMessageExchange(t,e)},Scule.getMessageChannel=function(){return new Scule.messaging.classes.MessageChannel},Scule.getMessagingDirector=function(){return new Scule.messaging.classes.MessagingDirector}}(),function(){Scule.datastructures.variables.fnv_hash=function(t,e){for(var n=2166136261,i=16777619,s=t.length,r=0;s>r;r++)n=(n^t.charCodeAt(r))*i;return n+=n<<13,n^=n>>7,n+=n<<3,n^=n>>17,n+=n<<5,0>n&&(n=-1*n),n%e},Scule.datastructures.variables.djb2_hash=function(t,e){var n=5381,i=t.length,s=0;for(s=0;i>s;s++)n=(n<<5)+n+t.charCodeAt(s);return 0>n&&(n=-1*n),n%e},Scule.datastructures.variables.joaat_hash=function(t,e){var n=0,i=t.length,s=0;for(s=0;i>s;s++)n+=t.charCodeAt(s),n+=n<<10,n^=n>>6;return n+=n<<3,n^=n>>11,n+=n<<15,0>n&&(n=-1*n),n%e},Scule.datastructures.variables.elf_hash=function(t,e){for(var n,i=0,s=0;t.length>s;s++)i=(i<<4)+t.charCodeAt(s),(n=4026531840&i)&&(i^=n>>24),i&=~n;return i%e},Scule.datastructures.classes.LinkedList=function(){this.head=null,this.tail=null,this.length=0,this.getHead=function(){return this.head},this.getTail=function(){return this.tail},this.getLength=function(){return this.length},this.isEmpty=function(){return 0===this.length},this.clear=function(){this.head=null,this.tail=null,this.length=0},this.get=function(t){if(0>t||t>this.length)return null;if(0===t)return this.head;for(var e=this.head,n=0;e&&t!=n;)n++,e=e.next;return e},this.add=function(t){var e=new Scule.datastructures.classes.LinkedListNode(null,t);if(null===this.head)this.head=e;else if(null===this.tail)this.head.next=e,this.tail=e;else{var n=this.tail;n.next=e,this.tail=n.next}return this.length++,e},this.search=function(t,e,n){n||(n=Scule.global.functions.compare);for(var i=this.head;i;){if(e){if(0===n(i.element[e],t))break}else if(0===n(i.element,t))break;i=i.next}return i},this.contains=function(t,e){if(null===t)return!1;e||(e=Scule.global.functions.compare);for(var n=this.head;n&&0!==e(n.element,t);)n=n.next;return null!==n},this.split=function(t){var e;if(void 0===t){if(t=Math.floor(this.length/2),e=this.middle(),!e)return null}else{if(1>t||t>this.length)return null;e=this.get(t-1)}var n=new Scule.datastructures.classes.LinkedList;return n.head=e.next,e.next=null,n.tail=this.tail,this.tail=e,n.length=t,this.length=this.length-t,n},this.middle=function(){if(!this.head)return null;for(var t=this.head,e=this.head;e.next&&e.next.next;)t=t.next,e=e.next.next;return t},this.remove=function(t){if(0>t||t>this.length)return null;var e;if(1===this.length)e=this.head,this.clear();else{var n=this.get(t-1);n.next==this.tail?(e=this.tail,this.tail=n):(e=n.next,n.next=n.next.next),this.length--}return e},this.reverse=function(){for(var t=null,e=this.head,n=null;e;)n=e.next,e.next=t,t=e,e=n;n=this.head,this.head=this.tail,this.tail=n},this.toArray=function(){for(var t=[],e=this.head;e;)t.push(e.element),e=e.next;return t},this.forEach=function(t){for(var e=this.head;e;)t(e),e=e.next;return!0},this.sort=function(t,e){if(2>this.length)return this;t||(t=Scule.global.functions.compare);var n=function(t){if(!t)return t;for(var e=t,n=t;n.next&&n.next.next;)e=e.next,n=n.next.next;return e},i=function(n,i){for(var s,r,a={next:null},u=a;n&&i;)e?(s=i.element[e],r=n.element[e]):(s=i.element,r=n.element),t(s,r)>-1?(u.next=n,n=n.next):(u.next=i,i=i.next),u=u.next;return u.next=n?n:i,a.next},s=function(t){if(!t||!t.next)return t;var e=n(t),r=e.next;return e.next=null,i(s(t),s(r))};this.head=s(this.head)}},Scule.datastructures.classes.DoublyLinkedList=function(){this.head=null,this.tail=null,this.length=0,this.getHead=function(){return this.head},this.getTail=function(){return this.tail},this.isEmpty=function(){return 0===this.length},this.getLength=function(){return this.length},this.search=function(t,e,n){n||(n=Scule.global.functions.compare);for(var i=this.head;i;){if(e){if(0===n(i.element[e],t))break}else if(0===n(i.element,t))break;i=i.next}return i},this.contains=function(t,e){if(null===t)return!1;e||(e=Scule.global.functions.compare);for(var n=this.head;n&&0!==e(n.element,t);)n=n.next;return null!==n},this.get=function(t){if(0>t||t>this.length)return null;if(0===t)return this.head;for(var e=this.head,n=0;e&&t!=n;)n++,e=e.next;return e},this.add=function(t){var e=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,t);if(this.isEmpty())this.head=e;else if(this.tail){var n=this.tail;n.next=e,e.prev=n,this.tail=e}else this.tail=e,this.tail.prev=this.head,this.head.next=e;return this.length++,e},this.remove=function(t){if(0>t||t>this.length)return null;var e;if(1===this.length)e=this.head,this.clear();else{var n=this.get(t-1);n.next==this.tail?(e=this.tail,this.tail=n,this.tail.prev=e.prev,this.tail.next=null):(e=n.next,n.next=n.next.next,n.next&&(n.next.prev=n)),this.length--}return e&&e.detach(),e},this.trim=function(){return this.isEmpty()?null:this.remove(this.length-1)},this.split=function(t){var e;if(void 0===t){if(t=Math.floor(this.length/2),e=this.middle(),!e)return null}else{if(1>t||t>this.length)return null;e=this.get(t-1)}var n=new Scule.datastructures.classes.DoublyLinkedList;return n.head=e.next,e.next=null,e.prev=null,n.tail=this.tail,this.tail=e,n.length=t,this.length=this.length-t,n},this.middle=function(){if(!this.head)return null;for(var t=this.head,e=this.head;e.next&&e.next.next;)t=t.next,e=e.next.next;return t},this.sort=function(t,e){if(2>this.length)return this;t||(t=Scule.global.functions.compare);var n=function(t){if(!t)return t;for(var e=t,n=t;n.next&&n.next.next;)e=e.next,n=n.next.next;return e},i=function(n,i){for(var s,r,a={next:null},u=a;n&&i;)e?(s=i.element[e],r=n.element[e]):(s=i.element,r=n.element),t(s,r)>-1?(u.next=n,u.prev=i,n=n.next):(u.next=i,u.prev=n,i=i.next),u=u.next;return u.next=n?n:i,a.next},s=function(t){if(!t||!t.next)return t;var e=n(t),r=e.next;return e.next=null,r.prev=null,i(s(t),s(r))};this.head=s(this.head)},this.reverse=function(){for(var t=this.head,e=null;t;)e=t.next,t.next=t.prev,t.prev=e,t=e;e=this.head,this.head=this.tail,this.tail=e},this.prepend=function(t){var e=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,t);if(this.isEmpty())this.head=e;else{var n=this.head;this.head=e,n.prev=this.head,this.head.next=n,this.tail||(this.tail=n)}return this.length++,e},this.clear=function(){this.head=null,this.tail=null,this.length=0},this.toArray=function(){for(var t=[],e=this.head;e;)t.push(e.element),e=e.next;return t},this.forEach=function(t){for(var e=this.head;e;)t(e),e=e.next;return!0}},Scule.datastructures.classes.CachingLinkedList=function(t,e,n){if(!e)throw"A valid cache key is required to use a CachingLinkedList";t||(t=100),this.cacheKey=e,this.threshold=t,this.cache=new Scule.datastructures.classes.LRUCache(t),n||(n=new Scule.datastructures.classes.LinkedList),this.list=n,this.clear=function(){this.cache.clear(),this.list.clear()},this.remove=function(t){var e=this.list.remove(t);return e&&this.cache.remove(e.element[this.cacheKey]),e},this.middle=function(){return this.list.middle()},this.split=function(){return this.cache.clear(),this.list.split()},this.add=function(t){var e=this.list.add(t);return this.cache.put(e.element[this.cacheKey],e),e},this.search=function(t){if(this.cache.contains(t))return this.cache.get(t);var e=this.list.search(t,this.cacheKey);return e&&this.cache.put(e.element[this.cacheKey],e),e},this.getLength=function(){return this.list.getLength()},this.getTail=function(){return this.list.getTail()},this.getHead=function(){return this.list.getHead()},this.isEmpty=function(){return this.list.isEmpty()},this.get=function(t){return this.list.get(t)},this.contains=function(t){return this.list.contains(t)},this.reverse=function(){this.list.reverse()},this.sort=function(t){this.list.sort(t,this.cacheKey)},this.toArray=function(){return this.list.toArray()},this.forEach=function(t){return this.list.forEach(t)}},Scule.datastructures.classes.LinkedListNode=function(t,e){this.next=t,this.element=e,this.getNext=function(){return this.next},this.setNext=function(t){this.next=t},this.getElement=function(){return this.element},this.setElement=function(t){this.element=t}},Scule.datastructures.classes.DoublyLinkedListNode=function(t,e,n){Scule.datastructures.classes.LinkedListNode.call(this,e,n),this.prev=t,this.getPrev=function(){return this.prev},this.setPrev=function(t){this.prev=t},this.detach=function(){this.prev=null,this.next=null}},Scule.datastructures.classes.LRUCache=function(t){this.threshold=t,this.cache=new Scule.datastructures.classes.HashTable,this.queue=new Scule.datastructures.classes.DoublyLinkedList,this.contains=function(t){return this.cache.contains(t)},this.remove=function(t){if(!this.cache.contains(t))return null;var e=this.cache.get(t);this.cache.remove(t);var n=e.node.prev,i=e.node.next;return n&&(n.next=i),i&&(i.prev=n),e.node.detach(),this.queue.length--,!0},this.get=function(t){if(!this.cache.contains(t))return null;var e=this.cache.get(t);return e.requeue(this.queue),e.value},this.put=function(t,e){var n;if(this.cache.contains(t)?(n=this.cache.get(t),n.value=e,n.node.element={key:t,value:e},n.requeue(this.queue)):(n=new Scule.datastructures.classes.LRUCacheEntry(t,e,this.queue.prepend({key:t,value:e})),this.cache.put(t,n)),this.queue.length>this.threshold){var i=this.queue.trim();if(!this.cache.remove(i.getElement().key))throw"LRU cache is corrupt";i=null}return!0},this.getLength=function(){return this.cache.getLength()},this.clear=function(){this.cache.clear(),this.queue.clear()}},Scule.datastructures.classes.LRUCacheEntry=function(t,e,n){this.key=t,this.value=e,this.node=n,this.getKey=function(){return this.key},this.getValue=function(){return this.value},this.getNode=function(){return this.node},this.requeue=function(t){if(this.node.prev){var e=this.node.prev,n=this.node.next;e.next=n,n&&(n.prev=e),this.node.detach(),t.length--,this.node=t.prepend({key:this.key,value:this.value})}}},Scule.datastructures.classes.LIFOStack=function(){Scule.datastructures.classes.LinkedList.call(this),this.push=function(t){var e=this.head;this.head=new Scule.datastructures.classes.LinkedListNode(e,t),this.length++},this.pop=function(){if(this.isEmpty())return null;var t=this.head;return this.head=t.next,this.length--,t.next=null,t.getElement()},this.peek=function(){return this.isEmpty()?null:this.head.getElement()}},Scule.datastructures.classes.FIFOStack=function(){Scule.datastructures.classes.LIFOStack.call(this),this.push=this.add,this.pop=function(){if(this.isEmpty())return null;
var t=this.head;return this.head=t.next,this.length--,t.getElement()}},Scule.datastructures.classes.Queue=function(){Scule.datastructures.classes.FIFOStack.call(this),this.enqueue=this.push,this.dequeue=this.pop},Scule.datastructures.classes.HashMap=function(t){this.size=t,this.buckets=0,this.length=0,this.table=[],this.hash=Scule.datastructures.variables.djb2_hash,this.retable=function(){var t=this.length/this.size;if(!(this.length>=this.buckets&&.7>t)){var e=this.toArray();this.clear(),this.size=2*this.size;for(var n=0;e.length>n;n++)this.put(e[n][0],e[n][1])}},this.bucket=function(t){return this.table[t]||(this.buckets++,this.table[t]=new Scule.datastructures.classes.BinarySearchTree),this.table[t]},this.put=function(t,e){var n=this.hash(t,this.size),i=this.bucket(n),s=i.insert(t,e);return s&&(this.length++,0===i.getLength()%10&&i.balance()),this.retable(),s},this.contains=function(t){var e=this.hash(t,this.size),n=this.bucket(e);return null!==n.search(t)},this.get=function(t){var e=this.hash(t,this.size),n=this.bucket(e),i=n.search(t);return null===i?null:i.getData()},this.search=function(t){return this.get(t)},this.remove=function(t){var e=this.hash(t,this.size),n=this.bucket(e);return n.remove(t)?(this.length--,this.retable(),!0):!1},this.clear=function(){this.table=[],this.length=0,this.buckets=0},this.getLength=function(){return this.length},this.getKeys=function(){var t=[],e=function(n){null!==n&&(t.push(n.getKey()),e(n.getLeft()),e(n.getRight()))};return this.table.forEach(function(t){t&&e(t.getRoot())}),t},this.getValues=function(){var t=[],e=function(n){null!==n&&(t.push(n.getData()),e(n.getLeft()),e(n.getRight()))};return this.table.forEach(function(t){t&&e(t.getRoot())}),t},this.toArray=function(){var t=[];return this.table.forEach(function(e){e&&(t=t.concat(e.toArray()))}),t}},Scule.datastructures.classes.HashTable=function(){this.table={},this.length=0,this.put=function(t,e){this.contains(t)||this.length++,this.table[t]=e},this.get=function(t){return this.contains(t)?this.table[t]:null},this.search=function(t){return this.get(t)},this.remove=function(t){if(this.contains(t)){var e=this.table[t];return delete this.table[t],this.length--,e}return!1},this.contains=function(t){return Scule.global.functions.hasOwnProperty(this.table,t)},this.clear=function(){this.table={},this.length=0},this.getLength=function(){return this.length},this.getKeys=function(){var t=[];for(var e in this.table)this.contains(e)&&t.push(e);return t},this.getValues=function(){var t=[];for(var e in this.table)this.contains(e)&&t.push(this.table[e]);return t},this.toArray=function(){var t=[];for(var e in this.table)this.contains(e)&&(t[e]=this.table[e]);return t}},Scule.datastructures.classes.BinarySearchTreeNode=function(t,e){this.parent=null,this.left=null,this.right=null,this.key=t,this.data=e,this.setParent=function(t){this.parent=t},this.getParent=function(){return this.parent},this.setLeft=function(t){t&&(this.left=t,this.left.setParent(this))},this.getLeft=function(){return this.left},this.setRight=function(t){t&&(this.right=t,this.right.setParent(this))},this.getRight=function(){return this.right},this.getKey=function(){return this.key},this.setData=function(t){this.data=t},this.getData=function(){return this.data},this.clear=function(){this.data=null},this.remove=function(t){return t?t==this.right?(this.setRight(t.getRight()),this.getRight().setLeft(t.getLeft()),t.parent=null,t.left=null,t.right=null,!0):t==this.left?(this.setLeft(t.getRight()),this.getLeft().setLeft(t.getLeft()),t.parent=null,t.left=null,t.right=null,!0):!1:!1}},Scule.datastructures.classes.AtomicCounter=function(t){if(void 0===t&&(t=0),!Scule.global.functions.isInteger(t))throw"Unable to initialize counter with non-integer value";this.count=t,this.increment=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to increment counter with non-integer value";return this.count+=t,this.count},this.decrement=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to decrement counter with non-integer value";return this.count-=t,this.count},this.getCount=function(){return this.count}},Scule.datastructures.classes.BinarySearchTree=function(){this.root=null,this.length=0,this.insert=function(t,e){var n=this,i=new Scule.datastructures.classes.BinarySearchTreeNode(t,e);if(null===this.root)return this.length++,this.root=i,!0;var s=function(t,e){return t.getKey()==e.getKey()?(e.setData(t.getData()),!1):(t.getKey()<=e.getKey()?e.getLeft()?s(t,e.getLeft()):(n.length++,e.setLeft(t)):e.getRight()?s(t,e.getRight()):(n.length++,e.setRight(t)),!0)};return s(i,this.root)},this.search=function(t){var e=function(t,n){return n?n.getKey()==t?n:n.getKey()>t?e(t,n.getLeft()):e(t,n.getRight()):null};return e(t,this.root)},this.remove=function(t){var e=this.search(t);if(!e)return!1;if(!e.getParent())return e.getRight()?(this.root=e.getRight(),this.root.setLeft(e.getLeft())):e.getLeft()?(this.root=e.getRight(),this.root.setLeft(e.getLeft())):this.root=null,this.length--,!0;var n=e.getParent().remove(e);return n&&this.length--,n},this.balance=function(){var t=this,e=this.toArray(),n=function(e){var i=e,s=e.splice(Math.ceil(e.length/2),e.length),r=i.pop();t.insert(r[0],r[1]),i.length>0&&n(i),s.length>0&&n(s)};this.length=0,this.root=null,n(e)},this.getLength=function(){return this.length},this.toArray=function(){var t=function(e){return e?t(e.getLeft()).concat([[e.getKey(),e.getData()]]).concat(t(e.getRight())):[]};return t(this.root)},this.getRoot=function(){return this.root}},Scule.datastructures.classes.BitSet=function(t){if(void 0===t||!Scule.global.functions.isInteger(t)||0>=t)throw"Unable to initialize bitset with non-integer capacity";this.capacity=t,this.words=null,this.zeroFill=function(){this.words=[];for(var t=Math.ceil(this.capacity/32),e=0;t>=e;e++)this.words[e]=0},this.indexToAddress=function(t){if(0>t||t>=this.capacity)throw"Index out of bounds";if(32>t)return{addr:0,offs:t};var e=Math.floor(t/32),n=t%32;return{addr:e,offs:n}},this.get=function(t){var e=this.indexToAddress(t);return 0!=(this.words[e.addr]&1<<e.offs)},this.set=function(t){var e=this.indexToAddress(t);this.words[e.addr]|=1<<e.offs},this.clear=function(t){var e=this.indexToAddress(t);this.words[e.addr]&=~(1<<e.offs)},this.getLength=function(){return this.capacity},this.toString=function(){for(var t="",e=0;this.capacity>e;e++)t+=this.get(e)?1:0;return t},this.zeroFill()},Scule.datastructures.classes.BloomFilter=function(t,e){if(void 0===t||!Scule.global.functions.isInteger(t)||0>=t)throw"Unable to initialize bloom filter with non-integer m";(void 0===e||!Scule.global.functions.isInteger(e)||0>=e)&&(e=Math.floor(t/Math.ceil(t/3))),Scule.datastructures.classes.BitSet.call(this,t),this.k=e,this.f=[];for(var n=0;this.k>n;n++)this.f.push([Scule.global.functions.randomFromTo(0,999999),Scule.global.functions.randomFromTo(0,999999)]);this.hash=function(t,e,n){return Scule.datastructures.variables.fnv_hash(this.f[t][0]+e+this.f[t][1],n)},this.add=function(t){for(var e=0;this.k>e;e++)this.set(this.hash(e,t,this.capacity))},this.query=function(t){for(var e=0;this.k>e;e++)if(!this.get(this.hash(e,t,this.capacity)))return!1;return!0}},Scule.datastructures.classes.AtomicCounter=function(t){if(void 0===t&&(t=0),!Scule.global.functions.isInteger(t))throw"Unable to initialize counter with non-integer value";this.count=t,this.increment=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to increment counter with non-integer value";return this.count+=t,this.count},this.decrement=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to decrement counter with non-integer value";return this.count-=t,this.count},this.getCount=function(){return this.count}},Scule.getLinkedList=function(){return new Scule.datastructures.classes.LinkedList},Scule.getCachingLinkedList=function(t,e){return new Scule.datastructures.classes.CachingLinkedList(t,e)},Scule.getDoublyLinkedList=function(){return new Scule.datastructures.classes.DoublyLinkedList},Scule.getHashTable=function(){return new Scule.datastructures.classes.HashTable},Scule.getPrimaryKeyIndex=function(){return new Scule.db.classes.PrimaryKeyIndex},Scule.getHashMap=function(t){return new Scule.datastructures.classes.HashMap(t)},Scule.getLIFOStack=function(){return new Scule.datastructures.classes.LIFOStack},Scule.getFIFOStack=function(){return new Scule.datastructures.classes.FIFOStack},Scule.getQueue=function(){return new Scule.datastructures.classes.Queue},Scule.getLRUCache=function(t){return new Scule.datastructures.classes.LRUCache(t)},Scule.getBinarySearchTreeNode=function(t,e){return new Scule.datastructures.classes.BinarySearchTreeNode(t,e)},Scule.getBinarySearchTree=function(){return new Scule.datastructures.classes.BinarySearchTree},Scule.getAtomicCounter=function(t){return new Scule.datastructures.classes.AtomicCounter(t)},Scule.getBitSet=function(t){return new Scule.datastructures.classes.BitSet(t)},Scule.getBloomFilter=function(t){return new Scule.datastructures.classes.BloomFilter(t)}}(),function(){Scule.instrumentation.classes.Timer=function(){this.intervalCounter=0,this.intervalArray=[],this.intervals=Scule.getLIFOStack(),this.resetTimer=function(){this.intervalCounter=0,this.intervalArray=[],this.intervals.clear()},this.startInterval=function(t){this.intervalCounter++,void 0===t&&(t=this.intervalCounter),this.intervals.push(new Scule.instrumentation.classes.TimerInterval(t)),this.intervalArray.push(this.intervals.peek())},this.stopInterval=function(){return this.intervals.isEmpty()?!1:(this.intervals.peek().stop(),this.intervals.pop())},this.stopAllIntervals=function(){for(;!this.intervals.isEmpty();)this.intervals.pop().stop()},this.logToConsole=function(){this.intervalArray.forEach(function(t){t.logToConsole()})}},Scule.instrumentation.classes.TimerInterval=function(t){this.startTimestamp=(new Date).getTime(),this.endTimestamp=null,this.tag=t,this.stopped=function(){return null!==this.endTimestamp},this.stop=function(){this.endTimestamp=(new Date).getTime()},this.getDifference=function(){return null===this.endTimestamp?!1:this.endTimestamp-this.startTimestamp},this.logToConsole=function(){var t=this.getDifference();t===!1&&console.log("interval "+this.tag+" is still in progress"),console.log("interval "+this.tag+" lasted "+t+"ms")}},Scule.getTimer=function(){return new Scule.instrumentation.classes.Timer}}(),function(){Scule.interpreter.symbols.table={$and:Scule.interpreter.arities.selective,$or:Scule.interpreter.arities.selective,$nor:Scule.interpreter.arities.negative,$not:Scule.interpreter.arities.negative,$lt:Scule.interpreter.arities.range,$lte:Scule.interpreter.arities.range,$gt:Scule.interpreter.arities.range,$gte:Scule.interpreter.arities.range,$all:Scule.interpreter.arities.array,$in:Scule.interpreter.arities.array,$nin:Scule.interpreter.arities.array,$elemMatch:Scule.interpreter.arities.array,$eq:Scule.interpreter.arities.binary,$ne:Scule.interpreter.arities.binary,$size:Scule.interpreter.arities.binary,$exists:Scule.interpreter.arities.binary,$within:Scule.interpreter.arities.geospatial,$near:Scule.interpreter.arities.geospatial,$set:Scule.interpreter.arities.mutate,$inc:Scule.interpreter.arities.mutate,$unset:Scule.interpreter.arities.mutate,$pull:Scule.interpreter.arities.mutate,$pullAll:Scule.interpreter.arities.mutate,$pop:Scule.interpreter.arities.mutate,$push:Scule.interpreter.arities.mutate,$pushAll:Scule.interpreter.arities.mutate,$rename:Scule.interpreter.arities.mutate},Scule.interpreter.classes.QueryNormalizer=function(){this.normalize=function(t){var e=function(t){for(var n in t)if(Scule.global.functions.isScalar(t[n])||t[n]instanceof RegExp||t[n]instanceof Scule.db.classes.ObjectId){var i=t[n];i instanceof Scule.db.classes.ObjectId&&(i=""+t[n]),delete t[n],t[n]={$eq:i}}else"$or"==n||"$elemMatch"==n?e(t[n]):t[n]=Scule.global.functions.sortObjectKeys(t[n]);return Scule.global.functions.sortObjectKeys(t)};return e(t)}},Scule.interpreter.functions.intersection=function(t){if(1==t.length)return t[0];var e=Scule.getHashTable(),n=null;if(t.forEach(function(t){(!n||t.length<n.length)&&(n=t)}),!n)return[];n.forEach(function(t){e.put(Scule.global.functions.getObjectId(t),{c:1,o:t})});for(var i=[],s=t.length,r=0;s>r;r++)if(t[r]!=n){var a=function(t){var n=e.get(Scule.global.functions.getObjectId(t));n&&(n.c++,n.c==s&&i.push(t))};t[r].forEach(a)}return i},Scule.interpreter.classes.DateComparator=function(){this.isDate=function(t){return t instanceof Date||t instanceof Scule.db.classes.ObjectDate},this.normalizeDate=function(t){if(!this.isDate(t))throw Error("unable to compare non-date object");return t instanceof Scule.db.classes.ObjectDate?t.toDate().getTime():t instanceof Date?t.getTime():t},this.$eq=function(t,e){return this.normalizeDate(t)===this.normalizeDate(e)},this.$gt=function(t,e){return this.normalizeDate(t)>this.normalizeDate(e)},this.$gte=function(t,e){return this.normalizeDate(t)>=this.normalizeDate(e)},this.$lt=function(t,e){return this.normalizeDate(t)<this.normalizeDate(e)},this.$lte=function(t,e){return this.normalizeDate(t)<=this.normalizeDate(e)}},Scule.interpreter.classes.QueryEngine=function(){this.comparator=new Scule.interpreter.classes.DateComparator,this.traverse=function(t,e){return Scule.global.functions.traverse(t,e)},this.traverseObject=function(t,e){return Scule.global.functions.traverseObject(Scule.global.functions.parseAttributes(t),e)},this.$ne=function(t,e){return!this.$eq(t,e)},this.$eq=function(t,e){return e instanceof RegExp?e.test(t):t instanceof Scule.db.classes.ObjectId?""+t==e:this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$eq(t,e):t===e},this.$gt=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$gt(t,e):t>e},this.$gte=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$gte(t,e):t>=e},this.$lt=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$lt(t,e):e>t},this.$lte=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$lte(t,e):e>=t},this.$all=function(t,e){if(!Scule.global.functions.isArray(t)||!Scule.global.functions.isArray(e))return!1;var n=0,i={};for(n=0;t.length>n;n++)i[t[n]]=!0;for(n=0;e.length>n;n++)if(!i.hasOwnProperty(e[n]))return!1;return!0},this.$in=function(t,e){for(var n=0;e.length>n;n++)if(this.$eq(t,e[n]))return!0;return!1},this.$nin=function(t,e){for(var n=0;e.length>n;n++)if(this.$eq(t,e[n]))return!1;return!0},this.$elemMatch=function(t,e){if(!Scule.global.functions.isArray(t))return!1;for(var n=0;t.length>n;n++)if(e(t[n]))return!0;return!1},this.$size=function(t,e){return Scule.global.functions.isInteger(e)?Scule.global.functions.sizeOf(t)==e:!1},this.$exists=function(t,e){return e?void 0!==t:void 0===t},this.$within=function(t,e){if(!t.hasOwnProperty("lat")||!t.hasOwnProperty("lon"))return!1;if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lon"))return!1;var n=Math.sqrt(Math.pow(e.lat-t.lat,2)+Math.pow(e.lon-t.lon,2));return e.distance>=n},this.$near=function(t,e){if(!t.hasOwnProperty("lat")||!t.hasOwnProperty("lon"))return!1;if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lon"))return!1;var n=6371*Math.acos(Math.sin(t.lat)*Math.sin(e.lat)+Math.cos(t.lat)*Math.cos(e.lat)*Math.cos(e.lon-t.lon));return e.distance>=n},this.$sort=function(t,e,n){Scule.global.functions.sort(t,e,n)},this.$set=function(t,e,n){var i=t[0],s=t[1];i in s?s[i]=e:n===!0&&(s[i]=e)},this.$unset=function(t){var e=t[0],n=t[1];e in n&&delete n[e]},this.$inc=function(t,e,n){Scule.global.functions.isInteger(e)||(e=1);var i=t[0],s=t[1];i in s?(Scule.global.functions.isInteger(s[i])||Scule.global.functions.isDouble(s[i]))&&(s[i]+=e):n&&(s[i]=e)},this.$pull=function(t,e){var n=t[0],i=t[1];if(n in i&&Scule.global.functions.isArray(i[n])){for(var s=[],r=0;i[n].length>r;r++)i[n][r]!==e&&s.push(i[n][r]);i[n]=s}},this.$pullAll=function(t,e){var n=t[0],i=t[1];if(n in i&&Scule.global.functions.isArray(i[n])){if(!Scule.global.functions.isArray(e))throw"the $pullAll operator requires an associated array as an operand";var s=Scule.getHashTable();e.forEach(function(t){s.put(t,!0)});for(var r=0;i[n].length>r;r++)s.contains(i[n][r])&&(i[n].splice(r,1),r--)}},this.$pop=function(t){var e=t[0],n=t[1];e in n&&Scule.global.functions.isArray(n[e])&&n[e].pop()},this.$push=function(t,e,n){var i=t[0],s=t[1];i in s||!n?Scule.global.functions.isArray(s[i])&&s[i].push(e):s[i]=[e]},this.$pushAll=function(t,e,n){var i=t[0],s=t[1];if(i in s||!n){if(!Scule.global.functions.isArray(e))throw"the $pushAll operator requires an associated array as an operand";Scule.global.functions.isArray(s[i])&&e.forEach(function(t){s[i].push(t)})}else s[i]=e.slice(0)}},Scule.interpreter.classes.QueryCompiler=function(){this.cache=Scule.getHashTable(),this.engine=new Scule.interpreter.classes.QueryEngine,this.normalizer=new Scule.interpreter.classes.QueryNormalizer,this.compileConditions=function(t){var e,n,i="";return t.hasOwnProperty("$sort")&&(e=t.$sort,n=Scule.global.functions.objectKeys(e),1==n.length&&(i+="	engine.$sort("+e[n[0]]+', r, "'+n[0]+'");\n')),t.hasOwnProperty("$skip")&&(i+="	r.splice(0, "+t.$skip+");\n"),t.hasOwnProperty("$limit")&&(i+="	if (r.length > "+t.$limit+") {\n",i+="		r.splice("+t.$limit+");\n",i+="	}\n"),i},this.compileClauseList=function(t){var e=this,n=[];return Scule.global.functions.isArray(t)?(t.forEach(function(t){var i=[];for(var s in t)t.hasOwnProperty(s)&&(i=i.concat(e.compileQueryClauses(s,t[s])));n.push(i.join(" && "))}),n.join(" || ")):n},this.compileExpressions=function(t){t=this.normalizer.normalize(t);var e=[];for(var n in t)e=e.concat(this.compileQueryClauses(n,t[n]));return e},this.compileQueryClauses=function(t,e){var n=[];for(var i in e)if(this.engine.hasOwnProperty(i))if("$elemMatch"==i){var s=this.compileExpressions(e[i]),r="function(o) { return ("+s.join(" && ")+"); }";0>t.indexOf(".")?n.push("engine.$elemMatch(o."+t+", "+r+")"):n.push("engine.$elemMatch(engine.traverse("+JSON.stringify(t)+", o), "+r+")")}else if(0>t.indexOf(".")){var a=null;a=e[i]instanceof RegExp?""+e[i]:e[i]instanceof Date?'new Date("'+(""+e[i])+'")':e[i]instanceof Scule.db.classes.ObjectDate?'new Date("'+(""+e[i].toDate())+'")':JSON.stringify(e[i]),n.push("engine."+i+"(o."+t+", "+a+")")}else n.push("engine."+i+"(engine.traverse("+JSON.stringify(t)+", o), "+a+")");return n},this.compileUpdateClauses=function(t,e,n){if(this.engine.hasOwnProperty(t)){var i=[];for(var s in e)i.push("		engine."+t+"(engine.traverseObject("+JSON.stringify(s)+", o), "+JSON.stringify(e[s])+", "+JSON.stringify(n)+");");return i}},this.compileUpdate=function(query,upsert,ignoreCache){var hash=Scule.md5.hash(this.serializeQuery(query));if(this.cache.contains(hash))return this.cache.get(hash);var updates=[],closure="var u = function(objects, collection, engine) {\n";closure+="	objects.forEach(function(o) {\n";for(var key in query)query.hasOwnProperty(key)&&(updates=updates.concat(this.compileUpdateClauses(key,query[key],upsert)));return closure+=updates.join("\n"),closure+="\n	});\n",closure+="	return objects;\n",closure+="}\n",ignoreCache?closure:(eval(closure),this.cache.put(hash,u),this.cache.get(hash))},this.serializeQuery=function(t){var e=Scule.global.functions.cloneObject(t),n=function(t){for(var e in t)t[e]instanceof Scule.db.classes.ObjectId||t[e]instanceof RegExp?t[e]=""+t[e]:Scule.global.functions.isScalar(t[e])||n(t[e])};return n(e),JSON.stringify(e)},this.compileQuery=function(query,conditions,ignoreCache){query=this.normalizer.normalize(query);var hash=Scule.md5.hash(this.serializeQuery(query)+this.serializeQuery(conditions));if(this.cache.contains(hash))return this.cache.get(hash);var closure="var c = function(objects, engine) {\n";if(closure+="	var r = [];\n",Scule.global.functions.sizeOf(query)>0){closure+="	objects.forEach(function(o) {\n",closure+="		o = o.element;\n";var ands=[],ors="";for(var key in query)query.hasOwnProperty(key)&&("$or"==key?ors="("+this.compileClauseList(query[key])+")":ands=ands.concat(this.compileQueryClauses(key,query[key])));ands.length>0?(ors.length>0&&(ors=" && "+ors),closure+="		if (("+ands.join(" && ")+")"+ors+") {\n",closure+="			r[r.length] = o;\n",closure+="		}\n"):ors.length>0&&(closure+="		if ("+ors+") {\n",closure+="			r[r.length] = o;\n",closure+="		}\n"),closure+="	});\n"}else closure+="	r = objects.toArray();\n";return conditions&&(closure+=this.compileConditions(conditions)),closure+="	return r;\n",closure+="};\n",ignoreCache?closure:(eval(closure),this.cache.put(hash,c),this.cache.get(hash))},this.explainQuery=function(t,e){var n=this.compileQuery(t,e,!0);return console.log(n),n},this.explainUpdate=function(t,e){var n=this.compileUpdate(t,e,!0);return console.log(n),n}},Scule.interpreter.classes.QueryInterpreter=function(){this.compiler=new Scule.interpreter.classes.QueryCompiler,this.interpret=function(t,e,n,i){if(i)return this.compiler.explainQuery(e,n);var s=t.documents.queue,r=this.compiler.compileQuery(e,n);return r(s,Scule.interpreter.objects.engine)},this.update=function(t,e,n,i,s,r){var a=this.interpret(t,e,i,r);if(r)return this.compiler.explainUpdate(n,s);var u=this.compiler.compileUpdate(n,s);return u(a,t,Scule.interpreter.objects.engine)}},Scule.interpreter.objects.engine=new Scule.interpreter.classes.QueryEngine,Scule.getQueryNormalizer=function(){return new Scule.interpreter.classes.QueryNormalizer},Scule.getQueryEngine=function(){return new Scule.interpreter.classes.QueryEngine},Scule.getQueryCompiler=function(){return new Scule.interpreter.classes.QueryCompiler},Scule.getQueryInterpreter=function(){return new Scule.interpreter.classes.QueryInterpreter},Scule.getDateComparator=function(){return new Scule.interpreter.classes.DateComparator}}(),function(){Scule.db.classes.SimpleCryptographyProvider=function(){this.signString=function(t,e,n){return Scule.sha1.hash(Scule.sha1.hash(t+e)+n)},this.signObject=function(t,e,n){return t._sig=n,this.signString(JSON.stringify(t),e,n)},this.signJSONString=function(t,e,n){return this.signString(JSON.stringify(t),e,n)},this.verifyObjectSignature=function(t,e,n){var i=t._sig,s=this.signObject(t,e,n);return i==s}},Scule.db.classes.StorageEngine=function(t){this.configuration=t,this.crypto=null,this.setConfiguration=function(t){this.configuration=t},this.getConfiguration=function(){return this.configuration},this.setCryptographyProvider=function(t){this.crypto=t},this.getCryptographyProvider=function(){return this.crypto},this.write=function(){throw"function not implemented in abstract class"},this.read=function(){throw"function not implemented in abstract class"}},Scule.db.classes.DummyStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.write=function(t,e,n){n&&n(e)},this.read=function(t,e){e&&e()}},Scule.db.classes.MemoryStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),this.storage={},this.write=function(t,e,n){e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+"")),e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt),this.storage["__scule_collection__"+t]=JSON.stringify(e),n&&n(e)},this.read=function(t,e){if(!("__scule_collection__"+t in this.storage)){var n={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:3,_name:t,_objects:{}};n._sig=this.crypto.signObject(n,this.configuration.secret,n._salt),this.storage["__scule_collection__"+t]=JSON.stringify(n)}var i=this.storage["__scule_collection__"+t],s=JSON.parse(i);if(this.crypto.verifyObjectSignature(s,this.configuration.secret,s._salt)===!1)throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection});delete s._sig,e&&e(s)}},Scule.db.classes.LocalStorageStorageEngine=function(t){if(Scule.db.classes.StorageEngine.call(this,t),this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),!window||!window.hasOwnProperty("localStorage")&&null!==window.localStorage)throw JSON.stringify({event:"SculeLocalStorageError",message:"Local storage is not available on this device"});this.write=function(t,e,n){e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+""));try{e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt),localStorage.setItem("__scule_collection__"+t,JSON.stringify(e)),n&&n(e)}catch(i){throw JSON.stringify({event:"SculeLocalStorageError",message:"Storage quota exceeded for origin",collection:this.configuration.collection})}},this.read=function(t,e){var n=localStorage.getItem("__scule_collection__"+t),i={};if(n){if(i=JSON.parse(n),this.crypto.verifyObjectSignature(i,this.configuration.secret,i._salt)===!1)throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection});delete i._sig}else i={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:3,_name:t,_objects:{}};e&&e(i)}},Scule.db.classes.TitaniumDiskStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.configuration.path||(this.configuration.path=Titanium.Filesystem.applicationDataDirectory),this.setConfiguration=function(t){this.configuration=t,this.configuration.path||(this.configuration.path=Titanium.Filesystem.applicationDataDirectory)},this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),this.write=function(t,e,n){e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+"")),e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt);var i=Titanium.Filesystem.getFile(this.configuration.path,t+".json");return i.write(JSON.stringify(e)),n&&n(e),!0},this.read=function(t,e){var n=Titanium.Filesystem.getFile(this.configuration.path,t+".json");if(n.exists()){var i=JSON.parse(n.read());return 0==this.crypto.verifyObjectSignature(i,this.configuration.secret,i._salt)?(Ti.App.fireEvent("SculeDataTampered",{filename:t}),!1):(delete i._sig,e&&e(i),i)}return!1}},Scule.db.classes.NodeJSDiskStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.filesystem=require("fs"),this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),this.write=function(t,e,n){var i=this.configuration.path+"/"+t+".json";e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+"")),e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt),this.filesystem.writeFile(i,JSON.stringify(e),function(t){if(t)throw t;n&&n(e)})},this.read=function(t,e){var n=this.configuration.path+"/"+t+".json",i=this;this.filesystem.exists(n,function(s){return s?(i.filesystem.readFile(n,function(n,s){if(n)throw n;var r=JSON.parse(s);if(r._version>2&&i.crypto.verifyObjectSignature(r,i.configuration.secret,r._salt)===!1)throw JSON.stringify({event:"SculeDataTampered",filename:t});delete r._sig,e&&e(r)}),void 0):e({})})}},Scule.db.classes.ObjectId=function(t){if(void 0===t){for(var e=Math.floor((new Date).getTime()/1e3).toString(16),n=Scule.md5.hash(Scule.global.functions.getMACAddress()).substring(0,6),i=Scule.global.functions.randomFromTo(1e3,9999).toString(16);4>i.length;)i="0"+i;for(var s=Scule.global.functions.randomFromTo(1e5,999999).toString(16);6>s.length;)s="0"+s;t=e+n+i+s}this.id=t,this.$type="id",this.toString=function(){return""+this.id}},Scule.db.classes.ObjectDate=function(t,e){if(void 0===t&&void 0===e){var n=""+(new Date).getTime();t=parseInt(n.substring(0,10),10),e=parseInt(n.substring(10),10)}this.ts=parseInt(t+e,10),this.sec=t,this.usec=e,this.$type="date",this.getTimestamp=function(){return this.ts},this.getSeconds=function(){return this.sec},this.getMicroSeconds=function(){return this.usec},this.toDate=function(){return new Date(1e3*this.sec+this.usec)}},Scule.db.classes.DBRef=function(t,e){if(void 0===t||void 0===e)throw"illegal object reference";this.ref=t,this.id=new Scule.db.classes.ObjectId(e),this.$type="dbref",this.getRef=function(){return this.ref},this.getId=function(){return this.id},this.resolve=function(){return this.resolveReference()},this.resolveReference=function(){var t=Scule.factoryCollection(this.ref);return t.findOne(this.id)}},Scule.db.classes.PrimaryKeyIndex=function(){this.table=Scule.getHashTable(),this.queue=Scule.getDoublyLinkedList(),this.clear=function(){this.table.clear(),this.queue.clear()},this.contains=function(t){return this.table.contains(t)},this.get=function(t){return this.table.contains(t)?this.table.get(t).element:null},this.add=function(t){var e=Scule.global.functions.getObjectId(t,!0);return this.table.contains(e)&&this.remove(t),this.table.put(e,this.queue.add(t)),!0},this.remove=function(t){var e=Scule.global.functions.getObjectId(t,!0);if(!this.table.contains(e))return!1;var n=this.table.remove(e);if(!n)return!1;var i=n.prev,s=n.next;return i&&(i.next=s),s&&(s.prev=i),n.detach(),this.queue.length--,n.element},this.length=function(){return this.queue.length},this.toTable=function(){var t={};return this.queue.forEach(function(e){t[Scule.global.functions.getObjectId(e.element,!0)]=e.element}),t},this.toArray=function(){return this.queue.toArray()}},Scule.db.classes.Collection=function(t){this.documents=Scule.getPrimaryKeyIndex(),this.interpreter=Scule.getQueryInterpreter(),this.version=3,this.lastId=null,this.name=t,this.autoCommit=!1,this.isOpen=!1,this.storage=null,this.setStorageEngine=function(t){this.storage=t},this.setAutoCommit=function(t){this.autoCommit=t},this.getName=function(){return this.name},this.getLength=function(){return this.documents.length()},this.getLastInsertId=function(){return this.lastId},this.open=function(t){if(!this.isOpen){var e=this;this.storage.read(this.name,function(n){if(n){for(var i in n._objects)if(n._objects.hasOwnProperty(i)){var s=n._objects[i];Scule.db.functions.unflattenObject(n._objects[i]),e.documents.add(s)}e.isOpen=!0,t&&t(this)}})}},this.commit=function(t){var e={_sig:null,_salt:null,_name:this.name,_version:this.version,_objects:this.documents.toTable()};this.storage.write(this.name,e,t)},this.find=function(t,e,n){if(Scule.global.constants.ID_FIELD in t)return[this.findOne(t[Scule.global.constants.ID_FIELD])];var i=this.interpreter.interpret(this,t,e);return n&&n(i),i},this.explain=function(t,e,n){this.interpreter.interpret(this,t,e,!0),n&&n()},this.clear=function(t){this.documents.clear(),t&&t(this)},this.findAll=function(t){var e=this.documents.toArray();return t&&t(e),e},this.findOne=function(t,e){Scule.global.functions.isScalar(t)||(t=""+t);var n=null;return this.documents.contains(t)&&(n=this.documents.get(t)),e&&e(n),n},this.save=function(t,e){return Scule.db.functions.unflattenObject(t),t.hasOwnProperty("_id")&&(t._id instanceof Scule.db.classes.ObjectId||(t._id=new Scule.db.classes.ObjectId(t._id))),this.documents.add(t),this.autoCommit&&this.commit(),this.lastId=Scule.global.functions.getObjectId(t),e&&e(this.lastId),this.lastId},this.update=function(t,e,n,i,s){var r=this.interpreter.update(this,t,e,n,i);return s&&s(r),r},this.count=function(t,e,n){var i=this.find(t,e).length;return n&&n(i),i},this.remove=function(t,e,n){var i=this,s=this.find(t,e);return s.forEach(function(t){i.documents.remove(t)}),n&&n(s),s},this.distinct=function(t,e,n){var i=this.find(e),s={};return i.forEach(function(e){e[t]in s||(s[e[t]]=0),s[e[t]]++}),n&&n(s),s},this.merge=function(t,e){if(!t)throw"the merge function requires a valid collection as a parameter";var n=this,i=t.findAll();return i.forEach(function(t){n.documents.contains(t._id)||n.documents.add(t)}),e&&e(this),!0},this.mapReduce=function(t,e,n,i){new Scule.db.classes.MapReduceHandler(t,e,n).run(this,i)}},Scule.db.classes.MapReduceHandler=function(t,e,n){if(this.options=n,!t)throw"A valid function is requires as the `map` parameter of the map/reduce operation";if(!e)throw"A valid function is requires as the `reduce` parameter of the map/reduce operation";if(!("out"in n))throw"A valid output collection connection url is required as the `out` parameter of the map/reduce options object";if(!("merge"in n.out||"reduce"in n.out))throw"A valid output collection connection url is required as either the `merge` or `reduce` out parameter of the map/reduce options object";
"query"in n||(n.query={}),"conditions"in n||(n.conditions={}),this.map=t,this.reduce=e,this.finalize="finalize"in n?n.finalize:null,this.run=function(t,e){var n=this,i="merge"in this.options.out,s=Scule.factoryCollection(i?this.options.out.merge:this.options.out.reduce),r=Scule.getHashTable(),a=function(t,e){r.contains(t)||r.put(t,[]),r.get(t).push(e)},u=t.find(this.options.query,this.options.conditions);u.forEach(function(t){n.map(t,a)});var c=null;i&&(c=Scule.factoryCollection("scule+dummy://__mr"+(new Date).getTime()));var o=Scule.getHashTable(),l=r.getKeys();return l.forEach(function(t){o.put(t,n.reduce(t,r.get(t))),n.finalize&&o.put(t,n.finalize(t,o.get(t))),i?c.save(o.get(t)):s.save(o.get(t))}),i&&s.merge(c),e&&e(s),!0}},Scule.db.classes.CollectionFactory=function(){this.collections=Scule.getHashTable(),this.getCollection=function(t,e){if(this.collections.contains(t))return this.collections.get(t).c;e||(e={secret:"dummy"});var n=Scule.db.functions.parseCollectionURL(t);if(!(n.plugin in Scule.db.plugins))throw n.plugin+" is not a registered Scule plugin";if(!(n.engine in Scule.db.engines))throw n.engine+" is nto a registered Scule storage engine";var i=new Scule.db.engines[n.engine](e),s=new Scule.db.plugins[n.plugin](n.name);return s.setStorageEngine(i),s.open(),this.collections.put(t,{c:s,t:(new Date).getTime()}),this.collections.get(t).c}},Scule.db.functions.debug=function(t){Scule.db.global.debug===!0&&console.log(t)},Scule.db.functions.unflattenObject=function(t){var e=function(t){if(!Scule.global.functions.isScalar(t))for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];if(!Scule.global.functions.isScalar(i)&&i&&"$type"in i)switch(i.$type){case"date":t[n]=new Scule.db.classes.ObjectDate(i.sec,i.usec),t[n].ts=i.ts;break;case"id":t[n]=new Scule.db.classes.ObjectId(i.id);break;case"dbref":t[n]=new Scule.db.classes.DBRef(i.ref,i.id)}else e(i)}};e(t),Scule.global.constants.ID_FIELD in t||(t[Scule.global.constants.ID_FIELD]=new Scule.db.classes.ObjectId)},Scule.db.functions.parseCollectionURL=function(t){var e=t.match(/^([^\+]*)\+([^\/]*)\:\/\/(.*)/);if(!e||4!=e.length)throw t+" is an invalid collection url";return{plugin:e[1],engine:e[2],name:e[3]}},Scule.db.objects.core.collections.factory=new Scule.db.classes.CollectionFactory,Scule.debug=function(t){Scule.global.variables.debug=t},Scule.registerStorageEngine=function(t,e){if(t in Scule.db.engines)throw t+" storage engine is already registered";Scule.db.engines[t]=e},Scule.registerCollectionPlugin=function(t,e){if(t in Scule.db.plugins)throw t+" collection plugin is already registered";Scule.db.plugins[t]=e},function(){Scule.registerStorageEngine("memory",Scule.db.classes.MemoryStorageEngine),Scule.registerStorageEngine("dummy",Scule.db.classes.DummyStorageEngine),Scule.registerStorageEngine("local",Scule.db.classes.LocalStorageStorageEngine),Scule.registerStorageEngine("nodejs",Scule.db.classes.NodeJSDiskStorageEngine),Scule.registerStorageEngine("titanium",Scule.db.classes.TitaniumDiskStorageEngine),Scule.registerCollectionPlugin("scule",Scule.db.classes.Collection)}(),Scule.factoryCollection=function(t,e){return Scule.db.objects.core.collections.factory.getCollection(t,e)},Scule.dropAll=function(){Scule.db.objects.core.collections.factory.collections.clear()},Scule.getIndex=function(){return new Scule.db.classes.Index},Scule.getHashTableIndex=function(t){return new Scule.db.classes.HashTableIndex(t)},Scule.getObjectId=function(t){return new Scule.db.classes.ObjectId(t)},Scule.getObjectDate=function(t,e){return new Scule.db.classes.ObjectDate(t,e)},Scule.getObjectDateFromDate=function(t){if(!(t instanceof Date))throw Error("unable to factory ObjectDate from non-date object");var e=""+t.getTime(),n=parseInt(e.substring(0,10),10),i=parseInt(e.substring(10),10);return new Scule.db.classes.ObjectDate(n,i)},Scule.getDBRef=function(t,e){return new Scule.db.classes.DBRef(t,e)},Scule.getMemoryStorageEngine=function(t){return new Scule.db.classes.MemoryStorageEngine(t)},Scule.getLocalStorageStorageEngine=function(t){return new Scule.db.classes.LocalStorageStorageEngine(t)},Scule.getNodeJSDiskStorageEngine=function(t){return new Scule.db.classes.NodeJSDiskStorageEngine(t)},Scule.getTitaniumDiskStorageEngine=function(t){return new Scule.db.classes.TitaniumDiskStorageEngine(t)},Scule.getSimpleCryptographyProvider=function(){return new Scule.db.classes.SimpleCryptographyProvider}}(),function(){"undefined"!=typeof Titanium&&Titanium.Platform!==void 0?(Scule.md5.hash=function(t){return Ti.Utils.md5HexDigest(t)},Scule.sha1.hash=function(t){return Ti.Utils.sha1(t)},module.exports=Scule):"undefined"!=typeof exports&&this.exports!==exports?(Scule.md5={m:require("crypto"),hash:function(t){return this.m.createHash("md5").update(t).digest("hex")}},Scule.sha1={m:require("crypto"),hash:function(t){return this.m.createHash("sha1").update(t).digest("hex")}},module.exports=Scule):Scule.global.system.installHashFunctions()}();