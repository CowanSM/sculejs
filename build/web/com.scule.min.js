if(typeof Scule=="undefined"){var Scule={namespaces:{}}}if(typeof console=="undefined"){var console={log:function(e){}}}(function(){"use strict";Scule.registerNamespace=function(e,t){if(e in Scule){throw"namespace "+e+" is already registered"}Scule[e]=t};Scule.registerComponent=function(e,t,i,n){var s=Scule.require(e);if(!(t in s)){throw"type "+t+" is not registered inside "+e+" namespace"}s[t][i]=n};Scule.require=function(e){if(!(e in Scule)){throw"namespace "+e+" has not been registered, require failed"}return Scule[e]};Scule.registerNamespace("global",{constants:{INDEX_TYPE_BTREE:0,INDEX_TYPE_RTREE:1,INDEX_TYPE_HASH:2,INDEX_TYPE_CLUSTERED:3,ID_FIELD:"_id",REF_FIELD:"_ref",OBJECT_WILDCARD:"*"},classes:{},functions:{},variables:{debug:false}});Scule.registerNamespace("datastructures",{constants:Scule.require("global").constants,classes:{},variables:{},$f:Scule.require("global").functions});Scule.registerNamespace("instrumentation",{constants:Scule.require("global").constants,classes:{}});Scule.registerNamespace("interpreter",{functions:{},classes:{},objects:{},variables:{},symbols:{table:{}},arities:{expression:-1,logical:0,binary:1,selective:2,negative:3,range:4,mutate:5,array:6,geospatial:7,variable:8,operand:9,index:10},constants:Scule.require("global").constants,$f:Scule.require("global").functions,$d:Scule.require("datastructures")});Scule.registerNamespace("db",{constants:Scule.require("global").constants,functions:{},classes:{},plugins:{},engines:{},objects:{core:{collections:{}}},$f:Scule.require("global").functions,$i:Scule.require("interpreter")});Scule.registerNamespace("events",{functions:{},classes:{},objects:{},$d:Scule.require("datastructures")});Scule.registerNamespace("messaging",{functions:{},classes:{},objects:{},$d:Scule.require("datastructures")})})();(function(){"use strict";Scule.global.classes.sha1=function(){this.hexcase=0;this.b64pad="";this.hex_sha1=function(e){return this.rstr2hex(this.rstr_sha1(this.str2rstr_utf8(e)))};this.hash=function(e){return this.hex_sha1(e)};this.b64_sha1=function(e){return this.rstr2b64(this.rstr_sha1(this.str2rstr_utf8(e)))};this.any_sha1=function(e,t){return this.rstr2any(this.rstr_sha1(this.str2rstr_utf8(e)),t)};this.hex_hmac_sha1=function(e,t){return this.rstr2hex(this.rstr_hmac_sha1(this.str2rstr_utf8(e),this.str2rstr_utf8(t)))};this.b64_hmac_sha1=function(e,t){return this.rstr2b64(this.rstr_hmac_sha1(this.str2rstr_utf8(e),this.str2rstr_utf8(t)))};this.any_hmac_sha1=function(e,t,i){return this.rstr2any(this.rstr_hmac_sha1(this.str2rstr_utf8(e),this.str2rstr_utf8(t)),i)};this.sha1_vm_test=function(){return this.hex_sha1("abc").toLowerCase()=="a9993e364706816aba3e25717850c26c9cd0d89d"};this.rstr_sha1=function(e){return this.binb2rstr(this.binb_sha1(this.rstr2binb(e),e.length*8))};this.rstr_hmac_sha1=function(e,t){var i=this.rstr2binb(e);if(i.length>16){i=this.binb_sha1(i,e.length*8)}var n=new Array(16),s=new Array(16);for(var r=0;r<16;r++){n[r]=i[r]^909522486;s[r]=i[r]^1549556828}var a=this.binb_sha1(n.concat(this.rstr2binb(t)),512+t.length*8);return this.binb2rstr(this.binb_sha1(s.concat(a),512+160))};this.rstr2hex=function(e){this.hexcase=0;var t=this.hexcase?"0123456789ABCDEF":"0123456789abcdef";var i="";var n;for(var s=0;s<e.length;s++){n=e.charCodeAt(s);i+=t.charAt(n>>>4&15)+t.charAt(n&15)}return i};this.rstr2b64=function(e){this.b64pad="";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var i="";var n=e.length;for(var s=0;s<n;s+=3){var r=e.charCodeAt(s)<<16|(s+1<n?e.charCodeAt(s+1)<<8:0)|(s+2<n?e.charCodeAt(s+2):0);for(var a=0;a<4;a++){if(s*8+a*6>e.length*8){i+=this.b64pad}else{i+=t.charAt(r>>>6*(3-a)&63)}}}return i};this.rstr2any=function(e,t){var i=t.length;var n=[];var s,r,a,u;var l=new Array(Math.ceil(e.length/2));for(s=0;s<l.length;s++){l[s]=e.charCodeAt(s*2)<<8|e.charCodeAt(s*2+1)}while(l.length>0){u=[];a=0;for(s=0;s<l.length;s++){a=(a<<16)+l[s];r=Math.floor(a/i);a-=r*i;if(u.length>0||r>0){u[u.length]=r}}n[n.length]=a;l=u}var c="";for(s=n.length-1;s>=0;s--){c+=t.charAt(n[s])}var h=Math.ceil(e.length*8/(Math.log(t.length)/Math.log(2)));for(s=c.length;s<h;s++){c=t[0]+c}return c};this.str2rstr_utf8=function(e){var t="";var i=-1;var n,s;while(++i<e.length){n=e.charCodeAt(i);s=i+1<e.length?e.charCodeAt(i+1):0;if(55296<=n&&n<=56319&&56320<=s&&s<=57343){n=65536+((n&1023)<<10)+(s&1023);i++}if(n<=127){t+=String.fromCharCode(n)}else if(n<=2047){t+=String.fromCharCode(192|n>>>6&31,128|n&63)}else if(n<=65535){t+=String.fromCharCode(224|n>>>12&15,128|n>>>6&63,128|n&63)}else if(n<=2097151){t+=String.fromCharCode(240|n>>>18&7,128|n>>>12&63,128|n>>>6&63,128|n&63)}}return t};this.str2rstr_utf16le=function(e){var t="";for(var i=0;i<e.length;i++){t+=String.fromCharCode(e.charCodeAt(i)&255,e.charCodeAt(i)>>>8&255)}return t};this.str2rstr_utf16be=function(e){var t="";for(var i=0;i<e.length;i++){t+=String.fromCharCode(e.charCodeAt(i)>>>8&255,e.charCodeAt(i)&255)}return t};this.rstr2binb=function(e){var t=new Array(e.length>>2);var i=null;for(i=0;i<t.length;i++){t[i]=0}for(i=0;i<e.length*8;i+=8){t[i>>5]|=(e.charCodeAt(i/8)&255)<<24-i%32}return t};this.binb2rstr=function(e){var t="";for(var i=0;i<e.length*32;i+=8){t+=String.fromCharCode(e[i>>5]>>>24-i%32&255)}return t};this.binb_sha1=function(e,t){e[t>>5]|=128<<24-t%32;e[(t+64>>9<<4)+15]=t;var i=new Array(80);var n=1732584193;var s=-271733879;var r=-1732584194;var a=271733878;var u=-1009589776;for(var l=0;l<e.length;l+=16){var c=n;var h=s;var o=r;var f=a;var g=u;for(var d=0;d<80;d++){if(d<16){i[d]=e[l+d]}else{i[d]=this.bit_rol(i[d-3]^i[d-8]^i[d-14]^i[d-16],1)}var v=this.safe_add(this.safe_add(this.bit_rol(n,5),this.sha1_ft(d,s,r,a)),this.safe_add(this.safe_add(u,i[d]),this.sha1_kt(d)));u=a;a=r;r=this.bit_rol(s,30);s=n;n=v}n=this.safe_add(n,c);s=this.safe_add(s,h);r=this.safe_add(r,o);a=this.safe_add(a,f);u=this.safe_add(u,g)}return new Array(n,s,r,a,u)};this.sha1_ft=function(e,t,i,n){if(e<20){return t&i|~t&n}if(e<40){return t^i^n}if(e<60){return t&i|t&n|i&n}return t^i^n};this.sha1_kt=function(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514};this.safe_add=function(e,t){var i=(e&65535)+(t&65535);var n=(e>>16)+(t>>16)+(i>>16);return n<<16|i&65535};this.bit_rol=function(e,t){return e<<t|e>>>32-t}};Scule.getSHA1=function(){return new Scule.global.classes.sha1};Scule.sha1=Scule.getSHA1()})();(function(){"use strict";Scule.global.classes.md5=function(){this.md5cycle=function(e,t){var i=e[0],n=e[1],s=e[2],r=e[3];i=this.ff(i,n,s,r,t[0],7,-680876936);r=this.ff(r,i,n,s,t[1],12,-389564586);s=this.ff(s,r,i,n,t[2],17,606105819);n=this.ff(n,s,r,i,t[3],22,-1044525330);i=this.ff(i,n,s,r,t[4],7,-176418897);r=this.ff(r,i,n,s,t[5],12,1200080426);s=this.ff(s,r,i,n,t[6],17,-1473231341);n=this.ff(n,s,r,i,t[7],22,-45705983);i=this.ff(i,n,s,r,t[8],7,1770035416);r=this.ff(r,i,n,s,t[9],12,-1958414417);s=this.ff(s,r,i,n,t[10],17,-42063);n=this.ff(n,s,r,i,t[11],22,-1990404162);i=this.ff(i,n,s,r,t[12],7,1804603682);r=this.ff(r,i,n,s,t[13],12,-40341101);s=this.ff(s,r,i,n,t[14],17,-1502002290);n=this.ff(n,s,r,i,t[15],22,1236535329);i=this.gg(i,n,s,r,t[1],5,-165796510);r=this.gg(r,i,n,s,t[6],9,-1069501632);s=this.gg(s,r,i,n,t[11],14,643717713);n=this.gg(n,s,r,i,t[0],20,-373897302);i=this.gg(i,n,s,r,t[5],5,-701558691);r=this.gg(r,i,n,s,t[10],9,38016083);s=this.gg(s,r,i,n,t[15],14,-660478335);n=this.gg(n,s,r,i,t[4],20,-405537848);i=this.gg(i,n,s,r,t[9],5,568446438);r=this.gg(r,i,n,s,t[14],9,-1019803690);s=this.gg(s,r,i,n,t[3],14,-187363961);n=this.gg(n,s,r,i,t[8],20,1163531501);i=this.gg(i,n,s,r,t[13],5,-1444681467);r=this.gg(r,i,n,s,t[2],9,-51403784);s=this.gg(s,r,i,n,t[7],14,1735328473);n=this.gg(n,s,r,i,t[12],20,-1926607734);i=this.hh(i,n,s,r,t[5],4,-378558);r=this.hh(r,i,n,s,t[8],11,-2022574463);s=this.hh(s,r,i,n,t[11],16,1839030562);n=this.hh(n,s,r,i,t[14],23,-35309556);i=this.hh(i,n,s,r,t[1],4,-1530992060);r=this.hh(r,i,n,s,t[4],11,1272893353);s=this.hh(s,r,i,n,t[7],16,-155497632);n=this.hh(n,s,r,i,t[10],23,-1094730640);i=this.hh(i,n,s,r,t[13],4,681279174);r=this.hh(r,i,n,s,t[0],11,-358537222);s=this.hh(s,r,i,n,t[3],16,-722521979);n=this.hh(n,s,r,i,t[6],23,76029189);i=this.hh(i,n,s,r,t[9],4,-640364487);r=this.hh(r,i,n,s,t[12],11,-421815835);s=this.hh(s,r,i,n,t[15],16,530742520);n=this.hh(n,s,r,i,t[2],23,-995338651);i=this.ii(i,n,s,r,t[0],6,-198630844);r=this.ii(r,i,n,s,t[7],10,1126891415);s=this.ii(s,r,i,n,t[14],15,-1416354905);n=this.ii(n,s,r,i,t[5],21,-57434055);i=this.ii(i,n,s,r,t[12],6,1700485571);r=this.ii(r,i,n,s,t[3],10,-1894986606);s=this.ii(s,r,i,n,t[10],15,-1051523);n=this.ii(n,s,r,i,t[1],21,-2054922799);i=this.ii(i,n,s,r,t[8],6,1873313359);r=this.ii(r,i,n,s,t[15],10,-30611744);s=this.ii(s,r,i,n,t[6],15,-1560198380);n=this.ii(n,s,r,i,t[13],21,1309151649);i=this.ii(i,n,s,r,t[4],6,-145523070);r=this.ii(r,i,n,s,t[11],10,-1120210379);s=this.ii(s,r,i,n,t[2],15,718787259);n=this.ii(n,s,r,i,t[9],21,-343485551);e[0]=this.add32(i,e[0]);e[1]=this.add32(n,e[1]);e[2]=this.add32(s,e[2]);e[3]=this.add32(r,e[3])};this.cmn=function(e,t,i,n,s,r){t=this.add32(this.add32(t,e),this.add32(n,r));return this.add32(t<<s|t>>>32-s,i)};this.ff=function(e,t,i,n,s,r,a){return this.cmn(t&i|~t&n,e,t,s,r,a)};this.gg=function(e,t,i,n,s,r,a){return this.cmn(t&n|i&~n,e,t,s,r,a)};this.hh=function(e,t,i,n,s,r,a){return this.cmn(t^i^n,e,t,s,r,a)};this.ii=function(e,t,i,n,s,r,a){return this.cmn(i^(t|~n),e,t,s,r,a)};this.md51=function(e){if(/[\x80-\xFF]/.test(e)){e=unescape(encodeURI(e))}var t=e.length,i=[1732584193,-271733879,-1732584194,271733878],n;for(n=64;n<=e.length;n+=64){this.md5cycle(i,this.md5blk(e.substring(n-64,n)))}e=e.substring(n-64);var s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(n=0;n<e.length;n++){s[n>>2]|=e.charCodeAt(n)<<(n%4<<3)}s[n>>2]|=128<<(n%4<<3);if(n>55){this.md5cycle(i,s);for(n=0;n<16;n++){s[n]=0}}s[14]=t*8;this.md5cycle(i,s);return i};this.md5blk=function(e){var t=[],i;for(i=0;i<64;i+=4){t[i>>2]=e.charCodeAt(i)+(e.charCodeAt(i+1)<<8)+(e.charCodeAt(i+2)<<16)+(e.charCodeAt(i+3)<<24)}return t};this.hex_chr="0123456789abcdef".split("");this.rhex=function(e){var t="",i=0;for(;i<4;i++){t+=this.hex_chr[e>>i*8+4&15]+this.hex_chr[e>>i*8&15]}return t};this.hex=function(e){for(var t=0;t<e.length;t++){e[t]=this.rhex(e[t])}return e.join("")};this.hash=function(e){return this.hex(this.md51(e))};this.add32=function(e,t){return e+t&4294967295}};Scule.getMD5=function(){return new Scule.global.classes.md5};if(Scule.getMD5().hash("hello")!="5d41402abc4b2a76b9719d911017c592"){Scule.global.classes.md5.add32=function(e,t){var i=(e&65535)+(t&65535),n=(e>>16)+(t>>16)+(i>>16);return n<<16|i&65535}}Scule.md5=Scule.getMD5()})();(function(){"use strict";Scule.global.functions.extractTrueValues=function(e){var t={};for(var i in e){if(e.hasOwnProperty(i)){if(i.match(/^\$/)){continue}if(e[i]){t[i]=true}}}return t};Scule.global.functions.pushIfNotNull=function(e,t){if(t){e.push(t)}};Scule.global.functions.pushIfExists=function(e,t,i){if(i in t){e.push(t[i])}};Scule.global.functions.getObjectAttribute=function(e,t,i){if(!(t in e)){return i}return e[t]};Scule.global.functions.getObjectId=function(e,t){if(t===undefined){t=false}return t?e[Scule.global.constants.ID_FIELD].toString():e[Scule.global.constants.ID_FIELD]};Scule.global.functions.cloneObject=function(e){var t={};if(Scule.global.functions.isArray(e)){t=[]}for(var i in e){if(typeof e[i]=="object"){if(e[i]instanceof RegExp){t[i]=new RegExp(e[i].source)}else{t[i]=Scule.global.functions.cloneObject(e[i])}}else{t[i]=e[i]}}return t};Scule.global.functions.traverseObject=function(e,t){var i=0;var n=null;var s=function(e){for(var t in e){if(e.hasOwnProperty(t)){if(e[t]===true){n=t;break}else{i++;s(e[t])}}}};s(e);var r=0;var a=function(e,t){if(r==i){return t}for(var n in e){if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n)){return null}if(e[n]===true){return t}else{r++;return a(e[n],t[n])}}}};return[n,a(e,t)]};Scule.global.functions.sortObjectKeys=function(e){var t={};var i=[];for(var n in e){if(e.hasOwnProperty(n)){i.push(n)}}i.sort(function(e,t){var i=false;if(e.match(/^\$/)){e=e.substr(1);i=true}var n=false;if(t.match(/^\$/)){t=t.substr(1);n=true}if(i&&!n){return 1}else if(n&&!i){return-1}if(t>e){return-1}else if(t<e){return 1}else{return 0}});i.forEach(function(i){t[i]=e[i]});return t};Scule.global.functions.objectValues=function(e){var t=[];for(var i in e){if(!e.hasOwnProperty(i)){continue}t.push(e[i])}return t};Scule.global.functions.objectKeys=function(e){var t=[];for(var i in e){if(!e.hasOwnProperty(i)){continue}t.push(i)}return t};Scule.global.functions.sizeOf=function(e){if(e instanceof Array||typeof e==="string"){return e.length}else{var t=0,i;for(i in e){if(e.hasOwnProperty(i)){t++}}return t}return null};Scule.global.functions.shuffle=function(e){var t,i,n=e.length;if(n){while(--n){i=Math.floor(Math.random()*(n+1));t=e[i];e[i]=e[n];e[n]=t}}};Scule.global.functions.unique=function(e){var t={};for(var i=0;i<e.length;i++){t[e[i]]=true}var n=[];for(var s in t){if(t.hasOwnProperty(s)){n.push(s)}}return n};Scule.global.functions.contains=function(e,t){return t in e};Scule.global.functions.stringify=function(e){var t={};for(var i in e){if(typeof e[i]=="function"){t[i]=e[i].toString()}else{t[i]=e[i]}}return JSON.stringify(t)};Scule.global.functions.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"};Scule.global.functions.isInteger=function(e){return parseInt(e,10)==e};Scule.global.functions.isDouble=function(e){return parseFloat(e)==e};Scule.global.functions.isScalar=function(e){return e!==null&&!(e instanceof Object)};Scule.global.functions.randomFromTo=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)};Scule.global.functions.compare=function(e,t){if(e===t){return 0}return e>t?1:-1};Scule.global.functions.compareElementKey=function(e,t){return Scule.global.functions.compare(e.key,t.key)};Scule.global.functions.compareElementValue=function(e,t){return Scule.global.functions.compare(e.value,t.value)};Scule.global.functions.compareArray=function(e,t){if(!Scule.global.functions.isArray(e)&&Scule.global.functions.isArray(t)){return 1}if(Scule.global.functions.isArray(e)&&!Scule.global.functions.isArray(t)){return-1}if(e.length>t.length){return 1}if(t.length>e.length){return-1}var i=true;var n=0;var s=e.length;for(var r=0;r<s;r++){if(Scule.global.functions.isArray(e[r])){n+=Scule.global.functions.compareArray(e[r],t[r])}else{n+=Scule.global.functions.compare(e[r],t[r])}if(n!==0){i=false}}if(n===0&&!i){n=JSON.stringify(e[0]).localeCompare(JSON.stringify(t[0]))}if(n>0){n=1}else if(n<0){n=-1}return n};Scule.global.functions.sort=function(e,t,i){switch(e){case-1:t.sort(function(e,t){return t[i]-e[i]});break;case 0:Scule.global.functions.shuffle(t);break;case 1:t.sort(function(e,t){return e[i]-t[i]});break;case 2:t.sort(function(e,t){if(t[i]>e[i]){return-1}else if(t[i]<e[i]){return 1}else{return 0}});break;case 3:t.sort(function(e,t){if(t[i]<e[i]){return-1}else if(t[i]>e[i]){return 1}else{return 0}});break}};Scule.global.functions.trim=function(e){if(!String.prototype.trim){return e.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")}else{return e.trim()}};Scule.global.functions.getMACAddress=function(){if(!Scule.global.variables.hasOwnProperty("SimulatedMacAddress")){Scule.global.variables.SimulatedMacAddress=(new Date).getTime().toString().substring(9,11)+""+Scule.global.functions.randomFromTo(100,999)}return Scule.global.variables.SimulatedMacAddress};Scule.global.functions.parseAttributes=function(e){if(!Scule.global.functions.isArray(e)){return Scule.global.functions.parseAttributes(e.split(","))}var t=function(e,i,n){var s=Scule.global.functions.trim(i[n]);if(n==i.length-1){e[s]=true}else{var r={};e[s]=r;t(r,i,n+1)}};var i={};e.forEach(function(e){t(i,e.split("."),0)});return i};Scule.global.functions.searchObject=function(e,t){var i=function(e,t,n){if(!t){return}for(var s in e){if(e[s]===true){if(Scule.global.functions.isInteger(s)&&Scule.global.functions.isArray(t)){n.push(t[s])}else{if(s in t){n.push(t[s])}}}else{if(s in t&&!Scule.global.functions.isScalar(t[s])){i(e[s],t[s],n)}}}};var n=[];i(e,t,n);return n};Scule.global.functions.traverse=function(e,t){var i=function(e,t){if(t===undefined){return undefined}if(e.length===1){return t[e.pop()]}else{var n=e.shift();return i(e,t[n])}};return i(e.split("."),t)}})();(function(){"use strict";Scule.events.classes.Event=function(e,t){this.name=e;this.body=t;this.getName=function(){return this.name};this.getBody=function(){return this.body}};Scule.events.classes.EventEmitter=function(){this.listeners=Scule.getHashTable();this.createBucket=function(e){if(!this.listeners.contains(e)){this.listeners.put(e,[])}};this.addEventListener=function(e,t){if(!(t instanceof Scule.events.classes.EventListener)){t=new Scule.events.classes.EventListener(t)}this.createBucket(e);var i=this.listeners.get(e);i.push(t)};this.removeEventListener=function(e,t){this.createBucket(e);if(t instanceof Scule.events.classes.EventListener){t=t.getClosure()}var i=this.listeners.get(e);var n=[];for(var s=0;s<i.length;s++){if(i[s].getClosure()!=t){n.push(t)}}this.listeners.put(e,n)};this.removeEventListeners=function(e){this.listeners.remove(e)};this.fireEvent=function(e,t){this.createBucket(e);if(!(t instanceof Scule.events.classes.Event)){t=new Scule.events.classes.Event(e,t)}var i=this.listeners.get(e);i.forEach(function(e){e.consume(t)})}};Scule.events.classes.EventListener=function(e){this.closure=e;this.consume=function(e){this.closure(e)};this.getClosure=function(){return this.closure}};Scule.getEventListener=function(e){return new Scule.events.classes.EventListener(e)};Scule.getEventEmitter=function(){return new Scule.events.classes.EventEmitter};Scule.getEvent=function(e,t){return new Scule.events.classes.Event(e,t)}})();(function(){"use strict";Scule.messaging.classes.Message=function(e,t){this.key=e;this.body=t;this.getKey=function(){return this.key};this.getBody=function(){return this.body}};Scule.messaging.classes.MessageQueue=function(e){this.name=e;this.subscribers=[];Scule.datastructures.classes.Queue.call(this);this.getName=function(){return this.name};this.addSubscriber=function(e){this.subscribers.push(e)};this.getSubscribers=function(){return this.subscribers};this.removeSubscribers=function(){this.subscribers=[]}};Scule.messaging.classes.MessageExchange=function(e){this.name=e;this.queues=Scule.getHashTable();this.getName=function(){return this.name};this.addQueue=function(t,i){if(!(t instanceof Scule.messaging.classes.MessageQueue)){throw"provided object is not a messge queue"}if(this.queues.contains(t.getName())){throw"exchange "+e+" is already bound to queue "+t.getName()}this.queues.put(t.getName(),t);this.addRoute(t,i);return true};this.addRoute=function(e,t){return true};this.removeQueue=function(e){if(this.queues.contains(e.getName())){this.queues.remove(e.getName());this.removeRoute(e);return true}return false};this.removeRoute=function(e){return true};this.route=function(e){throw"routing is not supported in abstract exchange class"}};Scule.messaging.classes.FanOutMessageExchange=function(e){Scule.messaging.classes.MessageExchange.call(this,e);this.route=function(e){var t=this;var i=this.queues.getKeys();i.forEach(function(i){t.queues.get(i).enqueue(e)})}};Scule.messaging.classes.DirectMessageExchange=function(e){this.routes=Scule.getHashTable();Scule.messaging.classes.MessageExchange.call(this,e);this.addRoute=function(e,t){var i=Scule.md5.hash(t.toString());if(!this.routes.contains(i)){this.routes.put(i,{key:t,queues:[]})}this.routes.get(i).queues.push(e)};this.removeRoute=function(e){var t=this;var i=this.routes.getKeys();i.forEach(function(i){var n=t.routes.get(i);var s=n.queues.length;while(s--){if(n.queues[s]==e){n.queues.splice(s,1)}}})};this.route=function(e){var t=this;var i=this.routes.getKeys();i.forEach(function(i){var n=t.routes.get(i);if(!e.getKey().match(n.key)){return}for(var s=0;s<n.queues.length;s++){n.queues[s].enqueue(e)}})}};Scule.messaging.classes.MessageChannel=function(){this.bindings=Scule.getHashTable();this.bind=function(e,t,i){var n=e.getName()+","+t.getName();if(this.bindings.contains(n)){throw"binding for "+n+" already exists"}this.bindings.put(n,{exchange:e,queue:t});e.addQueue(t,i)};this.unbind=function(e,t){var i=e.getName()+","+t.getName();if(!this.bindings.contains(i)){throw"binding for "+i+" does not exist"}var n=this.bindings.get(i);this.bindings.remove(i);n.exchange.removeQueue(n.queue)}};Scule.messaging.classes.MessageSubscriber=function(e,t){this.queue=e;this.callback=t;this.interval=null;this.start=function(){var e=this;this.interval=setInterval(function(){var t=e.queue.dequeue();if(t){e.callback(t)}},10+Scule.global.functions.randomFromTo(3,8))};this.stop=function(){clearInterval(this.interval)}};Scule.messaging.classes.MessagingDirector=function(){this.queues=Scule.getHashTable();this.exchanges=Scule.getHashTable();this.channel=new Scule.messaging.classes.MessageChannel;this.bind=function(e,t,i){if(i!==undefined){this.bindDirect(e,t,i)}else{this.bindFanOut(e,t)}};this.bindDirect=function(e,t,i){var n=null;var s=null;if(this.exchanges.contains(e)){n=this.exchanges.get(e);if(!(n instanceof Scule.messaging.classes.DirectMessageExchange)){throw"unable to bind directly to a fan-out exchange"}}else{n=new Scule.messaging.classes.DirectMessageExchange(e);this.exchanges.put(e,n)}if(this.queues.contains(t)){s=this.queues.get(t)}else{s=new Scule.messaging.classes.MessageQueue(t);this.queues.put(t,s)}this.channel.bind(n,s,i)};this.bindFanOut=function(e,t){var i=null;var n=null;if(this.exchanges.contains(e)){i=this.exchanges.get(e);if(!(i instanceof Scule.messaging.classes.FanOutMessageExchange)){throw"unable to bind to direct exchange without a routing key"}}else{i=new Scule.messaging.classes.FanOutMessageExchange(e);this.exchanges.put(e,i)}if(this.queues.contains(t)){n=this.queues.get(t)}else{n=new Scule.messaging.classes.MessageQueue(t);this.queues.put(t,n)}this.channel.bind(i,n)};this.publish=function(e,t,i){var n=new Scule.messaging.classes.Message(t,i);if(!this.exchanges.contains(e)){throw"exchange "+e+" does not exist"}var s=this.exchanges.get(e);s.route(n)};this.subscribe=function(e,t){if(!this.queues.contains(e)){throw"queue "+e+" does not exist"}var i=this.queues.get(e);var n=new Scule.messaging.classes.MessageSubscriber(i,t);i.addSubscriber(n);n.start()};this.unsubscribeAll=function(e){if(e===undefined){throw"queue name is required"}if(!this.queues.contains(e)){throw"queue "+e+" does not exist"}var t=this.queues.get(e);var i=t.getSubscribers();i.forEach(function(e){e.stop()});t.subscribers=[]}};Scule.getMessage=function(e,t){return new Scule.messaging.classes.Message(e,t)};Scule.getMessageQueue=function(e){return new Scule.messaging.classes.MessageQueue(e)};Scule.getMessageExchange=function(e){return new Scule.messaging.classes.MessageExchange(e)};Scule.getFanOutMessageExchange=function(e){return new Scule.messaging.classes.FanOutMessageExchange(e)};Scule.getDirectMessageExchange=function(e,t){return new Scule.messaging.classes.DirectMessageExchange(e,t)};Scule.getMessageChannel=function(){return new Scule.messaging.classes.MessageChannel};Scule.getMessagingDirector=function(){return new Scule.messaging.classes.MessagingDirector}})();(function(){"use strict";Scule.datastructures.variables.fnv_hash=function(e,t){var i=2166136261;var n=16777619;var s=e.length;for(var r=0;r<s;r++){i=(i^e.charCodeAt(r))*n}i+=i<<13;i^=i>>7;i+=i<<3;i^=i>>17;i+=i<<5;if(i<0){i=i*-1}return i%t};Scule.datastructures.variables.djb2_hash=function(e,t){var i=5381;var n=e.length;var s=0;for(s=0;s<n;s++){i=(i<<5)+i+e.charCodeAt(s)}if(i<0){i=i*-1}return i%t};Scule.datastructures.variables.joaat_hash=function(e,t){var i=0;var n=e.length;var s=0;for(s=0;s<n;s++){i+=e.charCodeAt(s);i+=i<<10;i^=i>>6}i+=i<<3;i^=i>>11;i+=i<<15;if(i<0){i=i*-1}return i%t};Scule.datastructures.variables.elf_hash=function(e,t){var i=0,n;for(var s=0;s<e.length;s++){i=(i<<4)+e.charCodeAt(s);if(n=i&4026531840){i^=n>>24}i&=~n}return i%t};Scule.datastructures.classes.LinkedList=function(){this.head=null;this.tail=null;this.length=0;this.getHead=function(){return this.head};this.getTail=function(){return this.tail};this.getLength=function(){return this.length};this.isEmpty=function(){return this.length===0};this.clear=function(){this.head=null;this.tail=null;this.length=0};this.get=function(e){if(e<0||e>this.length){return null}if(e===0){return this.head}else{var t=this.head;var i=0;while(t){if(e==i){break}i++;t=t.next}return t}};this.add=function(e){var t=new Scule.datastructures.classes.LinkedListNode(null,e);if(this.head===null){this.head=t}else if(this.tail===null){this.head.next=t;this.tail=t}else{var i=this.tail;i.next=t;this.tail=i.next}this.length++;return t};this.search=function(e,t,i){if(!i){i=Scule.global.functions.compare}var n=this.head;while(n){if(t){if(i(n.element[t],e)===0){break}}else{if(i(n.element,e)===0){break}}n=n.next}return n};this.contains=function(e,t){if(e===null){return false}if(!t){t=Scule.global.functions.compare}var i=this.head;while(i){if(t(i.element,e)===0){break}i=i.next}return i!==null};this.split=function(e){var t;if(e===undefined){e=Math.floor(this.length/2);t=this.middle();if(!t){return null}}else{if(e<1||e>this.length){return null}t=this.get(e-1)}var i=new Scule.datastructures.classes.LinkedList;i.head=t.next;t.next=null;i.tail=this.tail;this.tail=t;i.length=e;this.length=this.length-e;return i};this.middle=function(){if(!this.head){return null}var e=this.head;var t=this.head;while(t.next&&t.next.next){e=e.next;t=t.next.next}return e};this.remove=function(e){if(e<0||e>this.length){return null}var t;if(this.length===1){t=this.head;this.clear()}else{var i=this.get(e-1);if(i.next==this.tail){t=this.tail;this.tail=i}else{t=i.next;i.next=i.next.next}this.length--}return t};this.reverse=function(){var e=null;var t=this.head;var i=null;while(t){i=t.next;t.next=e;e=t;t=i}i=this.head;this.head=this.tail;this.tail=i};this.toArray=function(){var e=[];var t=this.head;while(t){e.push(t.element);t=t.next}return e};this.forEach=function(e){var t=this.head;while(t){e(t);t=t.next}return true};this.sort=function(e,t){if(this.length<2){return this}if(!e){e=Scule.global.functions.compare}var i=function(e){if(!e){return e}var t=e;var i=e;while(i.next&&i.next.next){t=t.next;i=i.next.next}return t};var n=function(i,n){var s={next:null};var r=s;var a;var u;while(i&&n){if(t){a=n.element[t];u=i.element[t]}else{a=n.element;u=i.element}if(e(a,u)>-1){r.next=i;i=i.next}else{r.next=n;n=n.next}r=r.next}r.next=!i?n:i;return s.next};var s=function(e){if(!e||!e.next){return e}var t=i(e);var r=t.next;t.next=null;return n(s(e),s(r))};this.head=s(this.head)}};Scule.datastructures.classes.DoublyLinkedList=function(){this.head=null;this.tail=null;this.length=0;this.getHead=function(){return this.head};this.getTail=function(){return this.tail};this.isEmpty=function(){return this.length===0};this.getLength=function(){return this.length};this.search=function(e,t,i){if(!i){i=Scule.global.functions.compare}var n=this.head;while(n){if(t){if(i(n.element[t],e)===0){break}}else{if(i(n.element,e)===0){break}}n=n.next}return n};this.contains=function(e,t){if(e===null){return false}if(!t){t=Scule.global.functions.compare}var i=this.head;while(i){if(t(i.element,e)===0){break}i=i.next}return i!==null};this.get=function(e){if(e<0||e>this.length){return null}if(e===0){return this.head}else{var t=this.head;var i=0;while(t){if(e==i){break}i++;t=t.next}return t}};this.add=function(e){var t=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,e);if(this.isEmpty()){this.head=t}else if(!this.tail){this.tail=t;this.tail.prev=this.head;this.head.next=t}else{var i=this.tail;i.next=t;t.prev=i;this.tail=t}this.length++;return t};this.remove=function(e){if(e<0||e>this.length){return null}var t;if(this.length===1){t=this.head;this.clear()}else{var i=this.get(e-1);if(i.next==this.tail){t=this.tail;this.tail=i;this.tail.prev=t.prev;this.tail.next=null}else{t=i.next;i.next=i.next.next;if(i.next){i.next.prev=i}}this.length--}if(t){t.detach()}return t};this.trim=function(){if(this.isEmpty()){return null}return this.remove(this.length-1)};this.split=function(e){var t;if(e===undefined){e=Math.floor(this.length/2);t=this.middle();if(!t){return null}}else{if(e<1||e>this.length){return null}t=this.get(e-1)}var i=new Scule.datastructures.classes.DoublyLinkedList;i.head=t.next;t.next=null;t.prev=null;i.tail=this.tail;this.tail=t;i.length=e;this.length=this.length-e;return i};this.middle=function(){if(!this.head){return null}var e=this.head;var t=this.head;while(t.next&&t.next.next){e=e.next;t=t.next.next}return e};this.sort=function(e,t){if(this.length<2){return this}if(!e){e=Scule.global.functions.compare}var i=function(e){if(!e){return e}var t=e;var i=e;while(i.next&&i.next.next){t=t.next;i=i.next.next}return t};var n=function(i,n){var s={next:null};var r=s;var a;var u;while(i&&n){if(t){a=n.element[t];u=i.element[t]}else{a=n.element;u=i.element}if(e(a,u)>-1){r.next=i;r.prev=n;i=i.next}else{r.next=n;r.prev=i;n=n.next}r=r.next}r.next=!i?n:i;return s.next};var s=function(e){if(!e||!e.next){return e}var t=i(e);var r=t.next;t.next=null;r.prev=null;return n(s(e),s(r))};this.head=s(this.head)};this.reverse=function(){var e=this.head;var t=null;while(e){t=e.next;e.next=e.prev;e.prev=t;e=t}t=this.head;this.head=this.tail;this.tail=t};this.prepend=function(e){var t=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,e);if(this.isEmpty()){this.head=t}else{var i=this.head;this.head=t;i.prev=this.head;this.head.next=i;if(!this.tail){this.tail=i}}this.length++;return t};this.clear=function(){this.head=null;this.tail=null;this.length=0};this.toArray=function(){var e=[];var t=this.head;while(t){e.push(t.element);t=t.next}return e};this.forEach=function(e){var t=this.head;while(t){e(t);t=t.next}return true}};Scule.datastructures.classes.CachingLinkedList=function(e,t,i){if(!t){throw"A valid cache key is required to use a CachingLinkedList"}if(!e){e=100}this.cacheKey=t;this.threshold=e;this.cache=new Scule.datastructures.classes.LRUCache(e);if(!i){i=new Scule.datastructures.classes.LinkedList}this.list=i;this.clear=function(){this.cache.clear();this.list.clear()};this.remove=function(e){var t=this.list.remove(e);if(t){this.cache.remove(t.element[this.cacheKey])}return t};this.middle=function(){return this.list.middle()};this.split=function(){this.cache.clear();return this.list.split()};this.add=function(e){var t=this.list.add(e);this.cache.put(t.element[this.cacheKey],t);return t};this.search=function(e){if(this.cache.contains(e)){return this.cache.get(e)}var t=this.list.search(e,this.cacheKey);if(t){this.cache.put(t.element[this.cacheKey],t)}return t};this.getLength=function(){return this.list.getLength()};this.getTail=function(){return this.list.getTail()};this.getHead=function(){return this.list.getHead()};this.isEmpty=function(){return this.list.isEmpty()};this.get=function(e){return this.list.get(e)};this.contains=function(e){return this.list.contains(e)};this.reverse=function(){this.list.reverse()};this.sort=function(e){this.list.sort(e,this.cacheKey)};this.toArray=function(){return this.list.toArray()};this.forEach=function(e){return this.list.forEach(e)}};Scule.datastructures.classes.LinkedListNode=function(e,t){this.next=e;this.element=t;this.getNext=function(){return this.next};this.setNext=function(e){this.next=e};this.getElement=function(){return this.element};this.setElement=function(e){this.element=e}};Scule.datastructures.classes.DoublyLinkedListNode=function(e,t,i){Scule.datastructures.classes.LinkedListNode.call(this,t,i);this.prev=e;this.getPrev=function(){return this.prev};this.setPrev=function(e){this.prev=e};this.detach=function(){this.prev=null;this.next=null}};Scule.datastructures.classes.LRUCache=function(e){this.threshold=e;this.cache=new Scule.datastructures.classes.HashTable;this.queue=new Scule.datastructures.classes.DoublyLinkedList;this.contains=function(e){return this.cache.contains(e)};this.remove=function(e){if(!this.cache.contains(e)){return null
}var t=this.cache.get(e);this.cache.remove(e);var i=t.node.prev;var n=t.node.next;if(i){i.next=n}if(n){n.prev=i}t.node.detach();this.queue.length--;return true};this.get=function(e){if(!this.cache.contains(e)){return null}var t=this.cache.get(e);t.requeue(this.queue);return t.value};this.put=function(e,t){var i;if(this.cache.contains(e)){i=this.cache.get(e);i.value=t;i.node.element={key:e,value:t};i.requeue(this.queue)}else{i=new Scule.datastructures.classes.LRUCacheEntry(e,t,this.queue.prepend({key:e,value:t}));this.cache.put(e,i)}if(this.queue.length>this.threshold){var n=this.queue.trim();if(!this.cache.remove(n.getElement().key)){throw"LRU cache is corrupt"}n=null}return true};this.getLength=function(){return this.cache.getLength()};this.clear=function(){this.cache.clear();this.queue.clear()}};Scule.datastructures.classes.LRUCacheEntry=function(e,t,i){this.key=e;this.value=t;this.node=i;this.getKey=function(){return this.key};this.getValue=function(){return this.value};this.getNode=function(){return this.node};this.requeue=function(e){if(!this.node.prev){return}var t=this.node.prev;var i=this.node.next;t.next=i;if(i){i.prev=t}this.node.detach();e.length--;this.node=e.prepend({key:this.key,value:this.value})}};Scule.datastructures.classes.LIFOStack=function(){Scule.datastructures.classes.LinkedList.call(this);this.push=function(e){var t=this.head;this.head=new Scule.datastructures.classes.LinkedListNode(t,e);this.length++};this.pop=function(){if(this.isEmpty()){return null}var e=this.head;this.head=e.next;this.length--;e.next=null;return e.getElement()};this.peek=function(){if(this.isEmpty()){return null}return this.head.getElement()}};Scule.datastructures.classes.FIFOStack=function(){Scule.datastructures.classes.LIFOStack.call(this);this.push=this.add;this.pop=function(){if(this.isEmpty()){return null}var e=this.head;this.head=e.next;this.length--;return e.getElement()}};Scule.datastructures.classes.Queue=function(){Scule.datastructures.classes.FIFOStack.call(this);this.enqueue=this.push;this.dequeue=this.pop};Scule.datastructures.classes.HashMap=function(e){this.size=e;this.buckets=0;this.length=0;this.table=[];this.hash=Scule.datastructures.variables.djb2_hash;this.retable=function(){var e=this.length/this.size;if(this.length>=this.buckets&&e<.7){return}var t=this.toArray();this.clear();this.size=this.size*2;for(var i=0;i<t.length;i++){this.put(t[i][0],t[i][1])}};this.bucket=function(e){if(!this.table[e]){this.buckets++;this.table[e]=new Scule.datastructures.classes.BinarySearchTree}return this.table[e]};this.put=function(e,t){var i=this.hash(e,this.size);var n=this.bucket(i);var s=n.insert(e,t);if(s){this.length++;if(n.getLength()%10===0){n.balance()}}this.retable();return s};this.contains=function(e){var t=this.hash(e,this.size);var i=this.bucket(t);return i.search(e)!==null};this.get=function(e){var t=this.hash(e,this.size);var i=this.bucket(t);var n=i.search(e);if(n===null){return null}return n.getData()};this.search=function(e){return this.get(e)};this.remove=function(e){var t=this.hash(e,this.size);var i=this.bucket(t);if(i.remove(e)){this.length--;this.retable();return true}else{return false}};this.clear=function(){this.table=[];this.length=0;this.buckets=0};this.getLength=function(){return this.length};this.getKeys=function(){var e=[];var t=function(i){if(i===null){return}e.push(i.getKey());t(i.getLeft());t(i.getRight())};this.table.forEach(function(e){if(!e){return}t(e.getRoot())});return e};this.getValues=function(){var e=[];var t=function(i){if(i===null){return}e.push(i.getData());t(i.getLeft());t(i.getRight())};this.table.forEach(function(e){if(!e){return}t(e.getRoot())});return e};this.toArray=function(){var e=[];this.table.forEach(function(t){if(!t){return}e=e.concat(t.toArray())});return e}};Scule.datastructures.classes.HashTable=function(){this.table={};this.length=0;this.put=function(e,t){if(!this.contains(e)){this.length++}this.table[e]=t};this.get=function(e){if(this.contains(e)){return this.table[e]}return null};this.search=function(e){return this.get(e)};this.remove=function(e){if(this.contains(e)){delete this.table[e];this.length--;return true}return false};this.contains=function(e){return e in this.table};this.clear=function(){this.table={};this.length=0};this.getLength=function(){return this.length};this.getKeys=function(){var e=[];for(var t in this.table){if(this.table.hasOwnProperty(t)){e.push(t)}}return e};this.getValues=function(){var e=[];for(var t in this.table){if(this.table.hasOwnProperty(t)){e.push(this.table[t])}}return e};this.toArray=function(){var e=[];for(var t in this.table){if(this.table.hasOwnProperty(t)){e[t]=this.table[t]}}return e}};Scule.datastructures.classes.BPlusTreeNode=function(){this.leaf=false;this.order=100;this.threshold=40;this.data=[];this.getOrder=function(){return this.order};this.setOrder=function(e){this.order=e};this.getMergeThreshold=function(){return this.threshold};this.setMergeThreshold=function(e){this.threshold=e};this.isLeaf=function(){return this.leaf}};Scule.datastructures.classes.BPlusTreeLeafNode=function(e,t){Scule.datastructures.classes.BPlusTreeNode.call(this);this.leaf=true;this.left=e;this.right=t;this.getRight=function(){return this.right};this.setRight=function(e){this.right=e};this.getLeft=function(){return this.left};this.setLeft=function(e){this.left=e};this.lookup=new Scule.datastructures.classes.LRUCache(Math.floor(this.threshold/2));this.search=function(e){var t=this.lookup.get(e);if(!t){t=this.sequentialSearch(e);if(t){this.lookup.put(t.key,t)}else{return null}}return t.value};this.sequentialSearch=function(e){var t=this.indexSearch(e);var i=this.data[t];if(t<this.data.length&&i.key==e){return i}return null};this.indexSearch=function(e){var t=this.data;if(t.length===0){return 0}var i=0;var n=this.data.length-1;var s=i+Math.floor((n-i)/2);var r=false;do{s=i+Math.floor((n-i)/2);if(t[s].key<e){i=s+1}else if(t[s].key>e){n=s}else{r=true}}while(i<n&&!r);if(r){return s}else{return n}};this.identifySiblings=function(e){var t={index:null,left:null,key:null,right:null};var i=this.getRight();var n=this.getLeft();var s=0;for(;s<e.data.length;s=s+2){var r=e.data[s];if(r==i){t.right=i;t.index=s-2;t.right_key=e.data[s-1];t.right_key_index=s-1}if(r==n){t.left=n;t.index=s+2;t.left_key=e.data[s+1];t.left_key_index=s+1}}if(t.index===null){t.index=s>=2?s-2:0}return t};this.getKeys=function(){var e=[];this.data.forEach(function(t){e.push(t.key)});return e};this.insert=function(e,t){var i=this.indexSearch(e);if(i==this.data.length){this.data.push({key:e,value:t})}else{var n=this.data[i];if(n.key==e){n.value=t}else if(n.key<e){this.data.splice(i+1,0,{key:e,value:t})}else{this.data.splice(i,0,{key:e,value:t})}}this.lookup.put(e,{key:e,value:t});return this.split()};this.remove=function(e,t){var i=this.indexSearch(e);var n=this.data[i];if(i<this.data.length&&n.key==e){this.data.splice(i,1);this.lookup.remove(e);if(!t){return null}return this.redistribute(e,t)}else{return null}};this.redistribute=function(e,t){if(this.data.length>this.threshold){return{operation:2,oldkey:e,key:this.data[0].key}}var i=this.identifySiblings(t);var n=this.threshold-this.data.length;var s,r;var a=false;if(i.left){s=i.left;r=i.left_key;a=true;if(s.data.length-n>=this.threshold){this.data=s.data.splice(n*-1,n).concat(this.data);this.lookup.clear();return{key:this.data[0].key,oldkey:i.left_key,index:i.left_key_index,operation:0}}}if(i.right){s=i.right;r=i.right_key;a=false;if(s.data.length-n>=this.threshold){this.data=this.data.concat(s.data.splice(0,n));this.lookup.clear();return{key:s.data[0].key,oldkey:i.right_key,index:i.right_key_index,operation:0}}}return this.merge(s,i.index,r,a)};this.merge=function(e,t,i,n){if(this.data.length>this.threshold){return null}if(!e){throw"Unable to merge - no siblings"}if(n){e.data=e.data.concat(this.data.splice(0,this.data.length));e.setRight(this.getRight());if(e.getRight()){e.getRight().setLeft(e)}e.lookup.clear();this.setLeft(null);this.setRight(null);return{left:true,index:t,node:e,key:e.data[0].key,oldkey:i,operation:1}}else{var s=this.data.splice(0,this.data.length);e.data=s.concat(e.data.splice(0,e.data.length));e.setLeft(this.getLeft());if(e.getLeft()){e.getLeft().setRight(e)}e.lookup.clear();this.setLeft(null);this.setRight(null);return{left:false,index:t,key:e.data[0].key,node:e,oldkey:i,operation:1}}};this.range=function(e,t,i,n){if(n===undefined){n=false}if(i===undefined){i=false}if(e===undefined){e=null}if(t===undefined){t=null}var s=this;var r=null;if(i&&n){r=function(e,t,i,n,s){if(e===null){if(i<=t){n=n.concat(s)}}else if(t===null){if(i>=e){n=n.concat(s)}}else{if(i>=e&&i<=t){n=n.concat(s)}}return n}}else if(i){r=function(e,t,i,n,s){if(e===null){if(i<t){n=n.concat(s)}}else if(t===null){if(i>=e){n=n.concat(s)}}else{if(i>=e&&i<t){n=n.concat(s)}}return n}}else{r=function(e,t,i,n,s){if(e===null){if(i<=t){n=n.concat(s)}}else if(t===null){if(i>e){n=n.concat(s)}}else{if(i>e&&i<=t){n=n.concat(s)}}return n}}var a=[];e:while(s){var u=s.data;var l=s.indexSearch(e);var c=t===null||t===undefined?u.length-1:s.indexSearch(t);if(c>=u.length){c=u.length-1}if(l<=u.length){for(var h=l;h<=c;h++){if(t!==null&&u[h].key>t){break e}a=r(e,t,u[h].key,a,u[h].value)}}s=s.getRight()}return a};this.split=function(){if(this.data.length<=this.order){return null}var e=Math.floor(this.data.length/2);var t=new Scule.datastructures.classes.BPlusTreeLeafNode(this.getLeft());t.setOrder(this.getOrder());t.setMergeThreshold(this.getMergeThreshold());t.data=this.data.splice(0,e);var i=new Scule.datastructures.classes.BPlusTreeLeafNode(null,this.getRight());i.setOrder(this.getOrder());i.setMergeThreshold(this.getMergeThreshold());i.data=this.data.splice(0,e+1);t.setRight(i);if(this.getLeft()){this.getLeft().setRight(t)}i.setLeft(t);if(this.getRight()){this.getRight().setLeft(i)}return{left:t,key:i.data[0].key,right:i}};this.toString=function(){return JSON.stringify(this.toArray(),null,"	")};this.toArray=function(){var e={type:"leaf"};for(var t=0;t<this.data.length;t++){e[t+":"+this.data[t].key]=this.data[t]}return e}};Scule.datastructures.classes.BPlusTreeInteriorNode=function(){Scule.datastructures.classes.BPlusTreeNode.call(this);this.nodeSearch=function(e){var t=this.data.length;for(var i=1;i<t;i=i+2){var n=this.data[i];if(n==e){return i+1}else if(n>=e){return i-1}}return t-1};this.indexSearch=function(e){var t=this.data.length;for(var i=1;i<t;i=i+2){var n=this.data[i];if(n==e){return i}else if(n>=e){return i}}return t-2};this.childSearch=function(e){if(this.data.length===0){return null}return this.data[this.nodeSearch(e)]};this.search=function(e){return this.childSearch(e).search(e)};this.range=function(e,t,i,n){return this.childSearch(e).range(e,t,i,n)};this.insert=function(e,t){var i=this.indexSearch(e);if(this.data[i]>e){i--}else{i++}var n=this.data[i];var s=n.insert(e,t);if(s){this.data.splice(i,1,s.left,s.key,s.right)}return this.split()};this.split=function(){var e=Math.floor((this.data.length-1)/2);if(e<this.order){return null}var t=Math.floor((this.data.length-1)/2);var i=new Scule.datastructures.classes.BPlusTreeInteriorNode(this.left,null);i.setOrder(this.order);i.setMergeThreshold(this.threshold);i.data=this.data.splice(0,t);var n=new Scule.datastructures.classes.BPlusTreeInteriorNode(null,this.right);n.setOrder(this.order);n.setMergeThreshold(this.threshold);n.data=this.data.splice(1,t);return{left:i,key:this.data[0],right:n}};this.remove=function(e,t){var i=this.indexSearch(e);var n=i;if(this.data[i]>e){n=i-1}else{n=i+1}var s=this.data[n];var r=s.remove(e,this);if(!r){return null}switch(r.operation){case 0:break;case 1:if(this.data.length==3){return r.node}var a=r.index;if(r.left){a=r.index-2}this.data.splice(a,3,r.node);break;case 2:var u=false;for(var l=1;l<this.data.length;l=l+2){if(this.data[l]==r.oldkey){this.data[l]=r.key;u=true}}if(!u){if(!t){return null}return r}break}this.reassignKeys();return this.merge(t,r.key,e)};this.reassignKeys=function(){for(var e=2;e<this.data.length;e=e+2){if(this.data[e].isLeaf()){this.data[e-1]=this.data[e].data[0].key}}};this.merge=function(e,t,i){if(!e){return null}var n=Math.floor((this.data.length-1)/2);if(n>=this.threshold-1){return{key:t,oldkey:i,operation:2}}var s,r,a;var u=false;var l=0;for(;l<e.data.length;l=l+2){if(e.data[l]==this){if(l===0||l<e.data.length-1){a=e.data[l+2];s=l+1}else{u=true;a=e.data[l-2];s=l-1}break}}r=e.data[s];var c=new Scule.datastructures.classes.BPlusTreeInteriorNode;c.setOrder(this.getOrder());c.setMergeThreshold(this.getMergeThreshold());if(u){c.data=a.data.splice(0,a.data.length);c.data=c.data.concat(r);c.data=c.data.concat(this.data.splice(0,this.data.length))}else{c.data=this.data.splice(0,this.data.length);c.data=c.data.concat(r);c.data=c.data.concat(a.data.splice(0,a.data.length))}return{left:u,node:c,index:l,oldkey:r,operation:1}};this.toString=function(){return JSON.stringify(this.toArray(),null,"	")};this.toArray=function(){var e={type:"interior"};var t=0;var i=1;while(i<this.data.length){e[i+":"+this.data[i]]={left:this.data[t].toArray(),right:this.data[t+2].toArray()};t=t+2;i=i+2}return e}};Scule.datastructures.classes.BPlusTree=function(e,t){if(!e){e=100}if(!t){t=Math.ceil(e/2)}this.order=e;this.threshold=t;this.root=new Scule.datastructures.classes.BPlusTreeLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold);this.insert=function(e,t){var i=this.root.insert(e,t);if(i){this.root=new Scule.datastructures.classes.BPlusTreeInteriorNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold);this.root.data.push(i.left);this.root.data.push(i.key);this.root.data.push(i.right)}return true};this.search=function(e){return this.root.search(e)};this.range=function(e,t,i,n){return this.root.range(e,t,i,n)};this.remove=function(e){var t=this.root.remove(e);if(t){this.root=t}return true};this.clear=function(){this.root=new Scule.datastructures.classes.BPlusTreeLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold)};this.toString=function(){return this.root.toString()};this.toArray=function(){return this.root.toArray()}};Scule.datastructures.classes.BinarySearchTreeNode=function(e,t){this.parent=null;this.left=null;this.right=null;this.key=e;this.data=t;this.setParent=function(e){this.parent=e};this.getParent=function(){return this.parent};this.setLeft=function(e){if(!e){return}this.left=e;this.left.setParent(this)};this.getLeft=function(){return this.left};this.setRight=function(e){if(!e){return}this.right=e;this.right.setParent(this)};this.getRight=function(){return this.right};this.getKey=function(){return this.key};this.setData=function(e){this.data=e};this.getData=function(){return this.data};this.clear=function(){this.data=null};this.remove=function(e){if(!e){return false}if(e==this.right){this.setRight(e.getRight());this.getRight().setLeft(e.getLeft());e.parent=null;e.left=null;e.right=null;return true}else if(e==this.left){this.setLeft(e.getRight());this.getLeft().setLeft(e.getLeft());e.parent=null;e.left=null;e.right=null;return true}return false}};Scule.datastructures.classes.AtomicCounter=function(e){if(e===undefined){e=0}if(!Scule.global.functions.isInteger(e)){throw"Unable to initialize counter with non-integer value"}this.count=e;this.increment=function(e){if(e===undefined){e=1}if(!Scule.global.functions.isInteger(e)){throw"Unable to increment counter with non-integer value"}this.count+=e;return this.count};this.decrement=function(e){if(e===undefined){e=1}if(!Scule.global.functions.isInteger(e)){throw"Unable to decrement counter with non-integer value"}this.count-=e;return this.count};this.getCount=function(){return this.count}};Scule.datastructures.classes.BinarySearchTree=function(){this.root=null;this.length=0;this.insert=function(e,t){var i=this;var n=new Scule.datastructures.classes.BinarySearchTreeNode(e,t);if(this.root===null){this.length++;this.root=n;return true}var s=function(e,t){if(e.getKey()==t.getKey()){t.setData(e.getData());return false}if(e.getKey()<=t.getKey()){if(!t.getLeft()){i.length++;t.setLeft(e)}else{s(e,t.getLeft())}}else{if(!t.getRight()){i.length++;t.setRight(e)}else{s(e,t.getRight())}}return true};return s(n,this.root)};this.search=function(e){var t=function(e,i){if(!i){return null}if(i.getKey()==e){return i}else if(i.getKey()>e){return t(e,i.getLeft())}else{return t(e,i.getRight())}};return t(e,this.root)};this.remove=function(e){var t=this.search(e);if(!t){return false}if(!t.getParent()){if(t.getRight()){this.root=t.getRight();this.root.setLeft(t.getLeft())}else if(t.getLeft()){this.root=t.getRight();this.root.setLeft(t.getLeft())}else{this.root=null}this.length--;return true}var i=t.getParent().remove(t);if(i){this.length--}return i};this.balance=function(){var e=this;var t=this.toArray();var i=function(t){var n=t;var s=t.splice(Math.ceil(t.length/2),t.length);var r=n.pop();e.insert(r[0],r[1]);if(n.length>0){i(n)}if(s.length>0){i(s)}};this.length=0;this.root=null;i(t)};this.getLength=function(){return this.length};this.toArray=function(){var e=function(t){if(!t){return[]}return e(t.getLeft()).concat([[t.getKey(),t.getData()]]).concat(e(t.getRight()))};return e(this.root)};this.getRoot=function(){return this.root}};Scule.datastructures.classes.BitSet=function(e){if(e===undefined||!Scule.global.functions.isInteger(e)||e<=0){throw"Unable to initialize bitset with non-integer capacity"}this.capacity=e;this.words=null;this.zeroFill=function(){this.words=[];var e=Math.ceil(this.capacity/32);for(var t=0;t<=e;t++){this.words[t]=0}};this.indexToAddress=function(e){if(e<0||e>=this.capacity){throw"Index out of bounds"}if(e<32){return{addr:0,offs:e}}var t=Math.floor(e/32);var i=e%32;return{addr:t,offs:i}};this.get=function(e){var t=this.indexToAddress(e);return(this.words[t.addr]&1<<t.offs)!=0};this.set=function(e){var t=this.indexToAddress(e);this.words[t.addr]|=1<<t.offs};this.clear=function(e){var t=this.indexToAddress(e);this.words[t.addr]&=~(1<<t.offs)};this.getLength=function(){return this.capacity};this.toString=function(){var e="";for(var t=0;t<this.capacity;t++){e+=this.get(t)?1:0}return e};this.zeroFill()};Scule.datastructures.classes.BloomFilter=function(e,t){if(e===undefined||!Scule.global.functions.isInteger(e)||e<=0){throw"Unable to initialize bloom filter with non-integer m"}if(t===undefined||!Scule.global.functions.isInteger(t)||t<=0){t=Math.floor(e/Math.ceil(e/3))}Scule.datastructures.classes.BitSet.call(this,e);this.k=t;this.f=[];for(var i=0;i<this.k;i++){this.f.push([Scule.global.functions.randomFromTo(0,999999),Scule.global.functions.randomFromTo(0,999999)])}this.hash=function(e,t,i){return Scule.datastructures.variables.fnv_hash(this.f[e][0]+t+this.f[e][1],i)};this.add=function(e){for(var t=0;t<this.k;t++){this.set(this.hash(t,e,this.capacity))}};this.query=function(e){for(var t=0;t<this.k;t++){if(!this.get(this.hash(t,e,this.capacity))){return false}}return true}};Scule.datastructures.classes.AtomicCounter=function(e){if(e===undefined){e=0}if(!Scule.global.functions.isInteger(e)){throw"Unable to initialize counter with non-integer value"}this.count=e;this.increment=function(e){if(e===undefined){e=1}if(!Scule.global.functions.isInteger(e)){throw"Unable to increment counter with non-integer value"}this.count+=e;return this.count};this.decrement=function(e){if(e===undefined){e=1}if(!Scule.global.functions.isInteger(e)){throw"Unable to decrement counter with non-integer value"}this.count-=e;return this.count};this.getCount=function(){return this.count}};Scule.getLinkedList=function(){return new Scule.datastructures.classes.LinkedList};Scule.getCachingLinkedList=function(e,t){return new Scule.datastructures.classes.CachingLinkedList(e,t)};Scule.getDoublyLinkedList=function(){return new Scule.datastructures.classes.DoublyLinkedList};Scule.getHashTable=function(){return new Scule.datastructures.classes.HashTable};Scule.getHashMap=function(e){return new Scule.datastructures.classes.HashMap(e)};Scule.getLIFOStack=function(){return new Scule.datastructures.classes.LIFOStack};Scule.getFIFOStack=function(){return new Scule.datastructures.classes.FIFOStack};Scule.getQueue=function(){return new Scule.datastructures.classes.Queue};Scule.getLRUCache=function(e){return new Scule.datastructures.classes.LRUCache(e)};Scule.getBPlusTree=function(e,t){return new Scule.datastructures.classes.BPlusTree(e,t)};Scule.getBPlusTreeNode=function(){return new Scule.datastructures.classes.BPlusTreeNode};Scule.getBPlusTreeLeafNode=function(e,t){return new Scule.datastructures.classes.BPlusTreeLeafNode(e,t)};Scule.getBPlusTreeInteriorNode=function(){return new Scule.datastructures.classes.BPlusTreeInteriorNode};Scule.getBinarySearchTreeNode=function(e,t){return new Scule.datastructures.classes.BinarySearchTreeNode(e,t)};Scule.getBinarySearchTree=function(){return new Scule.datastructures.classes.BinarySearchTree};Scule.getAtomicCounter=function(e){return new Scule.datastructures.classes.AtomicCounter(e)};Scule.getBitSet=function(e){return new Scule.datastructures.classes.BitSet(e)};Scule.getBloomFilter=function(e){return new Scule.datastructures.classes.BloomFilter(e)}})();(function(){"use strict";Scule.instrumentation.classes.Timer=function(){this.intervalCounter=0;this.intervalArray=[];this.intervals=Scule.getLIFOStack();this.resetTimer=function(){this.intervalCounter=0;this.intervalArray=[];this.intervals.clear()};this.startInterval=function(e){this.intervalCounter++;if(e===undefined){e=this.intervalCounter}this.intervals.push(new Scule.instrumentation.classes.TimerInterval(e));this.intervalArray.push(this.intervals.peek())};this.stopInterval=function(){if(this.intervals.isEmpty()){return false}this.intervals.peek().stop();return this.intervals.pop()};this.stopAllIntervals=function(){while(!this.intervals.isEmpty()){this.intervals.pop().stop()}};this.logToConsole=function(){this.intervalArray.forEach(function(e){e.logToConsole()})}};Scule.instrumentation.classes.TimerInterval=function(e){this.startTimestamp=(new Date).getTime();this.endTimestamp=null;this.tag=e;this.stopped=function(){return this.endTimestamp!==null};this.stop=function(){this.endTimestamp=(new Date).getTime()};this.getDifference=function(){if(this.endTimestamp===null){return false}return this.endTimestamp-this.startTimestamp};this.logToConsole=function(){var e=this.getDifference();if(e===false){console.log("interval "+this.tag+" is still in progress")}console.log("interval "+this.tag+" lasted "+e+"ms")}};Scule.getTimer=function(){return new Scule.instrumentation.classes.Timer}})();(function(){Scule.interpreter.symbols.table={$and:Scule.interpreter.arities.selective,$or:Scule.interpreter.arities.selective,$nor:Scule.interpreter.arities.negative,$not:Scule.interpreter.arities.negative,$lt:Scule.interpreter.arities.range,$lte:Scule.interpreter.arities.range,$gt:Scule.interpreter.arities.range,$gte:Scule.interpreter.arities.range,$all:Scule.interpreter.arities.array,$in:Scule.interpreter.arities.array,$nin:Scule.interpreter.arities.array,$elemMatch:Scule.interpreter.arities.array,$eq:Scule.interpreter.arities.binary,$ne:Scule.interpreter.arities.binary,$size:Scule.interpreter.arities.binary,$exists:Scule.interpreter.arities.binary,$within:Scule.interpreter.arities.geospatial,$near:Scule.interpreter.arities.geospatial,$set:Scule.interpreter.arities.mutate,$inc:Scule.interpreter.arities.mutate,$unset:Scule.interpreter.arities.mutate,$pull:Scule.interpreter.arities.mutate,$pullAll:Scule.interpreter.arities.mutate,$pop:Scule.interpreter.arities.mutate,$push:Scule.interpreter.arities.mutate,$pushAll:Scule.interpreter.arities.mutate,$rename:Scule.interpreter.arities.mutate};Scule.interpreter.classes.QueryNormalizer=function(){this.normalize=function(e){var t=function(e){for(var i in e){if(Scule.global.functions.isScalar(e[i])||e[i]instanceof RegExp){var n=e[i];delete e[i];e[i]={$eq:n}}else{if(i=="$or"||i=="$elemMatch"){t(e[i])}else{e[i]=Scule.global.functions.sortObjectKeys(e[i])}}}return Scule.global.functions.sortObjectKeys(e)};return t(e)}};Scule.interpreter.functions.intersection=function(e){if(e.length==1){return e[0]}var t=Scule.getHashTable();var i=null;e.forEach(function(e){if(!i||e.length<i.length){i=e}});if(!i){return[]}i.forEach(function(e){t.put(Scule.global.functions.getObjectId(e),{c:1,o:e})});var n=[];var s=e.length;for(var r=0;r<s;r++){if(e[r]==i){continue}var a=function(e){var i=t.get(Scule.global.functions.getObjectId(e));if(i){i.c++;if(i.c==s){n.push(e)}}};e[r].forEach(a)}return n};Scule.interpreter.classes.IndexSelector=function(){this.resolveIndices=function(e,t){var i=this.selectIndices(e,t);if(!i||!i.selected){return e.documents.table}return this.queryIndices(i,t)};this.buildHashIndexKey=function(e,t){var i=[];for(var n in e){if(!t.hasOwnProperty(n)){continue}i.push(t[n].$eq)}if(i.length==1){return i[0]}return i.join(",")};this.buildRangeIndexKey=function(e,t){var i=[null,null,false,false];var n=[];var s=[];for(var r in e){if(!t.hasOwnProperty(r)){continue}for(var a in t[r]){switch(a){case"$gt":n.push(t[r][a]);break;case"$gte":n.push(t[r][a]);i[2]=true;break;case"$lt":s.push(t[r][a]);break;case"$lte":s.push(t[r][a]);i[3]=true;break}}}if(n.length>0){if(n.length==1){i[0]=n[0]}else{i[0]=n.join(",")}}if(s.length>0){if(s.length==1){i[1]=s[0]}else{i[1]=s.join(",")}}return i};this.queryHashIndex=function(e,t){return e.$index.search(t)};this.queryRangeIndex=function(e,t,i,n,s){return e.$index.range(t,i,n,s)};this.queryIndices=function(e,t){var i=[];var n=null;var s=null;var r=null;for(n in e.range){r=e.range[n];s=this.buildRangeIndexKey(r.$attr,t);i.push(this.queryRangeIndex(r,s[0],s[1],s[2],s[3]))}for(n in e.exact){r=e.exact[n];s=this.buildHashIndexKey(r.$attr,t);i.push(this.queryHashIndex(r,s))}return Scule.interpreter.functions.intersection(i)};this.selectIndices=function(e,t){var i=Scule.getHashTable();var n=Scule.getHashTable();this.populateAttributes(t,i,n);i=i.getKeys().sort();n=n.getKeys().sort();if(i.length===0&&n.length===0){return}var s=null;var r=null;var a={range:{},exact:{},selected:false};var u=e.indices;for(var l=0;l<u.length;l++){var c=u[l];r=c.applies(i,true);if(r&&!r.$partial){s=JSON.stringify(r.$index.astrings.getKeys().sort());a.range[s]=r;a.selected=true}r=c.applies(n,false);if(r&&!r.$partial){s=JSON.stringify(r.$index.astrings.getKeys().sort());a.exact[s]=r;a.selected=true}}return a};this.populateAttributes=function(e,t,i){for(var n in e){for(var s in e[n]){if(!Scule.interpreter.symbols.table.hasOwnProperty(s)){continue}switch(Scule.interpreter.symbols.table[s]){case Scule.interpreter.arities.range:t.put(n,true);break;case Scule.interpreter.arities.operand:case Scule.interpreter.arities.binary:if(n=="$eq"){i.put(n,true)}break;case Scule.interpreter.arities.selective:throw"sub-expressions cannot use indexes";break}}}}};Scule.interpreter.classes.QueryEngine=function(){this.traverse=function(e,t){return Scule.global.functions.traverse(e,t)};this.traverseObject=function(e,t){return Scule.global.functions.traverseObject(Scule.global.functions.parseAttributes(e),t)};this.updateIndexes=function(e,t){t.indices.forEach(function(t){t.remove(e);t.index(e)})};this.$ne=function(e,t){return e!=t};this.$eq=function(e,t){if(t instanceof RegExp){return t.test(e)}else{return e==t}};this.$gt=function(e,t){return e>t};this.$gte=function(e,t){return e>=t};this.$lt=function(e,t){return e<t};this.$lte=function(e,t){return e<=t};this.$all=function(e,t){if(!Scule.global.functions.isArray(e)||!Scule.global.functions.isArray(t)){return false}var i=0;var n={};for(i=0;i<e.length;i++){n[e[i]]=true}for(i=0;i<t.length;i++){if(!n.hasOwnProperty(t[i])){return false}}return true};this.$in=function(e,t){for(var i=0;i<t.length;i++){if(t[i]==e){return true}}return false};this.$nin=function(e,t){for(var i=0;i<t.length;i++){if(t[i]==e){return false}}return true};this.$elemMatch=function(e,t){if(!Scule.global.functions.isArray(e)){return false}for(var i=0;i<e.length;i++){if(t(e[i])){return true}}return false};this.$size=function(e,t){if(!Scule.global.functions.isInteger(t)){return false}return Scule.global.functions.sizeOf(e)==t};this.$exists=function(e,t){if(t){return e!==undefined}return e===undefined};this.$within=function(e,t){if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lon")){return false}if(!t.hasOwnProperty("lat")||!t.hasOwnProperty("lon")){return false}var i=Math.sqrt(Math.pow(t.lat-e.lat,2)+Math.pow(t.lon-e.lon,2));return i<=t.distance};this.$near=function(e,t){if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lon")){return false}if(!t.hasOwnProperty("lat")||!t.hasOwnProperty("lon")){return false}var i=Math.acos(Math.sin(e.lat)*Math.sin(t.lat)+Math.cos(e.lat)*Math.cos(t.lat)*Math.cos(t.lon-e.lon))*6371;return i<=t.distance};this.$sort=function(e,t,i){Scule.global.functions.sort(e,t,i)};this.$set=function(e,t,i){var n=e[0];var s=e[1];if(!(n in s)){if(i===true){s[n]=t}}else{s[n]=t}};this.$unset=function(e,t,i){var n=e[0];var s=e[1];if(n in s){delete s[n]}};this.$inc=function(e,t,i){if(!Scule.global.functions.isInteger(t)){t=1}var n=e[0];var s=e[1];if(!(n in s)){if(i){s[n]=t}}else{if(Scule.global.functions.isInteger(s[n])||Scule.global.functions.isDouble(s[n])){s[n]+=t}}};this.$pull=function(e,t,i){var n=e[0];var s=e[1];if(n in s&&Scule.global.functions.isArray(s[n])){var r=[];for(var a=0;a<s[n].length;a++){if(s[n][a]!==t){r.push(s[n][a])}}s[n]=r}};this.$pullall=function(e,t,i){var n=e[0];var s=e[1];if(n in s&&Scule.global.functions.isArray(s[n])){if(!Scule.global.functions.isArray(t)){throw"the $pullAll operator requires an associated array as an operand"}var r=Scule.getHashTable();t.forEach(function(e){r.put(e,true)});for(var a=0;a<s[n].length;a++){if(r.contains(s[n][a])){s[n].splice(a,1);a--}}}};this.$pop=function(e,t,i){var n=e[0];var s=e[1];if(n in s&&Scule.global.functions.isArray(s[n])){s[n].pop()}};this.$push=function(e,t,i){var n=e[0];var s=e[1];if(!(n in s)&&i){s[n]=t}else{if(Scule.global.functions.isArray(s[n])){s[n].push(t)}}};this.$pushall=function(e,t,i){var n=e[0];var s=e[1];if(!(n in s)&&i){s[n]=t}else{if(!Scule.global.functions.isArray(t)){throw"the $pushAll operator requires an associated array as an operand"}if(Scule.global.functions.isArray(s[n])){s[n]=s[n].concat(t)}}}};Scule.interpreter.classes.QueryCompiler=function(){this.cache=Scule.getHashTable();this.engine=new Scule.interpreter.classes.QueryEngine;this.normalizer=new Scule.interpreter.classes.QueryNormalizer;this.compileConditions=function(e){var t="";for(var i in e){if(!e.hasOwnProperty(i)){continue}switch(i){case"$limit":t+="	if (r.length > "+e[i]+") {\n";t+="		r.splice("+e[i]+");\n";t+="	}\n";break;case"$sort":var n=e[i];var s=Scule.global.functions.objectKeys(n);if(s.length==1){t+="	engine.$sort("+n[s[0]]+', r, "'+s[0]+'");\n'}break}}return t};this.compileClauseList=function(e){var t=this;var i=[];if(!Scule.global.functions.isArray(e)){return i}e.forEach(function(e){var n=[];for(var s in e){if(!e.hasOwnProperty(s)){continue}n=n.concat(t.compileQueryClauses(s,e[s]))}i.push(n.join(" && "))});return i.join(" || ")};this.compileExpressions=function(e){e=this.normalizer.normalize(e);var t=[];for(var i in e){t=t.concat(this.compileQueryClauses(i,e[i]))}return t};this.compileQueryClauses=function(e,t){var i=[];for(var n in t){if(!this.engine.hasOwnProperty(n)){continue}if(n=="$elemMatch"){var s=this.compileExpressions(t[n]);var r="function(o) { return ("+s.join(" && ")+"); }";if(e.indexOf(".")<0){i.push("engine.$elemMatch(o."+e+", "+r+")")}else{i.push("engine.$elemMatch(engine.traverse("+JSON.stringify(e)+", o), "+r+")")}}else{if(e.indexOf(".")<0){var a=null;if(t[n]instanceof RegExp){a=t[n].toString()}else{a=JSON.stringify(t[n])}i.push("engine."+n+"(o."+e+", "+a+")")}else{i.push("engine."+n+"(engine.traverse("+JSON.stringify(e)+", o), "+a+")")}}}return i};this.compileUpdateClauses=function(e,t,i){var n=[];for(var s in t){if(!this.engine.hasOwnProperty(s)){continue}n.push("		engine."+s+"(engine.traverseObject("+JSON.stringify(e)+", o), "+JSON.stringify(t[s])+", "+JSON.stringify(i)+");")}return n};this.compileUpdate=function(e,t){var i=Scule.md5.hash(JSON.stringify(e));
if(this.cache.contains(i)){return this.cache.get(i)}var n=[];var s="var u = function(objects, collection, engine) {\n";s+="	objects.forEach(function(o) {\n";for(var r in e){if(!e.hasOwnProperty(r)){continue}n=n.concat(this.compileUpdateClauses(r,e[r],t))}s+=n.join("\n");s+="\n		engine.updateIndexes(o, collection);\n";s+="	});\n";s+="	return objects;\n";s+="}\n";this.cache.put(i,s);return s};this.compileQuery=function(e,t){e=this.normalizer.normalize(e);var i=Scule.md5.hash(JSON.stringify(e)+JSON.stringify(t));if(this.cache.contains(i)){return this.cache.get(i)}var n="var c = function(objects, engine) {\n";n+="	var r = [];\n";if(Scule.global.functions.sizeOf(e)>0){n+="	for (var k in objects) {\n";n+="		if (!objects.hasOwnProperty(k)) { continue; }\n";n+="		var o = objects[k];\n";var s=[];var r="";for(var a in e){if(!e.hasOwnProperty(a)){continue}if(a=="$or"){r="("+this.compileClauseList(e[a])+")"}else{s=s.concat(this.compileQueryClauses(a,e[a]))}}if(s.length>0){if(r.length>0){r=" && "+r}n+="		if (("+s.join(" && ")+")"+r+") {\n";n+="			r.push(o);\n";n+="		}\n"}else if(r.length>0){n+="		if ("+r+") {\n";n+="			r.push(o);\n";n+="		}\n"}n+="	};\n"}else{n+="	for (var k in objects) {\n";n+="		if (!objects.hasOwnProperty(k)) { continue; }\n";n+="		r.push(o[k]);\n";n+="	}\n"}if(t&&t.hasOwnProperty("$skip")){n+="	r.splice(0, "+t.$skip+");\n";delete t.$skip}if(t){n+=this.compileConditions(t)}n+="	return r;\n";n+="};\n";this.cache.put(i,n);return n};this.explainQuery=function(e,t){var i=this.compileQuery(e,t);console.log(i);return i};this.explainUpdate=function(e,t){var i=this.compileUpdate(e,t);console.log(i);return i}};Scule.interpreter.classes.QueryInterpreter=function(){this.indexer=new Scule.interpreter.classes.IndexSelector;this.compiler=new Scule.interpreter.classes.QueryCompiler;this.interpret=function(collection,query,conditions,explain){if(explain){return this.compiler.explainQuery(query,conditions)}var o=this.indexer.resolveIndices(collection,query);var src=this.compiler.compileQuery(query,conditions);eval(src);return c(o,Scule.interpreter.objects.engine)};this.update=function(collection,query,updates,conditions,upsert,explain){var o=this.interpret(collection,query,conditions,explain);if(explain){return this.compiler.explainUpdate(updates,upsert)}var src=this.compiler.compileUpdate(updates,upsert);eval(src);return u(o,collection,Scule.interpreter.objects.engine)}};Scule.interpreter.objects.engine=new Scule.interpreter.classes.QueryEngine;Scule.getQueryNormalizer=function(){return new Scule.interpreter.classes.QueryNormalizer};Scule.getIndexSelector=function(){return new Scule.interpreter.classes.IndexSelector};Scule.getQueryEngine=function(){return new Scule.interpreter.classes.QueryEngine};Scule.getQueryCompiler=function(){return new Scule.interpreter.classes.QueryCompiler};Scule.getQueryInterpreter=function(){return new Scule.interpreter.classes.QueryInterpreter}})();(function(){"use strict";Scule.db.classes.HashBucketTable=function(){Scule.datastructures.classes.HashTable.call(this);this.insert=function(e,t){var i;if(!this.contains(e)){i=Scule.getHashTable();i.put(Scule.global.functions.getObjectId(t),t);this.put(e,i)}else{i=this.get(e);i.put(Scule.global.functions.getObjectId(t),t)}return true}};Scule.db.classes.BPlusTreeHashingLeafNode=function(e,t){Scule.datastructures.classes.BPlusTreeLeafNode.call(this,e,t);this.insert=function(e,t){var i;var n=this.indexSearch(e);if(n==this.data.length){i=Scule.getHashTable();i.put(Scule.global.functions.getObjectId(t,true),t);this.data.push({key:e,value:i})}else{var s=this.data[n];if(s.key==e){s.value.put(Scule.global.functions.getObjectId(t,true),t)}else if(s.key<e){i=Scule.getHashTable();i.put(Scule.global.functions.getObjectId(t,true),t);this.data.splice(n+1,0,{key:e,value:i})}else{i=Scule.getHashTable();i.put(Scule.global.functions.getObjectId(t,true),t);this.data.splice(n,0,{key:e,value:i})}}if(i){this.lookup.put(e,{key:e,value:i})}return this.split()};this.split=function(){if(this.data.length<=this.order){return null}var e=Math.floor(this.data.length/2);var t=new Scule.db.classes.BPlusTreeHashingLeafNode(this.getLeft());t.setOrder(this.getOrder());t.setMergeThreshold(this.getMergeThreshold());t.data=this.data.splice(0,e);var i=new Scule.db.classes.BPlusTreeHashingLeafNode(null,this.getRight());i.setOrder(this.getOrder());i.setMergeThreshold(this.getMergeThreshold());i.data=this.data.splice(0,e+1);t.setRight(i);if(this.getLeft()){this.getLeft().setRight(t)}i.setLeft(t);if(this.getRight()){this.getRight().setLeft(i)}return{left:t,key:i.data[0].key,right:i}};this.range=function(e,t,i,n){if(n===undefined){n=false}if(i===undefined){i=false}if(e===undefined){e=null}if(t===undefined){t=null}var s=this;var r=null;if(i&&n){r=function(e,t,i,n,s){if(e===null){if(i<=t){n=n.concat(s)}}else if(t===null){if(i>=e){n=n.concat(s)}}else{if(i>=e&&i<=t){n=n.concat(s)}}return n}}else if(i){r=function(e,t,i,n,s){if(e===null){if(i<t){n=n.concat(s)}}else if(t===null){if(i>=e){n=n.concat(s)}}else{if(i>=e&&i<t){n=n.concat(s)}}return n}}else{r=function(e,t,i,n,s){if(e===null){if(i<=t){n=n.concat(s)}}else if(t===null){if(i>e){n=n.concat(s)}}else{if(i>e&&i<=t){n=n.concat(s)}}return n}}var a=[];e:while(s){var u=s.data;var l=s.indexSearch(e);var c=t===null||t===undefined?u.length-1:s.indexSearch(t);if(c>=u.length){c=u.length-1}if(l<=u.length){for(var h=l;h<=c;h++){if(t!==null&&u[h].key>t){break e}a=r(e,t,u[h].key,a,u[h].value.getValues())}}s=s.getRight()}return a};this.toArray=function(){var e={type:"hashing-leaf"};for(var t=0;t<this.data.length;t++){e[t+":"+this.data[t].key]=this.data[t].value}return e}};Scule.db.classes.BPlusHashingTree=function(e,t){Scule.datastructures.classes.BPlusTree.call(this,e,t);this.root=new Scule.db.classes.BPlusTreeHashingLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold);this.clear=function(){this.root=new Scule.db.classes.BPlusTreeHashingLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold)}};Scule.db.classes.Index=function(){this.attributes={};this.astrings=Scule.getHashTable();this.leaves=Scule.getHashTable();this.structure=null;this.type=null;this.setAttribtues=function(e){this.attributes=e;this.attributes=Scule.global.functions.sortObjectKeys(this.attributes)};this.parseAttributes=function(e){this.populateAttributeStrings(e);this.attributes=Scule.global.functions.parseAttributes(e);this.attributes=Scule.global.functions.sortObjectKeys(this.attributes)};this.populateAttributeStrings=function(e){var t=this;if(!Scule.global.functions.isArray(e)){e=e.split(",")}e.forEach(function(e){t.astrings.put(e,true)})};this.resetAttributes=function(){this.attributes={};this.clear()};this.getType=function(){return this.type};this.getName=function(){return this.astrings.getKeys().sort().join(",")};this.applies=function(e,t){if(t&&this.getType()==Scule.global.constants.INDEX_TYPE_HASH){return false}if(e.length<this.astrings.getLength()){return false}var i={$partial:false,$none:true,$range:t,$attr:{},$index:this};var n=this;e.forEach(function(e){if(n.astrings.contains(e)){i.$attr[e]=true;i.$none=false}else{if(!i.$partial){i.$partial=true}i.$attr[e]=false}});if(i.$none){return false}return i};this.generateIndexKey=function(e){var t=Scule.global.functions.searchObject(this.attributes,e);if(t.length===1){return t[0]}return t.join(",")};this.index=function(e){if(!this.structure){return false}var t=Scule.global.functions.getObjectId(e,true);var i=this.generateIndexKey(e);if(i.length==0){return false}this.structure.insert(i,e);var n=this.structure.search(i);this.leaves.put(t,{table:n,key:i});return true};this.remove=function(e){if(!this.structure){return false}var t=Scule.global.functions.getObjectId(e,true);if(!this.leaves.contains(t)){return false}var i=this.leaves.get(t);i.table.remove(t);if(i.table.getLength()===0){this.structure.remove(i.key)}return true};this.removeKey=function(e){if(!this.structure){return false}var t=this.structure.search(e);if(t&&t.length>0){this.structure.remove(e);for(var i in t.table){if(t.table.hasOwnProperty(i)){this.leaves.remove(Scule.global.functions.getObjectId(t.get(i),true))}}}return true};this.search=function(e){if(this.structure){var t=this.structure.search(e);if(t){return t.getValues()}}return[]};this.range=function(e,t,i,n){if(this.structure){return this.structure.range(e,t,i,n)}return false};this.clear=function(){if(this.structure){this.structure.clear();return true}return false};this.getLength=function(){return this.leaves.length}};Scule.db.classes.BPlusTreeIndex=function(e){Scule.db.classes.Index.call(this);if(!e){e=100}this.structure=new Scule.db.classes.BPlusHashingTree(e);this.type=Scule.global.constants.INDEX_TYPE_BTREE};Scule.db.classes.HashTableIndex=function(){Scule.db.classes.Index.call(this);this.structure=new Scule.db.classes.HashBucketTable;this.type=Scule.global.constants.INDEX_TYPE_HASH;this.range=function(e,t,i,n){throw"HashTable type indices to not support range query operations"}};Scule.db.classes.SimpleCryptographyProvider=function(){this.signString=function(e,t,i){return Scule.sha1.hash(Scule.sha1.hash(e+t)+i)};this.signObject=function(e,t,i){e._sig=i;return this.signString(JSON.stringify(e),t,i)};this.signJSONString=function(e,t,i){return this.signString(JSON.stringify(e),t,i)};this.verifyObjectSignature=function(e,t,i){var n=e._sig;var s=this.signObject(e,t,i);return n==s}};Scule.db.classes.StorageEngine=function(e){this.configuration=e;this.crypto=null;this.setConfiguration=function(e){this.configuration=e};this.getConfiguration=function(){return this.configuration};this.setCryptographyProvider=function(e){this.crypto=e};this.getCryptographyProvider=function(){return this.crypto};this.write=function(e,t,i){throw"function not implemented in abstract class"};this.read=function(e,t){throw"function not implemented in abstract class"}};Scule.db.classes.DummyStorageEngine=function(e){Scule.db.classes.StorageEngine.call(this,e);this.write=function(e,t,i){if(i){i(t)}};this.read=function(e,t){if(t){t()}}};Scule.db.classes.MemoryStorageEngine=function(e){Scule.db.classes.StorageEngine.call(this,e);this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider);this.storage={};this.write=function(e,t,i){if(!t._salt){t._salt=Scule.sha1.hash((new Date).getTime()+"")}t._sig=this.crypto.signObject(t,this.configuration.secret,t._salt);this.storage["__scule_collection__"+e]=JSON.stringify(t);if(i){i(t)}};this.read=function(e,t){if(!("__scule_collection__"+e in this.storage)){var i={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:2,_name:e,_objects:{}};i._sig=this.crypto.signObject(i,this.configuration.secret,i._salt);this.storage["__scule_collection__"+e]=JSON.stringify(i)}var n=this.storage["__scule_collection__"+e];var s=JSON.parse(n);if(this.crypto.verifyObjectSignature(s,this.configuration.secret,s._salt)===false){throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection})}delete s._sig;if(t){t(s)}}};Scule.db.classes.LocalStorageStorageEngine=function(e){Scule.db.classes.StorageEngine.call(this,e);this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider);if(!window||!window.hasOwnProperty("localStorage")&&window.localStorage!==null){throw JSON.stringify({event:"SculeLocalStorageError",message:"Local storage is not available on this device"})}this.write=function(e,t,i){if(!t._salt){t._salt=Scule.sha1.hash((new Date).getTime()+"")}try{t._sig=this.crypto.signObject(t,this.configuration.secret,t._salt);localStorage.setItem("__scule_collection__"+e,JSON.stringify(t));if(i){i(t)}}catch(n){throw JSON.stringify({event:"SculeLocalStorageError",message:"Storage quota exceeded for origin",collection:this.configuration.collection})}};this.read=function(e,t){var i=localStorage.getItem("__scule_collection__"+e);if(!i){throw JSON.stringify({event:"SculeLocalStorageError",message:"Unable to load collection from local storage",collection:this.configuration.collection})}var n=JSON.parse(i);if(this.crypto.verifyObjectSignature(n,this.configuration.secret,n._salt)===false){throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection})}delete n._sig;if(t){t(n)}}};Scule.db.classes.ObjectId=function(e){if(e===undefined){var t=Math.floor((new Date).getTime()/1e3).toString(16);var i=Scule.md5.hash(Scule.global.functions.getMACAddress()).substring(0,6);var n=Scule.global.functions.randomFromTo(1e3,9999).toString(16);while(n.length<4){n="0"+n}var s=Scule.global.functions.randomFromTo(1e5,999999).toString(16);while(s.length<6){s="0"+s}e=t+i+n+s}this.id=e;this.$type="id";this.toString=function(){return this.id.toString()}};Scule.db.classes.ObjectDate=function(e,t){if(e===undefined&&t===undefined){var i=(new Date).getTime().toString();e=parseInt(i.substring(0,10),10);t=parseInt(i.substring(10),10)}this.ts=parseInt(e+t,10);this.sec=e;this.usec=t;this.$type="date";this.getTimestamp=function(){return this.ts};this.getSeconds=function(){return this.sec};this.getMicroSeconds=function(){return this.usec}};Scule.db.classes.DBRef=function(e,t){if(e===undefined||t===undefined){throw"illegal object reference"}this.ref=e;this.id=new Scule.db.classes.ObjectId(t);this.$type="dbref";this.getRef=function(){return this.ref};this.getId=function(){return this.id};this.resolve=function(){return this.resolveReference()};this.resolveReference=function(){var e=Scule.factoryCollection(this.ref);return e.findOne(this.id)}};Scule.db.classes.Collection=function(e){this.documents=Scule.getHashTable();this.interpreter=Scule.getQueryInterpreter();this.version=2;this.lastId=null;this.name=e;this.autoCommit=false;this.isOpen=false;this.storage=null;this.indices=[];this.setStorageEngine=function(e){this.storage=e};this.ensureIndex=function(e,t,i){var n;switch(e){case Scule.global.constants.INDEX_TYPE_BTREE:if(!i){i={order:100}}n=new Scule.db.classes.BPlusTreeIndex(i.order);n.parseAttributes(t);break;case Scule.global.constants.INDEX_TYPE_HASH:n=new Scule.db.classes.HashTableIndex;n.parseAttributes(t);break}if(n){var s=false;var r=n.astrings.length;for(var a=0;a<this.indices.length;a++){if(r>this.indices[a].astrings.length){this.indices.splice(a,0,n);s=true;break}}if(!s){var u=this.findAll();u.forEach(function(e){n.index(e)});this.indices.push(n)}}};this.ensureBTreeIndex=function(e,t){this.ensureIndex(Scule.global.constants.INDEX_TYPE_BTREE,e,t)};this.ensureHashIndex=function(e,t){this.ensureIndex(Scule.global.constants.INDEX_TYPE_HASH,e,t)};this.setAutoCommit=function(e){this.autoCommit=e};this.getName=function(){return this.name};this.getLength=function(){return this.documents.getLength()};this.getLastInsertId=function(){return this.lastId};this.open=function(e){if(this.isOpen){return}var t=this;this.storage.read(this.name,function(i){if(!i){return}for(var n in i._objects){if(i._objects.hasOwnProperty(n)){var s=i._objects[n];Scule.db.functions.unflattenObject(i._objects[n]);t.documents.put(Scule.global.functions.getObjectId(s,true),s);for(var r=0;r<t.indices.length;r++){t.indices[r].index(s)}}}t.isOpen=true;if(e){e(this)}})};this.commit=function(e){var t={_sig:null,_salt:null,_name:this.name,_version:this.version,_objects:this.documents.table};this.storage.write(this.name,t,e)};this.find=function(e,t,i){if(Scule.global.constants.ID_FIELD in e){return[this.findOne(e[Scule.global.constants.ID_FIELD])]}var n=this.interpreter.interpret(this,e,t);if(i){i(n)}return n};this.explain=function(e,t,i){this.interpreter.interpret(this,e,t,true);if(i){i()}};this.clear=function(e){this.documents.clear();for(var t=0;t<this.indices.length;t++){this.indices[t].clear()}if(e){e(this)}};this.findAll=function(e){var t=[];for(var i in this.documents.table){if(this.documents.table.hasOwnProperty(i)){t.push(this.documents.get(i))}}if(e){e(t)}return t};this.findOne=function(e,t){if(!Scule.global.functions.isScalar(e)){e=e.toString()}var i=null;if(this.documents.contains(e)){i=this.documents.get(e)}if(t){t(i)}return i};this.save=function(e,t){Scule.db.functions.unflattenObject(e);this.documents.put(Scule.global.functions.getObjectId(e,true),e);for(var i=0;i<this.indices.length;i++){this.indices[i].remove(e);this.indices[i].index(e)}if(this.autoCommit){this.commit()}this.lastId=Scule.global.functions.getObjectId(e);if(t){t(this.lastId)}return this.lastId};this.update=function(e,t,i,n,s){var r=this.interpreter.update(this,e,t,i,n);if(s){s(r)}return r};this.count=function(e,t,i){var n=this.find(e,t).length;if(i){i(n)}return n};this.remove=function(e,t,i){var n=this;var s=this.find(e,t);s.forEach(function(e){n.documents.remove(Scule.global.functions.getObjectId(e));n.indices.forEach(function(t){t.remove(e)})});if(i){i(s)}return s};this.distinct=function(e,t,i){var n=this.find(t);var s={};n.forEach(function(t){if(!(t[e]in s)){s[t[e]]=0}s[t[e]]++});if(i){i(s)}return s};this.merge=function(e,t){if(!e){throw"the merge function requires a valid collection as a parameter"}var i=this;var n=e.findAll();n.forEach(function(e){if(!i.documents.contains(e._id)){i.documents.put(e._id,e)}});if(t){t(this)}return true};this.mapReduce=function(e,t,i,n){new Scule.db.classes.MapReduceHandler(e,t,i).run(this,n)}};Scule.db.classes.MapReduceHandler=function(e,t,i){this.options=i;if(!e){throw"A valid function is requires as the `map` parameter of the map/reduce operation"}if(!t){throw"A valid function is requires as the `reduce` parameter of the map/reduce operation"}if(!("out"in i)){throw"A valid output collection connection url is required as the `out` parameter of the map/reduce options object"}else{if(!("merge"in i.out)&&!("reduce"in i.out)){throw"A valid output collection connection url is required as either the `merge` or `reduce` out parameter of the map/reduce options object"}}if(!("query"in i)){i.query={}}if(!("conditions"in i)){i.conditions={}}this.map=e;this.reduce=t;this.finalize="finalize"in i?i.finalize:null;this.run=function(e,t){var i=this;var n="merge"in this.options.out;var s=Scule.factoryCollection(n?this.options.out.merge:this.options.out.reduce);var r=Scule.getHashTable();var a=function(e,t){if(!r.contains(e)){r.put(e,[])}r.get(e).push(t)};var u=e.find(this.options.query,this.options.conditions);u.forEach(function(e){i.map(e,a)});var l=null;if(n){l=Scule.factoryCollection("scule+dummy://__mr"+(new Date).getTime())}var c=Scule.getHashTable();var h=r.getKeys();h.forEach(function(e){c.put(e,i.reduce(e,r.get(e)));if(i.finalize){c.put(e,i.finalize(e,c.get(e)))}if(!n){s.save(c.get(e))}else{l.save(c.get(e))}});if(n){s.merge(l)}if(t){t(s)}return true}};Scule.db.classes.CollectionFactory=function(){this.collections=Scule.getHashTable();this.getCollection=function(e,t){if(this.collections.contains(e)){return this.collections.get(e).c}if(!t){t={secret:"dummy"}}var i=Scule.db.functions.parseCollectionURL(e);if(!(i.plugin in Scule.db.plugins)){throw i.plugin+" is not a registered Scule plugin"}if(!(i.engine in Scule.db.engines)){throw i.engine+" is nto a registered Scule storage engine"}var n=new Scule.db.engines[i.engine](t);var s=new Scule.db.plugins[i.plugin](i.name);s.setStorageEngine(n);s.open();this.collections.put(e,{c:s,t:(new Date).getTime()});return this.collections.get(e).c}};Scule.db.functions.debug=function(e){if(Scule.db.variables.debug===true){console.log(e)}};Scule.db.functions.unflattenObject=function(e){var t=function(e){if(Scule.global.functions.isScalar(e)){return}for(var i in e){if(e.hasOwnProperty(i)){var n=e[i];if(!Scule.global.functions.isScalar(n)&&n&&"$type"in n){switch(n.$type){case"date":e[i]=new Scule.db.classes.ObjectDate(n.sec,n.usec);e[i].ts=n.ts;break;case"id":e[i]=new Scule.db.classes.ObjectId(n.id);break;case"dbref":e[i]=new Scule.db.classes.DBRef(n.ref,n.id);break}}else{t(n)}}}};t(e);if(!(Scule.global.constants.ID_FIELD in e)){e[Scule.global.constants.ID_FIELD]=new Scule.db.classes.ObjectId}};Scule.db.functions.parseCollectionURL=function(e){var t=e.match(/^([^\+]*)\+([^\/]*)\:\/\/(.*)/);if(!t||t.length!=4){throw e+" is an invalid collection url"}return{plugin:t[1],engine:t[2],name:t[3]}};Scule.db.objects.core.collections.factory=new Scule.db.classes.CollectionFactory;Scule.debug=function(e){Scule.db.variables.debug=e};Scule.registerStorageEngine=function(e,t){if(e in Scule.db.engines){throw e+" storage engine is already registered"}Scule.db.engines[e]=t};Scule.registerCollectionPlugin=function(e,t){if(e in Scule.db.plugins){throw e+" collection plugin is already registered"}Scule.db.plugins[e]=t};(function(){Scule.registerStorageEngine("memory",Scule.db.classes.MemoryStorageEngine);Scule.registerStorageEngine("dummy",Scule.db.classes.DummyStorageEngine);Scule.registerStorageEngine("local",Scule.db.classes.LocalStorageStorageEngine);Scule.registerCollectionPlugin("scule",Scule.db.classes.Collection)})();Scule.factoryCollection=function(e){return Scule.db.objects.core.collections.factory.getCollection(e)};Scule.dropAll=function(){Scule.db.objects.core.collections.factory.collections.clear()};Scule.getIndex=function(){return new Scule.db.classes.Index};Scule.getHashTableIndex=function(e){return new Scule.db.classes.HashTableIndex(e)};Scule.getBPlusTreeIndex=function(e){return new Scule.db.classes.BPlusTreeIndex(e)};Scule.getObjectId=function(e){return new Scule.db.classes.ObjectId(e)};Scule.getObjectDate=function(e,t){return new Scule.db.classes.ObjectDate(e,t)};Scule.getDBRef=function(e,t){return new Scule.db.classes.DBRef(e,t)};Scule.getMemoryStorageEngine=function(e){return new Scule.db.classes.MemoryStorageEngine(e)};Scule.getLocalStorageDiskStorageEngine=function(e){return new Scule.db.classes.LocalStorageDiskStorageEngine(e)};Scule.getSimpleCryptographyProvider=function(){return new Scule.db.classes.SimpleCryptographyProvider};Scule.getBPlusHashingTree=function(e,t){return new Scule.db.classes.BPlusHashingTree(e,t)};Scule.getHashBucketTable=function(){return new Scule.db.classes.HashBucketTable}})();