if(Scule===void 0)var Scule={namespaces:{}};if(console===void 0)var console={log:function(){}};(function(){Scule.registerNamespace=function(t,e){if(t in Scule)throw"namespace "+t+" is already registered";Scule[t]=e},Scule.registerComponent=function(t,e,n,s){var i=Scule.require(t);if(!(e in i))throw"type "+e+" is not registered inside "+t+" namespace";i[e][n]=s},Scule.require=function(t){if(!(t in Scule))throw"namespace "+t+" has not been registered, require failed";return Scule[t]},Scule.registerNamespace("global",{constants:{ID_FIELD:"_id",REF_FIELD:"_ref",OBJECT_WILDCARD:"*"},classes:{},functions:{},variables:{debug:!1}}),Scule.registerNamespace("datastructures",{constants:Scule.require("global").constants,classes:{},variables:{},$f:Scule.require("global").functions}),Scule.registerNamespace("instrumentation",{constants:Scule.require("global").constants,classes:{}}),Scule.registerNamespace("interpreter",{functions:{},classes:{},objects:{},variables:{},symbols:{table:{}},arities:{expression:-1,logical:0,binary:1,selective:2,negative:3,range:4,mutate:5,array:6,geospatial:7,variable:8,operand:9,index:10},constants:Scule.require("global").constants,$f:Scule.require("global").functions,$d:Scule.require("datastructures")}),Scule.registerNamespace("db",{constants:Scule.require("global").constants,functions:{},classes:{},plugins:{},engines:{},objects:{core:{collections:{}}},$f:Scule.require("global").functions,$i:Scule.require("interpreter")}),Scule.registerNamespace("events",{functions:{},classes:{},objects:{},$d:Scule.require("datastructures")}),Scule.registerNamespace("messaging",{functions:{},classes:{},objects:{},$d:Scule.require("datastructures")})})(),function(){Scule.global.classes.sha1=function(){this.hexcase=0,this.b64pad="",this.hex_sha1=function(t){return this.rstr2hex(this.rstr_sha1(this.str2rstr_utf8(t)))},this.hash=function(t){return this.hex_sha1(t)},this.b64_sha1=function(t){return this.rstr2b64(this.rstr_sha1(this.str2rstr_utf8(t)))},this.any_sha1=function(t,e){return this.rstr2any(this.rstr_sha1(this.str2rstr_utf8(t)),e)},this.hex_hmac_sha1=function(t,e){return this.rstr2hex(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)))},this.b64_hmac_sha1=function(t,e){return this.rstr2b64(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)))},this.any_hmac_sha1=function(t,e,n){return this.rstr2any(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)),n)},this.sha1_vm_test=function(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==this.hex_sha1("abc").toLowerCase()},this.rstr_sha1=function(t){return this.binb2rstr(this.binb_sha1(this.rstr2binb(t),8*t.length))},this.rstr_hmac_sha1=function(t,e){var n=this.rstr2binb(t);n.length>16&&(n=this.binb_sha1(n,8*t.length));for(var s=Array(16),i=Array(16),r=0;16>r;r++)s[r]=909522486^n[r],i[r]=1549556828^n[r];var a=this.binb_sha1(s.concat(this.rstr2binb(e)),512+8*e.length);return this.binb2rstr(this.binb_sha1(i.concat(a),672))},this.rstr2hex=function(t){this.hexcase=0;for(var e,n=this.hexcase?"0123456789ABCDEF":"0123456789abcdef",s="",i=0;t.length>i;i++)e=t.charCodeAt(i),s+=n.charAt(15&e>>>4)+n.charAt(15&e);return s},this.rstr2b64=function(t){this.b64pad="";for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="",s=t.length,i=0;s>i;i+=3)for(var r=t.charCodeAt(i)<<16|(s>i+1?t.charCodeAt(i+1)<<8:0)|(s>i+2?t.charCodeAt(i+2):0),a=0;4>a;a++)n+=8*i+6*a>8*t.length?this.b64pad:e.charAt(63&r>>>6*(3-a));return n},this.rstr2any=function(t,e){var n,s,i,r,a=e.length,u=[],c=Array(Math.ceil(t.length/2));for(n=0;c.length>n;n++)c[n]=t.charCodeAt(2*n)<<8|t.charCodeAt(2*n+1);for(;c.length>0;){for(r=[],i=0,n=0;c.length>n;n++)i=(i<<16)+c[n],s=Math.floor(i/a),i-=s*a,(r.length>0||s>0)&&(r[r.length]=s);u[u.length]=i,c=r}var o="";for(n=u.length-1;n>=0;n--)o+=e.charAt(u[n]);var l=Math.ceil(8*t.length/(Math.log(e.length)/Math.log(2)));for(n=o.length;l>n;n++)o=e[0]+o;return o},this.str2rstr_utf8=function(t){for(var e,n,s="",i=-1;++i<t.length;)e=t.charCodeAt(i),n=t.length>i+1?t.charCodeAt(i+1):0,e>=55296&&56319>=e&&n>=56320&&57343>=n&&(e=65536+((1023&e)<<10)+(1023&n),i++),127>=e?s+=String.fromCharCode(e):2047>=e?s+=String.fromCharCode(192|31&e>>>6,128|63&e):65535>=e?s+=String.fromCharCode(224|15&e>>>12,128|63&e>>>6,128|63&e):2097151>=e&&(s+=String.fromCharCode(240|7&e>>>18,128|63&e>>>12,128|63&e>>>6,128|63&e));return s},this.str2rstr_utf16le=function(t){for(var e="",n=0;t.length>n;n++)e+=String.fromCharCode(255&t.charCodeAt(n),255&t.charCodeAt(n)>>>8);return e},this.str2rstr_utf16be=function(t){for(var e="",n=0;t.length>n;n++)e+=String.fromCharCode(255&t.charCodeAt(n)>>>8,255&t.charCodeAt(n));return e},this.rstr2binb=function(t){var e=Array(t.length>>2),n=null;for(n=0;e.length>n;n++)e[n]=0;for(n=0;8*t.length>n;n+=8)e[n>>5]|=(255&t.charCodeAt(n/8))<<24-n%32;return e},this.binb2rstr=function(t){for(var e="",n=0;32*t.length>n;n+=8)e+=String.fromCharCode(255&t[n>>5]>>>24-n%32);return e},this.binb_sha1=function(t,e){t[e>>5]|=128<<24-e%32,t[(e+64>>9<<4)+15]=e;for(var n=Array(80),s=1732584193,i=-271733879,r=-1732584194,a=271733878,u=-1009589776,c=0;t.length>c;c+=16){for(var o=s,l=i,h=r,f=a,g=u,d=0;80>d;d++){n[d]=16>d?t[c+d]:this.bit_rol(n[d-3]^n[d-8]^n[d-14]^n[d-16],1);var S=this.safe_add(this.safe_add(this.bit_rol(s,5),this.sha1_ft(d,i,r,a)),this.safe_add(this.safe_add(u,n[d]),this.sha1_kt(d)));u=a,a=r,r=this.bit_rol(i,30),i=s,s=S}s=this.safe_add(s,o),i=this.safe_add(i,l),r=this.safe_add(r,h),a=this.safe_add(a,f),u=this.safe_add(u,g)}return Array(s,i,r,a,u)},this.sha1_ft=function(t,e,n,s){return 20>t?e&n|~e&s:40>t?e^n^s:60>t?e&n|e&s|n&s:e^n^s},this.sha1_kt=function(t){return 20>t?1518500249:40>t?1859775393:60>t?-1894007588:-899497514},this.safe_add=function(t,e){var n=(65535&t)+(65535&e),s=(t>>16)+(e>>16)+(n>>16);return s<<16|65535&n},this.bit_rol=function(t,e){return t<<e|t>>>32-e}},Scule.getSHA1=function(){return new Scule.global.classes.sha1},Scule.sha1=Scule.getSHA1()}(),function(){Scule.global.classes.md5=function(){this.md5cycle=function(t,e){var n=t[0],s=t[1],i=t[2],r=t[3];n=this.ff(n,s,i,r,e[0],7,-680876936),r=this.ff(r,n,s,i,e[1],12,-389564586),i=this.ff(i,r,n,s,e[2],17,606105819),s=this.ff(s,i,r,n,e[3],22,-1044525330),n=this.ff(n,s,i,r,e[4],7,-176418897),r=this.ff(r,n,s,i,e[5],12,1200080426),i=this.ff(i,r,n,s,e[6],17,-1473231341),s=this.ff(s,i,r,n,e[7],22,-45705983),n=this.ff(n,s,i,r,e[8],7,1770035416),r=this.ff(r,n,s,i,e[9],12,-1958414417),i=this.ff(i,r,n,s,e[10],17,-42063),s=this.ff(s,i,r,n,e[11],22,-1990404162),n=this.ff(n,s,i,r,e[12],7,1804603682),r=this.ff(r,n,s,i,e[13],12,-40341101),i=this.ff(i,r,n,s,e[14],17,-1502002290),s=this.ff(s,i,r,n,e[15],22,1236535329),n=this.gg(n,s,i,r,e[1],5,-165796510),r=this.gg(r,n,s,i,e[6],9,-1069501632),i=this.gg(i,r,n,s,e[11],14,643717713),s=this.gg(s,i,r,n,e[0],20,-373897302),n=this.gg(n,s,i,r,e[5],5,-701558691),r=this.gg(r,n,s,i,e[10],9,38016083),i=this.gg(i,r,n,s,e[15],14,-660478335),s=this.gg(s,i,r,n,e[4],20,-405537848),n=this.gg(n,s,i,r,e[9],5,568446438),r=this.gg(r,n,s,i,e[14],9,-1019803690),i=this.gg(i,r,n,s,e[3],14,-187363961),s=this.gg(s,i,r,n,e[8],20,1163531501),n=this.gg(n,s,i,r,e[13],5,-1444681467),r=this.gg(r,n,s,i,e[2],9,-51403784),i=this.gg(i,r,n,s,e[7],14,1735328473),s=this.gg(s,i,r,n,e[12],20,-1926607734),n=this.hh(n,s,i,r,e[5],4,-378558),r=this.hh(r,n,s,i,e[8],11,-2022574463),i=this.hh(i,r,n,s,e[11],16,1839030562),s=this.hh(s,i,r,n,e[14],23,-35309556),n=this.hh(n,s,i,r,e[1],4,-1530992060),r=this.hh(r,n,s,i,e[4],11,1272893353),i=this.hh(i,r,n,s,e[7],16,-155497632),s=this.hh(s,i,r,n,e[10],23,-1094730640),n=this.hh(n,s,i,r,e[13],4,681279174),r=this.hh(r,n,s,i,e[0],11,-358537222),i=this.hh(i,r,n,s,e[3],16,-722521979),s=this.hh(s,i,r,n,e[6],23,76029189),n=this.hh(n,s,i,r,e[9],4,-640364487),r=this.hh(r,n,s,i,e[12],11,-421815835),i=this.hh(i,r,n,s,e[15],16,530742520),s=this.hh(s,i,r,n,e[2],23,-995338651),n=this.ii(n,s,i,r,e[0],6,-198630844),r=this.ii(r,n,s,i,e[7],10,1126891415),i=this.ii(i,r,n,s,e[14],15,-1416354905),s=this.ii(s,i,r,n,e[5],21,-57434055),n=this.ii(n,s,i,r,e[12],6,1700485571),r=this.ii(r,n,s,i,e[3],10,-1894986606),i=this.ii(i,r,n,s,e[10],15,-1051523),s=this.ii(s,i,r,n,e[1],21,-2054922799),n=this.ii(n,s,i,r,e[8],6,1873313359),r=this.ii(r,n,s,i,e[15],10,-30611744),i=this.ii(i,r,n,s,e[6],15,-1560198380),s=this.ii(s,i,r,n,e[13],21,1309151649),n=this.ii(n,s,i,r,e[4],6,-145523070),r=this.ii(r,n,s,i,e[11],10,-1120210379),i=this.ii(i,r,n,s,e[2],15,718787259),s=this.ii(s,i,r,n,e[9],21,-343485551),t[0]=this.add32(n,t[0]),t[1]=this.add32(s,t[1]),t[2]=this.add32(i,t[2]),t[3]=this.add32(r,t[3])},this.cmn=function(t,e,n,s,i,r){return e=this.add32(this.add32(e,t),this.add32(s,r)),this.add32(e<<i|e>>>32-i,n)},this.ff=function(t,e,n,s,i,r,a){return this.cmn(e&n|~e&s,t,e,i,r,a)},this.gg=function(t,e,n,s,i,r,a){return this.cmn(e&s|n&~s,t,e,i,r,a)},this.hh=function(t,e,n,s,i,r,a){return this.cmn(e^n^s,t,e,i,r,a)},this.ii=function(t,e,n,s,i,r,a){return this.cmn(n^(e|~s),t,e,i,r,a)},this.md51=function(t){/[\x80-\xFF]/.test(t)&&(t=unescape(encodeURI(t)));var e,n=t.length,s=[1732584193,-271733879,-1732584194,271733878];for(e=64;t.length>=e;e+=64)this.md5cycle(s,this.md5blk(t.substring(e-64,e)));t=t.substring(e-64);var i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;t.length>e;e++)i[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(i[e>>2]|=128<<(e%4<<3),e>55)for(this.md5cycle(s,i),e=0;16>e;e++)i[e]=0;return i[14]=8*n,this.md5cycle(s,i),s},this.md5blk=function(t){var e,n=[];for(e=0;64>e;e+=4)n[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return n},this.hex_chr="0123456789abcdef".split(""),this.rhex=function(t){for(var e="",n=0;4>n;n++)e+=this.hex_chr[15&t>>8*n+4]+this.hex_chr[15&t>>8*n];return e},this.hex=function(t){for(var e=0;t.length>e;e++)t[e]=this.rhex(t[e]);return t.join("")},this.hash=function(t){return this.hex(this.md51(t))},this.add32=function(t,e){return 4294967295&t+e}},Scule.getMD5=function(){return new Scule.global.classes.md5},"5d41402abc4b2a76b9719d911017c592"!=Scule.getMD5().hash("hello")&&(Scule.global.classes.md5.add32=function(t,e){var n=(65535&t)+(65535&e),s=(t>>16)+(e>>16)+(n>>16);return s<<16|65535&n}),Scule.md5=Scule.getMD5()}(),function(){Scule.global.functions.hasOwnProperty=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},Scule.global.functions.extractTrueValues=function(t){var e={};for(var n in t)if(Scule.global.functions.hasOwnProperty(t,n)){if(n.match(/^\$/))continue;t[n]&&(e[n]=!0)}return e},Scule.global.functions.pushIfNotNull=function(t,e){e&&t.push(e)},Scule.global.functions.pushIfExists=function(t,e,n){n in e&&t.push(e[n])},Scule.global.functions.getObjectAttribute=function(t,e,n){return e in t?t[e]:n},Scule.global.functions.getObjectId=function(t,e){return void 0===e&&(e=!1),e?""+t[Scule.global.constants.ID_FIELD]:t[Scule.global.constants.ID_FIELD]},Scule.global.functions.cloneObject=function(t){var e={};Scule.global.functions.isArray(t)&&(e=[]);for(var n in t)e[n]="object"==typeof t[n]?t[n]instanceof RegExp?RegExp(""+t[n]):Scule.global.functions.cloneObject(t[n]):t[n];return e},Scule.global.functions.traverseObject=function(t,e){var n=0,s=null,i=function(t){for(var e in t)if(Scule.global.functions.hasOwnProperty(t,e)){if(t[e]===!0){s=e;break}n++,i(t[e])}};i(t);var r=0,a=function(t,e){if(r==n)return e;for(var s in t)if(Scule.global.functions.hasOwnProperty(t,s))return Scule.global.functions.hasOwnProperty(e,s)?t[s]===!0?e:(r++,a(t[s],e[s])):null};return[s,a(t,e)]},Scule.global.functions.sortObjectKeys=function(t){var e={},n=[];for(var s in t)Scule.global.functions.hasOwnProperty(t,s)&&n.push(s);return n.sort(function(t,e){var n=!1;t.match(/^\$/)&&(t=t.substr(1),n=!0);var s=!1;return e.match(/^\$/)&&(e=e.substr(1),s=!0),n&&!s?1:s&&!n?-1:e>t?-1:t>e?1:0}),n.forEach(function(n){e[n]=t[n]}),e},Scule.global.functions.objectValues=function(t){var e=[];for(var n in t)Scule.global.functions.hasOwnProperty(t,n)&&e.push(t[n]);return e},Scule.global.functions.objectKeys=function(t){var e=[];for(var n in t)Scule.global.functions.hasOwnProperty(t,n)&&e.push(n);return e},Scule.global.functions.sizeOf=function(t){if(t instanceof Array||"string"==typeof t)return t.length;var e,n=0;for(e in t)Scule.global.functions.hasOwnProperty(t,e)&&n++;return n},Scule.global.functions.shuffle=function(t){var e,n,s=t.length;if(s)for(;--s;)n=Math.floor(Math.random()*(s+1)),e=t[n],t[n]=t[s],t[s]=e},Scule.global.functions.unique=function(t){for(var e={},n=0;t.length>n;n++)e[t[n]]=!0;var s=[];for(var i in e)e.hasOwnProperty(i)&&s.push(i);return s},Scule.global.functions.contains=function(t,e){return Scule.global.functions.hasOwnProperty(t,e)},Scule.global.functions.stringify=function(t){var e={};for(var n in t)e[n]="function"==typeof t[n]?""+t[n]:t[n];return JSON.stringify(e)},Scule.global.functions.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},Scule.global.functions.isInteger=function(t){return parseInt(t,10)==t},Scule.global.functions.isDouble=function(t){return parseFloat(t)==t},Scule.global.functions.isScalar=function(t){return null!==t&&!(t instanceof Object)},Scule.global.functions.randomFromTo=function(t,e){return Math.floor(Math.random()*(e-t+1)+t)},Scule.global.functions.compare=function(t,e){return t===e?0:t>e?1:-1},Scule.global.functions.compareElementKey=function(t,e){return Scule.global.functions.compare(t.key,e.key)},Scule.global.functions.compareElementValue=function(t,e){return Scule.global.functions.compare(t.value,e.value)},Scule.global.functions.compareArray=function(t,e){if(!Scule.global.functions.isArray(t)&&Scule.global.functions.isArray(e))return 1;if(Scule.global.functions.isArray(t)&&!Scule.global.functions.isArray(e))return-1;if(t.length>e.length)return 1;if(e.length>t.length)return-1;for(var n=!0,s=0,i=t.length,r=0;i>r;r++)s+=Scule.global.functions.isArray(t[r])?Scule.global.functions.compareArray(t[r],e[r]):Scule.global.functions.compare(t[r],e[r]),0!==s&&(n=!1);return 0!==s||n||(s=JSON.stringify(t[0]).localeCompare(JSON.stringify(e[0]))),s>0?s=1:0>s&&(s=-1),s},Scule.global.functions.sort=function(t,e,n){switch(t){case-1:e.sort(function(t,e){return e[n]-t[n]});break;case 0:Scule.global.functions.shuffle(e);break;case 1:e.sort(function(t,e){return t[n]-e[n]});break;case 2:e.sort(function(t,e){return e[n]>t[n]?-1:e[n]<t[n]?1:0});break;case 3:e.sort(function(t,e){return e[n]<t[n]?-1:e[n]>t[n]?1:0})}},Scule.global.functions.trim=function(t){return String.prototype.trim?t.trim():t.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},Scule.global.functions.getMACAddress=function(){return Scule.global.variables.hasOwnProperty("SimulatedMacAddress")||(Scule.global.variables.SimulatedMacAddress=(""+(new Date).getTime()).substring(9,11)+""+Scule.global.functions.randomFromTo(100,999)),Scule.global.variables.SimulatedMacAddress},Scule.global.functions.parseAttributes=function(t){if(!Scule.global.functions.isArray(t))return Scule.global.functions.parseAttributes(t.split(","));var e=function(t,n,s){var i=Scule.global.functions.trim(n[s]);if(s==n.length-1)t[i]=!0;else{var r={};t[i]=r,e(r,n,s+1)}},n={};return t.forEach(function(t){e(n,t.split("."),0)}),n},Scule.global.functions.searchObject=function(t,e){var n=function(t,e,s){if(e)for(var i in t)t[i]===!0?Scule.global.functions.isInteger(i)&&Scule.global.functions.isArray(e)?s.push(e[i]):i in e&&s.push(e[i]):i in e&&!Scule.global.functions.isScalar(e[i])&&n(t[i],e[i],s)},s=[];return n(t,e,s),s},Scule.global.functions.traverse=function(t,e){var n=function(t,e){if(void 0===e)return void 0;if(1===t.length)return e[t.pop()];var s=t.shift();return n(t,e[s])};return n(t.split("."),e)}}(),function(){Scule.events.classes.Event=function(t,e){this.name=t,this.body=e,this.getName=function(){return this.name},this.getBody=function(){return this.body}},Scule.events.classes.EventEmitter=function(){this.listeners=Scule.getHashTable(),this.createBucket=function(t){this.listeners.contains(t)||this.listeners.put(t,[])},this.addEventListener=function(t,e){e instanceof Scule.events.classes.EventListener||(e=new Scule.events.classes.EventListener(e)),this.createBucket(t);var n=this.listeners.get(t);n.push(e)},this.removeEventListener=function(t,e){this.createBucket(t),e instanceof Scule.events.classes.EventListener&&(e=e.getClosure());for(var n=this.listeners.get(t),s=[],i=0;n.length>i;i++)n[i].getClosure()!=e&&s.push(e);this.listeners.put(t,s)},this.removeEventListeners=function(t){this.listeners.remove(t)},this.fireEvent=function(t,e){this.createBucket(t),e instanceof Scule.events.classes.Event||(e=new Scule.events.classes.Event(t,e));var n=this.listeners.get(t);n.forEach(function(t){t.consume(e)})}},Scule.events.classes.EventListener=function(t){this.closure=t,this.consume=function(t){this.closure(t)},this.getClosure=function(){return this.closure}},Scule.getEventListener=function(t){return new Scule.events.classes.EventListener(t)},Scule.getEventEmitter=function(){return new Scule.events.classes.EventEmitter},Scule.getEvent=function(t,e){return new Scule.events.classes.Event(t,e)}}(),function(){Scule.messaging.classes.Message=function(t,e){this.key=t,this.body=e,this.getKey=function(){return this.key},this.getBody=function(){return this.body}},Scule.messaging.classes.MessageQueue=function(t){this.name=t,this.subscribers=[],Scule.datastructures.classes.Queue.call(this),this.getName=function(){return this.name},this.addSubscriber=function(t){this.subscribers.push(t)},this.getSubscribers=function(){return this.subscribers},this.removeSubscribers=function(){this.subscribers=[]}},Scule.messaging.classes.MessageExchange=function(t){this.name=t,this.queues=Scule.getHashTable(),this.getName=function(){return this.name},this.addQueue=function(e,n){if(!(e instanceof Scule.messaging.classes.MessageQueue))throw"provided object is not a messge queue";if(this.queues.contains(e.getName()))throw"exchange "+t+" is already bound to queue "+e.getName();return this.queues.put(e.getName(),e),this.addRoute(e,n),!0},this.addRoute=function(){return!0},this.removeQueue=function(t){return this.queues.contains(t.getName())?(this.queues.remove(t.getName()),this.removeRoute(t),!0):!1},this.removeRoute=function(){return!0},this.route=function(){throw"routing is not supported in abstract exchange class"}},Scule.messaging.classes.FanOutMessageExchange=function(t){Scule.messaging.classes.MessageExchange.call(this,t),this.route=function(t){var e=this,n=this.queues.getKeys();n.forEach(function(n){e.queues.get(n).enqueue(t)})}},Scule.messaging.classes.DirectMessageExchange=function(t){this.routes=Scule.getHashTable(),Scule.messaging.classes.MessageExchange.call(this,t),this.addRoute=function(t,e){var n=Scule.md5.hash(""+e);this.routes.contains(n)||this.routes.put(n,{key:e,queues:[]}),this.routes.get(n).queues.push(t)},this.removeRoute=function(t){var e=this,n=this.routes.getKeys();n.forEach(function(n){for(var s=e.routes.get(n),i=s.queues.length;i--;)s.queues[i]==t&&s.queues.splice(i,1)})},this.route=function(t){var e=this,n=this.routes.getKeys();n.forEach(function(n){var s=e.routes.get(n);if(t.getKey().match(s.key))for(var i=0;s.queues.length>i;i++)s.queues[i].enqueue(t)})}},Scule.messaging.classes.MessageChannel=function(){this.bindings=Scule.getHashTable(),this.bind=function(t,e,n){var s=t.getName()+","+e.getName();if(this.bindings.contains(s))throw"binding for "+s+" already exists";this.bindings.put(s,{exchange:t,queue:e}),t.addQueue(e,n)},this.unbind=function(t,e){var n=t.getName()+","+e.getName();if(!this.bindings.contains(n))throw"binding for "+n+" does not exist";var s=this.bindings.get(n);this.bindings.remove(n),s.exchange.removeQueue(s.queue)}},Scule.messaging.classes.MessageSubscriber=function(t,e){this.queue=t,this.callback=e,this.interval=null,this.start=function(){var t=this;this.interval=setInterval(function(){var e=t.queue.dequeue();e&&t.callback(e)},10+Scule.global.functions.randomFromTo(3,8))},this.stop=function(){clearInterval(this.interval)}},Scule.messaging.classes.MessagingDirector=function(){this.queues=Scule.getHashTable(),this.exchanges=Scule.getHashTable(),this.channel=new Scule.messaging.classes.MessageChannel,this.bind=function(t,e,n){void 0!==n?this.bindDirect(t,e,n):this.bindFanOut(t,e)},this.bindDirect=function(t,e,n){var s=null,i=null;if(this.exchanges.contains(t)){if(s=this.exchanges.get(t),!(s instanceof Scule.messaging.classes.DirectMessageExchange))throw"unable to bind directly to a fan-out exchange"}else s=new Scule.messaging.classes.DirectMessageExchange(t),this.exchanges.put(t,s);this.queues.contains(e)?i=this.queues.get(e):(i=new Scule.messaging.classes.MessageQueue(e),this.queues.put(e,i)),this.channel.bind(s,i,n)},this.bindFanOut=function(t,e){var n=null,s=null;if(this.exchanges.contains(t)){if(n=this.exchanges.get(t),!(n instanceof Scule.messaging.classes.FanOutMessageExchange))throw"unable to bind to direct exchange without a routing key"}else n=new Scule.messaging.classes.FanOutMessageExchange(t),this.exchanges.put(t,n);this.queues.contains(e)?s=this.queues.get(e):(s=new Scule.messaging.classes.MessageQueue(e),this.queues.put(e,s)),this.channel.bind(n,s)},this.publish=function(t,e,n){var s=new Scule.messaging.classes.Message(e,n);if(!this.exchanges.contains(t))throw"exchange "+t+" does not exist";var i=this.exchanges.get(t);i.route(s)},this.subscribe=function(t,e){if(!this.queues.contains(t))throw"queue "+t+" does not exist";var n=this.queues.get(t),s=new Scule.messaging.classes.MessageSubscriber(n,e);n.addSubscriber(s),s.start()},this.unsubscribeAll=function(t){if(void 0===t)throw"queue name is required";if(!this.queues.contains(t))throw"queue "+t+" does not exist";var e=this.queues.get(t),n=e.getSubscribers();n.forEach(function(t){t.stop()}),e.subscribers=[]}},Scule.getMessage=function(t,e){return new Scule.messaging.classes.Message(t,e)},Scule.getMessageQueue=function(t){return new Scule.messaging.classes.MessageQueue(t)},Scule.getMessageExchange=function(t){return new Scule.messaging.classes.MessageExchange(t)},Scule.getFanOutMessageExchange=function(t){return new Scule.messaging.classes.FanOutMessageExchange(t)},Scule.getDirectMessageExchange=function(t,e){return new Scule.messaging.classes.DirectMessageExchange(t,e)},Scule.getMessageChannel=function(){return new Scule.messaging.classes.MessageChannel},Scule.getMessagingDirector=function(){return new Scule.messaging.classes.MessagingDirector}}(),function(){Scule.datastructures.variables.fnv_hash=function(t,e){for(var n=2166136261,s=16777619,i=t.length,r=0;i>r;r++)n=(n^t.charCodeAt(r))*s;return n+=n<<13,n^=n>>7,n+=n<<3,n^=n>>17,n+=n<<5,0>n&&(n=-1*n),n%e},Scule.datastructures.variables.djb2_hash=function(t,e){var n=5381,s=t.length,i=0;for(i=0;s>i;i++)n=(n<<5)+n+t.charCodeAt(i);return 0>n&&(n=-1*n),n%e},Scule.datastructures.variables.joaat_hash=function(t,e){var n=0,s=t.length,i=0;for(i=0;s>i;i++)n+=t.charCodeAt(i),n+=n<<10,n^=n>>6;return n+=n<<3,n^=n>>11,n+=n<<15,0>n&&(n=-1*n),n%e},Scule.datastructures.variables.elf_hash=function(t,e){for(var n,s=0,i=0;t.length>i;i++)s=(s<<4)+t.charCodeAt(i),(n=4026531840&s)&&(s^=n>>24),s&=~n;return s%e},Scule.datastructures.classes.LinkedList=function(){this.head=null,this.tail=null,this.length=0,this.getHead=function(){return this.head},this.getTail=function(){return this.tail},this.getLength=function(){return this.length},this.isEmpty=function(){return 0===this.length},this.clear=function(){this.head=null,this.tail=null,this.length=0},this.get=function(t){if(0>t||t>this.length)return null;if(0===t)return this.head;for(var e=this.head,n=0;e&&t!=n;)n++,e=e.next;return e},this.add=function(t){var e=new Scule.datastructures.classes.LinkedListNode(null,t);if(null===this.head)this.head=e;else if(null===this.tail)this.head.next=e,this.tail=e;else{var n=this.tail;n.next=e,this.tail=n.next}return this.length++,e},this.search=function(t,e,n){n||(n=Scule.global.functions.compare);for(var s=this.head;s;){if(e){if(0===n(s.element[e],t))break}else if(0===n(s.element,t))break;s=s.next}return s},this.contains=function(t,e){if(null===t)return!1;e||(e=Scule.global.functions.compare);for(var n=this.head;n&&0!==e(n.element,t);)n=n.next;return null!==n},this.split=function(t){var e;if(void 0===t){if(t=Math.floor(this.length/2),e=this.middle(),!e)return null}else{if(1>t||t>this.length)return null;e=this.get(t-1)}var n=new Scule.datastructures.classes.LinkedList;return n.head=e.next,e.next=null,n.tail=this.tail,this.tail=e,n.length=t,this.length=this.length-t,n},this.middle=function(){if(!this.head)return null;for(var t=this.head,e=this.head;e.next&&e.next.next;)t=t.next,e=e.next.next;return t},this.remove=function(t){if(0>t||t>this.length)return null;var e;if(1===this.length)e=this.head,this.clear();else{var n=this.get(t-1);n.next==this.tail?(e=this.tail,this.tail=n):(e=n.next,n.next=n.next.next),this.length--}return e},this.reverse=function(){for(var t=null,e=this.head,n=null;e;)n=e.next,e.next=t,t=e,e=n;n=this.head,this.head=this.tail,this.tail=n},this.toArray=function(){for(var t=[],e=this.head;e;)t.push(e.element),e=e.next;return t},this.forEach=function(t){for(var e=this.head;e;)t(e),e=e.next;return!0},this.sort=function(t,e){if(2>this.length)return this;t||(t=Scule.global.functions.compare);var n=function(t){if(!t)return t;for(var e=t,n=t;n.next&&n.next.next;)e=e.next,n=n.next.next;return e},s=function(n,s){for(var i,r,a={next:null},u=a;n&&s;)e?(i=s.element[e],r=n.element[e]):(i=s.element,r=n.element),t(i,r)>-1?(u.next=n,n=n.next):(u.next=s,s=s.next),u=u.next;return u.next=n?n:s,a.next},i=function(t){if(!t||!t.next)return t;var e=n(t),r=e.next;return e.next=null,s(i(t),i(r))};this.head=i(this.head)}},Scule.datastructures.classes.DoublyLinkedList=function(){this.head=null,this.tail=null,this.length=0,this.getHead=function(){return this.head},this.getTail=function(){return this.tail},this.isEmpty=function(){return 0===this.length},this.getLength=function(){return this.length},this.search=function(t,e,n){n||(n=Scule.global.functions.compare);for(var s=this.head;s;){if(e){if(0===n(s.element[e],t))break}else if(0===n(s.element,t))break;s=s.next}return s},this.contains=function(t,e){if(null===t)return!1;e||(e=Scule.global.functions.compare);for(var n=this.head;n&&0!==e(n.element,t);)n=n.next;return null!==n},this.get=function(t){if(0>t||t>this.length)return null;if(0===t)return this.head;for(var e=this.head,n=0;e&&t!=n;)n++,e=e.next;return e},this.add=function(t){var e=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,t);if(this.isEmpty())this.head=e;else if(this.tail){var n=this.tail;n.next=e,e.prev=n,this.tail=e}else this.tail=e,this.tail.prev=this.head,this.head.next=e;return this.length++,e},this.remove=function(t){if(0>t||t>this.length)return null;var e;if(1===this.length)e=this.head,this.clear();else{var n=this.get(t-1);n.next==this.tail?(e=this.tail,this.tail=n,this.tail.prev=e.prev,this.tail.next=null):(e=n.next,n.next=n.next.next,n.next&&(n.next.prev=n)),this.length--}return e&&e.detach(),e},this.trim=function(){return this.isEmpty()?null:this.remove(this.length-1)},this.split=function(t){var e;if(void 0===t){if(t=Math.floor(this.length/2),e=this.middle(),!e)return null}else{if(1>t||t>this.length)return null;e=this.get(t-1)}var n=new Scule.datastructures.classes.DoublyLinkedList;return n.head=e.next,e.next=null,e.prev=null,n.tail=this.tail,this.tail=e,n.length=t,this.length=this.length-t,n},this.middle=function(){if(!this.head)return null;for(var t=this.head,e=this.head;e.next&&e.next.next;)t=t.next,e=e.next.next;return t},this.sort=function(t,e){if(2>this.length)return this;t||(t=Scule.global.functions.compare);var n=function(t){if(!t)return t;for(var e=t,n=t;n.next&&n.next.next;)e=e.next,n=n.next.next;return e},s=function(n,s){for(var i,r,a={next:null},u=a;n&&s;)e?(i=s.element[e],r=n.element[e]):(i=s.element,r=n.element),t(i,r)>-1?(u.next=n,u.prev=s,n=n.next):(u.next=s,u.prev=n,s=s.next),u=u.next;return u.next=n?n:s,a.next},i=function(t){if(!t||!t.next)return t;var e=n(t),r=e.next;return e.next=null,r.prev=null,s(i(t),i(r))};this.head=i(this.head)},this.reverse=function(){for(var t=this.head,e=null;t;)e=t.next,t.next=t.prev,t.prev=e,t=e;e=this.head,this.head=this.tail,this.tail=e},this.prepend=function(t){var e=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,t);if(this.isEmpty())this.head=e;else{var n=this.head;this.head=e,n.prev=this.head,this.head.next=n,this.tail||(this.tail=n)}return this.length++,e},this.clear=function(){this.head=null,this.tail=null,this.length=0},this.toArray=function(){for(var t=[],e=this.head;e;)t.push(e.element),e=e.next;return t},this.forEach=function(t){for(var e=this.head;e;)t(e),e=e.next;return!0}},Scule.datastructures.classes.CachingLinkedList=function(t,e,n){if(!e)throw"A valid cache key is required to use a CachingLinkedList";t||(t=100),this.cacheKey=e,this.threshold=t,this.cache=new Scule.datastructures.classes.LRUCache(t),n||(n=new Scule.datastructures.classes.LinkedList),this.list=n,this.clear=function(){this.cache.clear(),this.list.clear()},this.remove=function(t){var e=this.list.remove(t);return e&&this.cache.remove(e.element[this.cacheKey]),e},this.middle=function(){return this.list.middle()},this.split=function(){return this.cache.clear(),this.list.split()},this.add=function(t){var e=this.list.add(t);return this.cache.put(e.element[this.cacheKey],e),e},this.search=function(t){if(this.cache.contains(t))return this.cache.get(t);var e=this.list.search(t,this.cacheKey);return e&&this.cache.put(e.element[this.cacheKey],e),e},this.getLength=function(){return this.list.getLength()},this.getTail=function(){return this.list.getTail()},this.getHead=function(){return this.list.getHead()},this.isEmpty=function(){return this.list.isEmpty()},this.get=function(t){return this.list.get(t)},this.contains=function(t){return this.list.contains(t)},this.reverse=function(){this.list.reverse()},this.sort=function(t){this.list.sort(t,this.cacheKey)},this.toArray=function(){return this.list.toArray()},this.forEach=function(t){return this.list.forEach(t)}},Scule.datastructures.classes.LinkedListNode=function(t,e){this.next=t,this.element=e,this.getNext=function(){return this.next},this.setNext=function(t){this.next=t},this.getElement=function(){return this.element},this.setElement=function(t){this.element=t}},Scule.datastructures.classes.DoublyLinkedListNode=function(t,e,n){Scule.datastructures.classes.LinkedListNode.call(this,e,n),this.prev=t,this.getPrev=function(){return this.prev},this.setPrev=function(t){this.prev=t},this.detach=function(){this.prev=null,this.next=null}},Scule.datastructures.classes.LRUCache=function(t){this.threshold=t,this.cache=new Scule.datastructures.classes.HashTable,this.queue=new Scule.datastructures.classes.DoublyLinkedList,this.contains=function(t){return this.cache.contains(t)},this.remove=function(t){if(!this.cache.contains(t))return null;var e=this.cache.get(t);this.cache.remove(t);var n=e.node.prev,s=e.node.next;return n&&(n.next=s),s&&(s.prev=n),e.node.detach(),this.queue.length--,!0},this.get=function(t){if(!this.cache.contains(t))return null;var e=this.cache.get(t);return e.requeue(this.queue),e.value},this.put=function(t,e){var n;if(this.cache.contains(t)?(n=this.cache.get(t),n.value=e,n.node.element={key:t,value:e},n.requeue(this.queue)):(n=new Scule.datastructures.classes.LRUCacheEntry(t,e,this.queue.prepend({key:t,value:e})),this.cache.put(t,n)),this.queue.length>this.threshold){var s=this.queue.trim();if(!this.cache.remove(s.getElement().key))throw"LRU cache is corrupt";s=null}return!0},this.getLength=function(){return this.cache.getLength()},this.clear=function(){this.cache.clear(),this.queue.clear()}},Scule.datastructures.classes.LRUCacheEntry=function(t,e,n){this.key=t,this.value=e,this.node=n,this.getKey=function(){return this.key},this.getValue=function(){return this.value},this.getNode=function(){return this.node},this.requeue=function(t){if(this.node.prev){var e=this.node.prev,n=this.node.next;e.next=n,n&&(n.prev=e),this.node.detach(),t.length--,this.node=t.prepend({key:this.key,value:this.value})
}}},Scule.datastructures.classes.LIFOStack=function(){Scule.datastructures.classes.LinkedList.call(this),this.push=function(t){var e=this.head;this.head=new Scule.datastructures.classes.LinkedListNode(e,t),this.length++},this.pop=function(){if(this.isEmpty())return null;var t=this.head;return this.head=t.next,this.length--,t.next=null,t.getElement()},this.peek=function(){return this.isEmpty()?null:this.head.getElement()}},Scule.datastructures.classes.FIFOStack=function(){Scule.datastructures.classes.LIFOStack.call(this),this.push=this.add,this.pop=function(){if(this.isEmpty())return null;var t=this.head;return this.head=t.next,this.length--,t.getElement()}},Scule.datastructures.classes.Queue=function(){Scule.datastructures.classes.FIFOStack.call(this),this.enqueue=this.push,this.dequeue=this.pop},Scule.datastructures.classes.HashMap=function(t){this.size=t,this.buckets=0,this.length=0,this.table=[],this.hash=Scule.datastructures.variables.djb2_hash,this.retable=function(){var t=this.length/this.size;if(!(this.length>=this.buckets&&.7>t)){var e=this.toArray();this.clear(),this.size=2*this.size;for(var n=0;e.length>n;n++)this.put(e[n][0],e[n][1])}},this.bucket=function(t){return this.table[t]||(this.buckets++,this.table[t]=new Scule.datastructures.classes.BinarySearchTree),this.table[t]},this.put=function(t,e){var n=this.hash(t,this.size),s=this.bucket(n),i=s.insert(t,e);return i&&(this.length++,0===s.getLength()%10&&s.balance()),this.retable(),i},this.contains=function(t){var e=this.hash(t,this.size),n=this.bucket(e);return null!==n.search(t)},this.get=function(t){var e=this.hash(t,this.size),n=this.bucket(e),s=n.search(t);return null===s?null:s.getData()},this.search=function(t){return this.get(t)},this.remove=function(t){var e=this.hash(t,this.size),n=this.bucket(e);return n.remove(t)?(this.length--,this.retable(),!0):!1},this.clear=function(){this.table=[],this.length=0,this.buckets=0},this.getLength=function(){return this.length},this.getKeys=function(){var t=[],e=function(n){null!==n&&(t.push(n.getKey()),e(n.getLeft()),e(n.getRight()))};return this.table.forEach(function(t){t&&e(t.getRoot())}),t},this.getValues=function(){var t=[],e=function(n){null!==n&&(t.push(n.getData()),e(n.getLeft()),e(n.getRight()))};return this.table.forEach(function(t){t&&e(t.getRoot())}),t},this.toArray=function(){var t=[];return this.table.forEach(function(e){e&&(t=t.concat(e.toArray()))}),t}},Scule.datastructures.classes.HashTable=function(){this.table={},this.length=0,this.put=function(t,e){this.contains(t)||this.length++,this.table[t]=e},this.get=function(t){return this.contains(t)?this.table[t]:null},this.search=function(t){return this.get(t)},this.remove=function(t){if(this.contains(t)){var e=this.table[t];return delete this.table[t],this.length--,e}return!1},this.contains=function(t){return Scule.global.functions.hasOwnProperty(this.table,t)},this.clear=function(){this.table={},this.length=0},this.getLength=function(){return this.length},this.getKeys=function(){var t=[];for(var e in this.table)this.contains(e)&&t.push(e);return t},this.getValues=function(){var t=[];for(var e in this.table)this.contains(e)&&t.push(this.table[e]);return t},this.toArray=function(){var t=[];for(var e in this.table)this.contains(e)&&(t[e]=this.table[e]);return t}},Scule.datastructures.classes.BPlusTreeNode=function(){this.leaf=!1,this.order=100,this.threshold=40,this.data=[],this.getOrder=function(){return this.order},this.setOrder=function(t){this.order=t},this.getMergeThreshold=function(){return this.threshold},this.setMergeThreshold=function(t){this.threshold=t},this.isLeaf=function(){return this.leaf}},Scule.datastructures.classes.BPlusTreeLeafNode=function(t,e){Scule.datastructures.classes.BPlusTreeNode.call(this),this.leaf=!0,this.left=t,this.right=e,this.getRight=function(){return this.right},this.setRight=function(t){this.right=t},this.getLeft=function(){return this.left},this.setLeft=function(t){this.left=t},this.lookup=new Scule.datastructures.classes.LRUCache(Math.floor(this.threshold/2)),this.search=function(t){var e=this.lookup.get(t);if(!e){if(e=this.sequentialSearch(t),!e)return null;this.lookup.put(e.key,e)}return e.value},this.sequentialSearch=function(t){var e=this.indexSearch(t),n=this.data[e];return this.data.length>e&&n.key==t?n:null},this.indexSearch=function(t){var e=this.data;if(0===e.length)return 0;var n=0,s=this.data.length-1,i=n+Math.floor((s-n)/2),r=!1;do i=n+Math.floor((s-n)/2),t>e[i].key?n=i+1:e[i].key>t?s=i:r=!0;while(s>n&&!r);return r?i:s},this.identifySiblings=function(t){for(var e={index:null,left:null,key:null,right:null},n=this.getRight(),s=this.getLeft(),i=0;t.data.length>i;i+=2){var r=t.data[i];r==n&&(e.right=n,e.index=i-2,e.right_key=t.data[i-1],e.right_key_index=i-1),r==s&&(e.left=s,e.index=i+2,e.left_key=t.data[i+1],e.left_key_index=i+1)}return null===e.index&&(e.index=i>=2?i-2:0),e},this.getKeys=function(){var t=[];return this.data.forEach(function(e){t.push(e.key)}),t},this.insert=function(t,e){var n=this.indexSearch(t);if(n==this.data.length)this.data.push({key:t,value:e});else{var s=this.data[n];s.key==t?s.value=e:t>s.key?this.data.splice(n+1,0,{key:t,value:e}):this.data.splice(n,0,{key:t,value:e})}return this.lookup.put(t,{key:t,value:e}),this.split()},this.remove=function(t,e){var n=this.indexSearch(t),s=this.data[n];return this.data.length>n&&s.key==t?(this.data.splice(n,1),this.lookup.remove(t),e?this.redistribute(t,e):null):null},this.redistribute=function(t,e){if(this.data.length>this.threshold)return{operation:2,oldkey:t,key:this.data[0].key};var n,s,i=this.identifySiblings(e),r=this.threshold-this.data.length,a=!1;return i.left&&(n=i.left,s=i.left_key,a=!0,n.data.length-r>=this.threshold)?(this.data=n.data.splice(-1*r,r).concat(this.data),this.lookup.clear(),{key:this.data[0].key,oldkey:i.left_key,index:i.left_key_index,operation:0}):i.right&&(n=i.right,s=i.right_key,a=!1,n.data.length-r>=this.threshold)?(this.data=this.data.concat(n.data.splice(0,r)),this.lookup.clear(),{key:n.data[0].key,oldkey:i.right_key,index:i.right_key_index,operation:0}):this.merge(n,i.index,s,a)},this.merge=function(t,e,n,s){if(this.data.length>this.threshold)return null;if(!t)throw"Unable to merge - no siblings";if(s)return t.data=t.data.concat(this.data.splice(0,this.data.length)),t.setRight(this.getRight()),t.getRight()&&t.getRight().setLeft(t),t.lookup.clear(),this.setLeft(null),this.setRight(null),{left:!0,index:e,node:t,key:t.data[0].key,oldkey:n,operation:1};var i=this.data.splice(0,this.data.length);return t.data=i.concat(t.data.splice(0,t.data.length)),t.setLeft(this.getLeft()),t.getLeft()&&t.getLeft().setRight(t),t.lookup.clear(),this.setLeft(null),this.setRight(null),{left:!1,index:e,key:t.data[0].key,node:t,oldkey:n,operation:1}},this.range=function(t,e,n,s){void 0===s&&(s=!1),void 0===n&&(n=!1),void 0===t&&(t=null),void 0===e&&(e=null);var i=this,r=null;r=n&&s?function(t,e,n,s,i){return null===t?e>=n&&(s=s.concat(i)):null===e?n>=t&&(s=s.concat(i)):n>=t&&e>=n&&(s=s.concat(i)),s}:n?function(t,e,n,s,i){return null===t?e>n&&(s=s.concat(i)):null===e?n>=t&&(s=s.concat(i)):n>=t&&e>n&&(s=s.concat(i)),s}:function(t,e,n,s,i){return null===t?e>=n&&(s=s.concat(i)):null===e?n>t&&(s=s.concat(i)):n>t&&e>=n&&(s=s.concat(i)),s};var a=[];t:for(;i;){var u=i.data,c=i.indexSearch(t),o=null===e||void 0===e?u.length-1:i.indexSearch(e);if(o>=u.length&&(o=u.length-1),u.length>=c)for(var l=c;o>=l;l++){if(null!==e&&u[l].key>e)break t;a=r(t,e,u[l].key,a,u[l].value)}i=i.getRight()}return a},this.split=function(){if(this.data.length<=this.order)return null;var t=Math.floor(this.data.length/2),e=new Scule.datastructures.classes.BPlusTreeLeafNode(this.getLeft());e.setOrder(this.getOrder()),e.setMergeThreshold(this.getMergeThreshold()),e.data=this.data.splice(0,t);var n=new Scule.datastructures.classes.BPlusTreeLeafNode(null,this.getRight());return n.setOrder(this.getOrder()),n.setMergeThreshold(this.getMergeThreshold()),n.data=this.data.splice(0,t+1),e.setRight(n),this.getLeft()&&this.getLeft().setRight(e),n.setLeft(e),this.getRight()&&this.getRight().setLeft(n),{left:e,key:n.data[0].key,right:n}},this.toString=function(){return JSON.stringify(this.toArray(),null,"	")},this.toArray=function(){for(var t={type:"leaf"},e=0;this.data.length>e;e++)t[e+":"+this.data[e].key]=this.data[e];return t}},Scule.datastructures.classes.BPlusTreeInteriorNode=function(){Scule.datastructures.classes.BPlusTreeNode.call(this),this.nodeSearch=function(t){for(var e=this.data.length,n=1;e>n;n+=2){var s=this.data[n];if(s==t)return n+1;if(s>=t)return n-1}return e-1},this.indexSearch=function(t){for(var e=this.data.length,n=1;e>n;n+=2){var s=this.data[n];if(s==t)return n;if(s>=t)return n}return e-2},this.childSearch=function(t){return 0===this.data.length?null:this.data[this.nodeSearch(t)]},this.search=function(t){return this.childSearch(t).search(t)},this.range=function(t,e,n,s){return this.childSearch(t).range(t,e,n,s)},this.insert=function(t,e){var n=this.indexSearch(t);this.data[n]>t?n--:n++;var s=this.data[n],i=s.insert(t,e);return i&&this.data.splice(n,1,i.left,i.key,i.right),this.split()},this.split=function(){var t=Math.floor((this.data.length-1)/2);if(this.order>t)return null;var e=Math.floor((this.data.length-1)/2),n=new Scule.datastructures.classes.BPlusTreeInteriorNode(this.left,null);n.setOrder(this.order),n.setMergeThreshold(this.threshold),n.data=this.data.splice(0,e);var s=new Scule.datastructures.classes.BPlusTreeInteriorNode(null,this.right);return s.setOrder(this.order),s.setMergeThreshold(this.threshold),s.data=this.data.splice(1,e),{left:n,key:this.data[0],right:s}},this.remove=function(t,e){var n=this.indexSearch(t),s=n;s=this.data[n]>t?n-1:n+1;var i=this.data[s],r=i.remove(t,this);if(!r)return null;switch(r.operation){case 0:break;case 1:if(3==this.data.length)return r.node;var a=r.index;r.left&&(a=r.index-2),this.data.splice(a,3,r.node);break;case 2:for(var u=!1,c=1;this.data.length>c;c+=2)this.data[c]==r.oldkey&&(this.data[c]=r.key,u=!0);if(!u)return e?r:null}return this.reassignKeys(),this.merge(e,r.key,t)},this.reassignKeys=function(){for(var t=2;this.data.length>t;t+=2)this.data[t].isLeaf()&&(this.data[t-1]=this.data[t].data[0].key)},this.merge=function(t,e,n){if(!t)return null;var s=Math.floor((this.data.length-1)/2);if(s>=this.threshold-1)return{key:e,oldkey:n,operation:2};for(var i,r,a,u=!1,c=0;t.data.length>c;c+=2)if(t.data[c]==this){0===c||t.data.length-1>c?(a=t.data[c+2],i=c+1):(u=!0,a=t.data[c-2],i=c-1);break}r=t.data[i];var o=new Scule.datastructures.classes.BPlusTreeInteriorNode;return o.setOrder(this.getOrder()),o.setMergeThreshold(this.getMergeThreshold()),u?(o.data=a.data.splice(0,a.data.length),o.data=o.data.concat(r),o.data=o.data.concat(this.data.splice(0,this.data.length))):(o.data=this.data.splice(0,this.data.length),o.data=o.data.concat(r),o.data=o.data.concat(a.data.splice(0,a.data.length))),{left:u,node:o,index:c,oldkey:r,operation:1}},this.toString=function(){return JSON.stringify(this.toArray(),null,"	")},this.toArray=function(){for(var t={type:"interior"},e=0,n=1;this.data.length>n;)t[n+":"+this.data[n]]={left:this.data[e].toArray(),right:this.data[e+2].toArray()},e+=2,n+=2;return t}},Scule.datastructures.classes.BPlusTree=function(t,e){t||(t=100),e||(e=Math.ceil(t/2)),this.order=t,this.threshold=e,this.root=new Scule.datastructures.classes.BPlusTreeLeafNode,this.root.setOrder(this.order),this.root.setMergeThreshold(this.threshold),this.insert=function(t,e){var n=this.root.insert(t,e);return n&&(this.root=new Scule.datastructures.classes.BPlusTreeInteriorNode,this.root.setOrder(this.order),this.root.setMergeThreshold(this.threshold),this.root.data.push(n.left),this.root.data.push(n.key),this.root.data.push(n.right)),!0},this.search=function(t){return this.root.search(t)},this.range=function(t,e,n,s){return this.root.range(t,e,n,s)},this.remove=function(t){var e=this.root.remove(t);return e&&(this.root=e),!0},this.clear=function(){this.root=new Scule.datastructures.classes.BPlusTreeLeafNode,this.root.setOrder(this.order),this.root.setMergeThreshold(this.threshold)},this.toString=function(){return""+this.root},this.toArray=function(){return this.root.toArray()}},Scule.datastructures.classes.BinarySearchTreeNode=function(t,e){this.parent=null,this.left=null,this.right=null,this.key=t,this.data=e,this.setParent=function(t){this.parent=t},this.getParent=function(){return this.parent},this.setLeft=function(t){t&&(this.left=t,this.left.setParent(this))},this.getLeft=function(){return this.left},this.setRight=function(t){t&&(this.right=t,this.right.setParent(this))},this.getRight=function(){return this.right},this.getKey=function(){return this.key},this.setData=function(t){this.data=t},this.getData=function(){return this.data},this.clear=function(){this.data=null},this.remove=function(t){return t?t==this.right?(this.setRight(t.getRight()),this.getRight().setLeft(t.getLeft()),t.parent=null,t.left=null,t.right=null,!0):t==this.left?(this.setLeft(t.getRight()),this.getLeft().setLeft(t.getLeft()),t.parent=null,t.left=null,t.right=null,!0):!1:!1}},Scule.datastructures.classes.AtomicCounter=function(t){if(void 0===t&&(t=0),!Scule.global.functions.isInteger(t))throw"Unable to initialize counter with non-integer value";this.count=t,this.increment=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to increment counter with non-integer value";return this.count+=t,this.count},this.decrement=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to decrement counter with non-integer value";return this.count-=t,this.count},this.getCount=function(){return this.count}},Scule.datastructures.classes.BinarySearchTree=function(){this.root=null,this.length=0,this.insert=function(t,e){var n=this,s=new Scule.datastructures.classes.BinarySearchTreeNode(t,e);if(null===this.root)return this.length++,this.root=s,!0;var i=function(t,e){return t.getKey()==e.getKey()?(e.setData(t.getData()),!1):(t.getKey()<=e.getKey()?e.getLeft()?i(t,e.getLeft()):(n.length++,e.setLeft(t)):e.getRight()?i(t,e.getRight()):(n.length++,e.setRight(t)),!0)};return i(s,this.root)},this.search=function(t){var e=function(t,n){return n?n.getKey()==t?n:n.getKey()>t?e(t,n.getLeft()):e(t,n.getRight()):null};return e(t,this.root)},this.remove=function(t){var e=this.search(t);if(!e)return!1;if(!e.getParent())return e.getRight()?(this.root=e.getRight(),this.root.setLeft(e.getLeft())):e.getLeft()?(this.root=e.getRight(),this.root.setLeft(e.getLeft())):this.root=null,this.length--,!0;var n=e.getParent().remove(e);return n&&this.length--,n},this.balance=function(){var t=this,e=this.toArray(),n=function(e){var s=e,i=e.splice(Math.ceil(e.length/2),e.length),r=s.pop();t.insert(r[0],r[1]),s.length>0&&n(s),i.length>0&&n(i)};this.length=0,this.root=null,n(e)},this.getLength=function(){return this.length},this.toArray=function(){var t=function(e){return e?t(e.getLeft()).concat([[e.getKey(),e.getData()]]).concat(t(e.getRight())):[]};return t(this.root)},this.getRoot=function(){return this.root}},Scule.datastructures.classes.BitSet=function(t){if(void 0===t||!Scule.global.functions.isInteger(t)||0>=t)throw"Unable to initialize bitset with non-integer capacity";this.capacity=t,this.words=null,this.zeroFill=function(){this.words=[];for(var t=Math.ceil(this.capacity/32),e=0;t>=e;e++)this.words[e]=0},this.indexToAddress=function(t){if(0>t||t>=this.capacity)throw"Index out of bounds";if(32>t)return{addr:0,offs:t};var e=Math.floor(t/32),n=t%32;return{addr:e,offs:n}},this.get=function(t){var e=this.indexToAddress(t);return 0!=(this.words[e.addr]&1<<e.offs)},this.set=function(t){var e=this.indexToAddress(t);this.words[e.addr]|=1<<e.offs},this.clear=function(t){var e=this.indexToAddress(t);this.words[e.addr]&=~(1<<e.offs)},this.getLength=function(){return this.capacity},this.toString=function(){for(var t="",e=0;this.capacity>e;e++)t+=this.get(e)?1:0;return t},this.zeroFill()},Scule.datastructures.classes.BloomFilter=function(t,e){if(void 0===t||!Scule.global.functions.isInteger(t)||0>=t)throw"Unable to initialize bloom filter with non-integer m";(void 0===e||!Scule.global.functions.isInteger(e)||0>=e)&&(e=Math.floor(t/Math.ceil(t/3))),Scule.datastructures.classes.BitSet.call(this,t),this.k=e,this.f=[];for(var n=0;this.k>n;n++)this.f.push([Scule.global.functions.randomFromTo(0,999999),Scule.global.functions.randomFromTo(0,999999)]);this.hash=function(t,e,n){return Scule.datastructures.variables.fnv_hash(this.f[t][0]+e+this.f[t][1],n)},this.add=function(t){for(var e=0;this.k>e;e++)this.set(this.hash(e,t,this.capacity))},this.query=function(t){for(var e=0;this.k>e;e++)if(!this.get(this.hash(e,t,this.capacity)))return!1;return!0}},Scule.datastructures.classes.AtomicCounter=function(t){if(void 0===t&&(t=0),!Scule.global.functions.isInteger(t))throw"Unable to initialize counter with non-integer value";this.count=t,this.increment=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to increment counter with non-integer value";return this.count+=t,this.count},this.decrement=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to decrement counter with non-integer value";return this.count-=t,this.count},this.getCount=function(){return this.count}},Scule.getLinkedList=function(){return new Scule.datastructures.classes.LinkedList},Scule.getCachingLinkedList=function(t,e){return new Scule.datastructures.classes.CachingLinkedList(t,e)},Scule.getDoublyLinkedList=function(){return new Scule.datastructures.classes.DoublyLinkedList},Scule.getHashTable=function(){return new Scule.datastructures.classes.HashTable},Scule.getPrimaryKeyIndex=function(){return new Scule.db.classes.PrimaryKeyIndex},Scule.getHashMap=function(t){return new Scule.datastructures.classes.HashMap(t)},Scule.getLIFOStack=function(){return new Scule.datastructures.classes.LIFOStack},Scule.getFIFOStack=function(){return new Scule.datastructures.classes.FIFOStack},Scule.getQueue=function(){return new Scule.datastructures.classes.Queue},Scule.getLRUCache=function(t){return new Scule.datastructures.classes.LRUCache(t)},Scule.getBPlusTree=function(t,e){return new Scule.datastructures.classes.BPlusTree(t,e)},Scule.getBPlusTreeNode=function(){return new Scule.datastructures.classes.BPlusTreeNode},Scule.getBPlusTreeLeafNode=function(t,e){return new Scule.datastructures.classes.BPlusTreeLeafNode(t,e)},Scule.getBPlusTreeInteriorNode=function(){return new Scule.datastructures.classes.BPlusTreeInteriorNode},Scule.getBinarySearchTreeNode=function(t,e){return new Scule.datastructures.classes.BinarySearchTreeNode(t,e)},Scule.getBinarySearchTree=function(){return new Scule.datastructures.classes.BinarySearchTree},Scule.getAtomicCounter=function(t){return new Scule.datastructures.classes.AtomicCounter(t)},Scule.getBitSet=function(t){return new Scule.datastructures.classes.BitSet(t)},Scule.getBloomFilter=function(t){return new Scule.datastructures.classes.BloomFilter(t)}}(),function(){Scule.instrumentation.classes.Timer=function(){this.intervalCounter=0,this.intervalArray=[],this.intervals=Scule.getLIFOStack(),this.resetTimer=function(){this.intervalCounter=0,this.intervalArray=[],this.intervals.clear()},this.startInterval=function(t){this.intervalCounter++,void 0===t&&(t=this.intervalCounter),this.intervals.push(new Scule.instrumentation.classes.TimerInterval(t)),this.intervalArray.push(this.intervals.peek())},this.stopInterval=function(){return this.intervals.isEmpty()?!1:(this.intervals.peek().stop(),this.intervals.pop())},this.stopAllIntervals=function(){for(;!this.intervals.isEmpty();)this.intervals.pop().stop()},this.logToConsole=function(){this.intervalArray.forEach(function(t){t.logToConsole()})}},Scule.instrumentation.classes.TimerInterval=function(t){this.startTimestamp=(new Date).getTime(),this.endTimestamp=null,this.tag=t,this.stopped=function(){return null!==this.endTimestamp},this.stop=function(){this.endTimestamp=(new Date).getTime()},this.getDifference=function(){return null===this.endTimestamp?!1:this.endTimestamp-this.startTimestamp},this.logToConsole=function(){var t=this.getDifference();t===!1&&console.log("interval "+this.tag+" is still in progress"),console.log("interval "+this.tag+" lasted "+t+"ms")}},Scule.getTimer=function(){return new Scule.instrumentation.classes.Timer}}(),function(){Scule.interpreter.symbols.table={$and:Scule.interpreter.arities.selective,$or:Scule.interpreter.arities.selective,$nor:Scule.interpreter.arities.negative,$not:Scule.interpreter.arities.negative,$lt:Scule.interpreter.arities.range,$lte:Scule.interpreter.arities.range,$gt:Scule.interpreter.arities.range,$gte:Scule.interpreter.arities.range,$all:Scule.interpreter.arities.array,$in:Scule.interpreter.arities.array,$nin:Scule.interpreter.arities.array,$elemMatch:Scule.interpreter.arities.array,$eq:Scule.interpreter.arities.binary,$ne:Scule.interpreter.arities.binary,$size:Scule.interpreter.arities.binary,$exists:Scule.interpreter.arities.binary,$within:Scule.interpreter.arities.geospatial,$near:Scule.interpreter.arities.geospatial,$set:Scule.interpreter.arities.mutate,$inc:Scule.interpreter.arities.mutate,$unset:Scule.interpreter.arities.mutate,$pull:Scule.interpreter.arities.mutate,$pullAll:Scule.interpreter.arities.mutate,$pop:Scule.interpreter.arities.mutate,$push:Scule.interpreter.arities.mutate,$pushAll:Scule.interpreter.arities.mutate,$rename:Scule.interpreter.arities.mutate},Scule.interpreter.classes.QueryNormalizer=function(){this.normalize=function(t){var e=function(t){for(var n in t)if(Scule.global.functions.isScalar(t[n])||t[n]instanceof RegExp||t[n]instanceof Scule.db.classes.ObjectId){var s=t[n];s instanceof Scule.db.classes.ObjectId&&(s=""+t[n]),delete t[n],t[n]={$eq:s}}else"$or"==n||"$elemMatch"==n?e(t[n]):t[n]=Scule.global.functions.sortObjectKeys(t[n]);return Scule.global.functions.sortObjectKeys(t)};return e(t)}},Scule.interpreter.functions.intersection=function(t){if(1==t.length)return t[0];var e=Scule.getHashTable(),n=null;if(t.forEach(function(t){(!n||t.length<n.length)&&(n=t)}),!n)return[];n.forEach(function(t){e.put(Scule.global.functions.getObjectId(t),{c:1,o:t})});for(var s=[],i=t.length,r=0;i>r;r++)if(t[r]!=n){var a=function(t){var n=e.get(Scule.global.functions.getObjectId(t));n&&(n.c++,n.c==i&&s.push(t))};t[r].forEach(a)}return s},Scule.interpreter.classes.DateComparator=function(){this.isDate=function(t){return t instanceof Date||t instanceof Scule.db.classes.ObjectDate},this.normalizeDate=function(t){if(!this.isDate(t))throw Error("unable to compare non-date object");return t instanceof Scule.db.classes.ObjectDate?t.toDate().getTime():t instanceof Date?t.getTime():t},this.$eq=function(t,e){return this.normalizeDate(t)===this.normalizeDate(e)},this.$gt=function(t,e){return this.normalizeDate(t)>this.normalizeDate(e)},this.$gte=function(t,e){return this.normalizeDate(t)>=this.normalizeDate(e)},this.$lt=function(t,e){return this.normalizeDate(t)<this.normalizeDate(e)},this.$lte=function(t,e){return this.normalizeDate(t)<=this.normalizeDate(e)}},Scule.interpreter.classes.QueryEngine=function(){this.comparator=new Scule.interpreter.classes.DateComparator,this.traverse=function(t,e){return Scule.global.functions.traverse(t,e)},this.traverseObject=function(t,e){return Scule.global.functions.traverseObject(Scule.global.functions.parseAttributes(t),e)},this.$ne=function(t,e){return!this.$eq(t,e)},this.$eq=function(t,e){return e instanceof RegExp?e.test(t):t instanceof Scule.db.classes.ObjectId?""+t==e:this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$eq(t,e):t===e},this.$gt=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$gt(t,e):t>e},this.$gte=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$gte(t,e):t>=e},this.$lt=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$lt(t,e):e>t},this.$lte=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$lte(t,e):e>=t},this.$all=function(t,e){if(!Scule.global.functions.isArray(t)||!Scule.global.functions.isArray(e))return!1;var n=0,s={};for(n=0;t.length>n;n++)s[t[n]]=!0;for(n=0;e.length>n;n++)if(!s.hasOwnProperty(e[n]))return!1;return!0},this.$in=function(t,e){for(var n=0;e.length>n;n++)if(this.$eq(t,e[n]))return!0;return!1},this.$nin=function(t,e){for(var n=0;e.length>n;n++)if(this.$eq(t,e[n]))return!1;return!0},this.$elemMatch=function(t,e){if(!Scule.global.functions.isArray(t))return!1;for(var n=0;t.length>n;n++)if(e(t[n]))return!0;return!1},this.$size=function(t,e){return Scule.global.functions.isInteger(e)?Scule.global.functions.sizeOf(t)==e:!1},this.$exists=function(t,e){return e?void 0!==t:void 0===t},this.$within=function(t,e){if(!t.hasOwnProperty("lat")||!t.hasOwnProperty("lon"))return!1;if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lon"))return!1;var n=Math.sqrt(Math.pow(e.lat-t.lat,2)+Math.pow(e.lon-t.lon,2));return e.distance>=n},this.$near=function(t,e){if(!t.hasOwnProperty("lat")||!t.hasOwnProperty("lon"))return!1;if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lon"))return!1;var n=6371*Math.acos(Math.sin(t.lat)*Math.sin(e.lat)+Math.cos(t.lat)*Math.cos(e.lat)*Math.cos(e.lon-t.lon));return e.distance>=n},this.$sort=function(t,e,n){Scule.global.functions.sort(t,e,n)},this.$set=function(t,e,n){var s=t[0],i=t[1];s in i?i[s]=e:n===!0&&(i[s]=e)},this.$unset=function(t){var e=t[0],n=t[1];e in n&&delete n[e]},this.$inc=function(t,e,n){Scule.global.functions.isInteger(e)||(e=1);var s=t[0],i=t[1];s in i?(Scule.global.functions.isInteger(i[s])||Scule.global.functions.isDouble(i[s]))&&(i[s]+=e):n&&(i[s]=e)},this.$pull=function(t,e){var n=t[0],s=t[1];if(n in s&&Scule.global.functions.isArray(s[n])){for(var i=[],r=0;s[n].length>r;r++)s[n][r]!==e&&i.push(s[n][r]);s[n]=i}},this.$pullAll=function(t,e){var n=t[0],s=t[1];if(n in s&&Scule.global.functions.isArray(s[n])){if(!Scule.global.functions.isArray(e))throw"the $pullAll operator requires an associated array as an operand";var i=Scule.getHashTable();e.forEach(function(t){i.put(t,!0)});for(var r=0;s[n].length>r;r++)i.contains(s[n][r])&&(s[n].splice(r,1),r--)}},this.$pop=function(t){var e=t[0],n=t[1];e in n&&Scule.global.functions.isArray(n[e])&&n[e].pop()},this.$push=function(t,e,n){var s=t[0],i=t[1];s in i||!n?Scule.global.functions.isArray(i[s])&&i[s].push(e):i[s]=[e]},this.$pushAll=function(t,e,n){var s=t[0],i=t[1];if(s in i||!n){if(!Scule.global.functions.isArray(e))throw"the $pushAll operator requires an associated array as an operand";Scule.global.functions.isArray(i[s])&&e.forEach(function(t){i[s].push(t)})}else i[s]=e.slice(0)}},Scule.interpreter.classes.QueryCompiler=function(){this.cache=Scule.getHashTable(),this.engine=new Scule.interpreter.classes.QueryEngine,this.normalizer=new Scule.interpreter.classes.QueryNormalizer,this.compileConditions=function(t){var e="";for(var n in t)if(t.hasOwnProperty(n))switch(n){case"$limit":e+="	if (r.length > "+t[n]+") {\n",e+="		r.splice("+t[n]+");\n",e+="	}\n";break;case"$sort":var s=t[n],i=Scule.global.functions.objectKeys(s);1==i.length&&(e+="	engine.$sort("+s[i[0]]+', r, "'+i[0]+'");\n')}return e},this.compileClauseList=function(t){var e=this,n=[];return Scule.global.functions.isArray(t)?(t.forEach(function(t){var s=[];for(var i in t)t.hasOwnProperty(i)&&(s=s.concat(e.compileQueryClauses(i,t[i])));n.push(s.join(" && "))}),n.join(" || ")):n},this.compileExpressions=function(t){t=this.normalizer.normalize(t);var e=[];for(var n in t)e=e.concat(this.compileQueryClauses(n,t[n]));return e},this.compileQueryClauses=function(t,e){var n=[];for(var s in e)if(this.engine.hasOwnProperty(s))if("$elemMatch"==s){var i=this.compileExpressions(e[s]),r="function(o) { return ("+i.join(" && ")+"); }";0>t.indexOf(".")?n.push("engine.$elemMatch(o."+t+", "+r+")"):n.push("engine.$elemMatch(engine.traverse("+JSON.stringify(t)+", o), "+r+")")}else if(0>t.indexOf(".")){var a=null;a=e[s]instanceof RegExp?""+e[s]:e[s]instanceof Date?'new Date("'+(""+e[s])+'")':e[s]instanceof Scule.db.classes.ObjectDate?'new Date("'+(""+e[s].toDate())+'")':JSON.stringify(e[s]),n.push("engine."+s+"(o."+t+", "+a+")")}else n.push("engine."+s+"(engine.traverse("+JSON.stringify(t)+", o), "+a+")");return n},this.compileUpdateClauses=function(t,e,n){if(this.engine.hasOwnProperty(t)){var s=[];for(var i in e)s.push("		engine."+t+"(engine.traverseObject("+JSON.stringify(i)+", o), "+JSON.stringify(e[i])+", "+JSON.stringify(n)+");");return s}},this.compileUpdate=function(query,upsert,ignoreCache){var hash=Scule.md5.hash(this.serializeQuery(query));if(this.cache.contains(hash))return this.cache.get(hash);var updates=[],closure="var u = function(objects, collection, engine) {\n";closure+="	objects.forEach(function(o) {\n";for(var key in query)query.hasOwnProperty(key)&&(updates=updates.concat(this.compileUpdateClauses(key,query[key],upsert)));return closure+=updates.join("\n"),closure+="\n	});\n",closure+="	return objects;\n",closure+="}\n",ignoreCache?closure:(eval(closure),this.cache.put(hash,u),this.cache.get(hash))},this.serializeQuery=function(t){var e=Scule.global.functions.cloneObject(t),n=function(t){for(var e in t)t[e]instanceof Scule.db.classes.ObjectId||t[e]instanceof RegExp?t[e]=""+t[e]:Scule.global.functions.isScalar(t[e])||n(t[e])};return n(e),JSON.stringify(e)},this.compileQuery=function(query,conditions,ignoreCache){query=this.normalizer.normalize(query);var hash=Scule.md5.hash(this.serializeQuery(query)+this.serializeQuery(conditions));if(this.cache.contains(hash))return this.cache.get(hash);var closure="var c = function(objects, engine) {\n";if(closure+="	var r = [];\n",Scule.global.functions.sizeOf(query)>0){closure+="	objects.forEach(function(o) {\n",closure+="		o = o.element;\n";var ands=[],ors="";for(var key in query)query.hasOwnProperty(key)&&("$or"==key?ors="("+this.compileClauseList(query[key])+")":ands=ands.concat(this.compileQueryClauses(key,query[key])));ands.length>0?(ors.length>0&&(ors=" && "+ors),closure+="		if (("+ands.join(" && ")+")"+ors+") {\n",closure+="			r[r.length] = o;\n",closure+="		}\n"):ors.length>0&&(closure+="		if ("+ors+") {\n",closure+="			r[r.length] = o;\n",closure+="		}\n"),closure+="	});\n"}else closure+="	r = objects.toArray();\n";return conditions&&conditions.hasOwnProperty("$skip")&&(closure+="	r.splice(0, "+conditions.$skip+");\n",delete conditions.$skip),conditions&&(closure+=this.compileConditions(conditions)),closure+="	return r;\n",closure+="};\n",ignoreCache?closure:(eval(closure),this.cache.put(hash,c),this.cache.get(hash))},this.explainQuery=function(t,e){var n=this.compileQuery(t,e,!0);return console.log(n),n},this.explainUpdate=function(t,e){var n=this.compileUpdate(t,e,!0);return console.log(n),n}},Scule.interpreter.classes.QueryInterpreter=function(){this.compiler=new Scule.interpreter.classes.QueryCompiler,this.interpret=function(t,e,n,s){if(s)return this.compiler.explainQuery(e,n);var i=t.documents.queue,r=this.compiler.compileQuery(e,n);return r(i,Scule.interpreter.objects.engine)},this.update=function(t,e,n,s,i,r){var a=this.interpret(t,e,s,r);if(r)return this.compiler.explainUpdate(n,i);var u=this.compiler.compileUpdate(n,i);return u(a,t,Scule.interpreter.objects.engine)}},Scule.interpreter.objects.engine=new Scule.interpreter.classes.QueryEngine,Scule.getQueryNormalizer=function(){return new Scule.interpreter.classes.QueryNormalizer},Scule.getQueryEngine=function(){return new Scule.interpreter.classes.QueryEngine},Scule.getQueryCompiler=function(){return new Scule.interpreter.classes.QueryCompiler},Scule.getQueryInterpreter=function(){return new Scule.interpreter.classes.QueryInterpreter},Scule.getDateComparator=function(){return new Scule.interpreter.classes.DateComparator}}(),function(){Scule.db.classes.SimpleCryptographyProvider=function(){this.signString=function(t,e,n){return Scule.sha1.hash(Scule.sha1.hash(t+e)+n)},this.signObject=function(t,e,n){return t._sig=n,this.signString(JSON.stringify(t),e,n)
},this.signJSONString=function(t,e,n){return this.signString(JSON.stringify(t),e,n)},this.verifyObjectSignature=function(t,e,n){var s=t._sig,i=this.signObject(t,e,n);return s==i}},Scule.db.classes.StorageEngine=function(t){this.configuration=t,this.crypto=null,this.setConfiguration=function(t){this.configuration=t},this.getConfiguration=function(){return this.configuration},this.setCryptographyProvider=function(t){this.crypto=t},this.getCryptographyProvider=function(){return this.crypto},this.write=function(){throw"function not implemented in abstract class"},this.read=function(){throw"function not implemented in abstract class"}},Scule.db.classes.DummyStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.write=function(t,e,n){n&&n(e)},this.read=function(t,e){e&&e()}},Scule.db.classes.MemoryStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),this.storage={},this.write=function(t,e,n){e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+"")),e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt),this.storage["__scule_collection__"+t]=JSON.stringify(e),n&&n(e)},this.read=function(t,e){if(!("__scule_collection__"+t in this.storage)){var n={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:3,_name:t,_objects:{}};n._sig=this.crypto.signObject(n,this.configuration.secret,n._salt),this.storage["__scule_collection__"+t]=JSON.stringify(n)}var s=this.storage["__scule_collection__"+t],i=JSON.parse(s);if(this.crypto.verifyObjectSignature(i,this.configuration.secret,i._salt)===!1)throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection});delete i._sig,e&&e(i)}},Scule.db.classes.LocalStorageStorageEngine=function(t){if(Scule.db.classes.StorageEngine.call(this,t),this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),!window||!window.hasOwnProperty("localStorage")&&null!==window.localStorage)throw JSON.stringify({event:"SculeLocalStorageError",message:"Local storage is not available on this device"});this.write=function(t,e,n){e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+""));try{e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt),localStorage.setItem("__scule_collection__"+t,JSON.stringify(e)),n&&n(e)}catch(s){throw JSON.stringify({event:"SculeLocalStorageError",message:"Storage quota exceeded for origin",collection:this.configuration.collection})}},this.read=function(t,e){var n=localStorage.getItem("__scule_collection__"+t),s={};if(n){if(s=JSON.parse(n),this.crypto.verifyObjectSignature(s,this.configuration.secret,s._salt)===!1)throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection});delete s._sig}else s={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:3,_name:t,_objects:{}};e&&e(s)}},Scule.db.classes.ObjectId=function(t){if(void 0===t){for(var e=Math.floor((new Date).getTime()/1e3).toString(16),n=Scule.md5.hash(Scule.global.functions.getMACAddress()).substring(0,6),s=Scule.global.functions.randomFromTo(1e3,9999).toString(16);4>s.length;)s="0"+s;for(var i=Scule.global.functions.randomFromTo(1e5,999999).toString(16);6>i.length;)i="0"+i;t=e+n+s+i}this.id=t,this.$type="id",this.toString=function(){return""+this.id}},Scule.db.classes.ObjectDate=function(t,e){if(void 0===t&&void 0===e){var n=""+(new Date).getTime();t=parseInt(n.substring(0,10),10),e=parseInt(n.substring(10),10)}this.ts=parseInt(t+e,10),this.sec=t,this.usec=e,this.$type="date",this.getTimestamp=function(){return this.ts},this.getSeconds=function(){return this.sec},this.getMicroSeconds=function(){return this.usec},this.toDate=function(){return new Date(1e3*this.sec+this.usec)}},Scule.db.classes.DBRef=function(t,e){if(void 0===t||void 0===e)throw"illegal object reference";this.ref=t,this.id=new Scule.db.classes.ObjectId(e),this.$type="dbref",this.getRef=function(){return this.ref},this.getId=function(){return this.id},this.resolve=function(){return this.resolveReference()},this.resolveReference=function(){var t=Scule.factoryCollection(this.ref);return t.findOne(this.id)}},Scule.db.classes.PrimaryKeyIndex=function(){this.table=Scule.getHashTable(),this.queue=Scule.getDoublyLinkedList(),this.clear=function(){this.table.clear(),this.queue.clear()},this.contains=function(t){return this.table.contains(t)},this.get=function(t){return this.table.contains(t)?this.table.get(t).element:null},this.add=function(t){var e=Scule.global.functions.getObjectId(t,!0);return this.table.contains(e)&&this.remove(t),this.table.put(e,this.queue.add(t)),!0},this.remove=function(t){var e=Scule.global.functions.getObjectId(t,!0);if(!this.table.contains(e))return!1;var n=this.table.remove(e);if(!n)return!1;var s=n.prev,i=n.next;return s&&(s.next=i),i&&(i.prev=s),n.detach(),this.queue.length--,n.element},this.length=function(){return this.queue.length},this.toTable=function(){var t={};return this.queue.forEach(function(e){t[Scule.global.functions.getObjectId(e.element,!0)]=e.element}),t},this.toArray=function(){return this.queue.toArray()}},Scule.db.classes.Collection=function(t){this.documents=Scule.getPrimaryKeyIndex(),this.interpreter=Scule.getQueryInterpreter(),this.version=3,this.lastId=null,this.name=t,this.autoCommit=!1,this.isOpen=!1,this.storage=null,this.setStorageEngine=function(t){this.storage=t},this.setAutoCommit=function(t){this.autoCommit=t},this.getName=function(){return this.name},this.getLength=function(){return this.documents.length()},this.getLastInsertId=function(){return this.lastId},this.open=function(t){if(!this.isOpen){var e=this;this.storage.read(this.name,function(n){if(n){for(var s in n._objects)if(n._objects.hasOwnProperty(s)){var i=n._objects[s];Scule.db.functions.unflattenObject(n._objects[s]),e.documents.add(i)}e.isOpen=!0,t&&t(this)}})}},this.commit=function(t){var e={_sig:null,_salt:null,_name:this.name,_version:this.version,_objects:this.documents.toTable()};this.storage.write(this.name,e,t)},this.find=function(t,e,n){if(Scule.global.constants.ID_FIELD in t)return[this.findOne(t[Scule.global.constants.ID_FIELD])];var s=this.interpreter.interpret(this,t,e);return n&&n(s),s},this.explain=function(t,e,n){this.interpreter.interpret(this,t,e,!0),n&&n()},this.clear=function(t){this.documents.clear(),t&&t(this)},this.findAll=function(t){var e=this.documents.toArray();return t&&t(e),e},this.findOne=function(t,e){Scule.global.functions.isScalar(t)||(t=""+t);var n=null;return this.documents.contains(t)&&(n=this.documents.get(t)),e&&e(n),n},this.save=function(t,e){return Scule.db.functions.unflattenObject(t),t.hasOwnProperty("_id")&&(t._id instanceof Scule.db.classes.ObjectId||(t._id=new Scule.db.classes.ObjectId(t._id))),this.documents.add(t),this.autoCommit&&this.commit(),this.lastId=Scule.global.functions.getObjectId(t),e&&e(this.lastId),this.lastId},this.update=function(t,e,n,s,i){var r=this.interpreter.update(this,t,e,n,s);return i&&i(r),r},this.count=function(t,e,n){var s=this.find(t,e).length;return n&&n(s),s},this.remove=function(t,e,n){var s=this,i=this.find(t,e);return i.forEach(function(t){s.documents.remove(t)}),n&&n(i),i},this.distinct=function(t,e,n){var s=this.find(e),i={};return s.forEach(function(e){e[t]in i||(i[e[t]]=0),i[e[t]]++}),n&&n(i),i},this.merge=function(t,e){if(!t)throw"the merge function requires a valid collection as a parameter";var n=this,s=t.findAll();return s.forEach(function(t){n.documents.contains(t._id)||n.documents.add(t)}),e&&e(this),!0},this.mapReduce=function(t,e,n,s){new Scule.db.classes.MapReduceHandler(t,e,n).run(this,s)}},Scule.db.classes.MapReduceHandler=function(t,e,n){if(this.options=n,!t)throw"A valid function is requires as the `map` parameter of the map/reduce operation";if(!e)throw"A valid function is requires as the `reduce` parameter of the map/reduce operation";if(!("out"in n))throw"A valid output collection connection url is required as the `out` parameter of the map/reduce options object";if(!("merge"in n.out||"reduce"in n.out))throw"A valid output collection connection url is required as either the `merge` or `reduce` out parameter of the map/reduce options object";"query"in n||(n.query={}),"conditions"in n||(n.conditions={}),this.map=t,this.reduce=e,this.finalize="finalize"in n?n.finalize:null,this.run=function(t,e){var n=this,s="merge"in this.options.out,i=Scule.factoryCollection(s?this.options.out.merge:this.options.out.reduce),r=Scule.getHashTable(),a=function(t,e){r.contains(t)||r.put(t,[]),r.get(t).push(e)},u=t.find(this.options.query,this.options.conditions);u.forEach(function(t){n.map(t,a)});var c=null;s&&(c=Scule.factoryCollection("scule+dummy://__mr"+(new Date).getTime()));var o=Scule.getHashTable(),l=r.getKeys();return l.forEach(function(t){o.put(t,n.reduce(t,r.get(t))),n.finalize&&o.put(t,n.finalize(t,o.get(t))),s?c.save(o.get(t)):i.save(o.get(t))}),s&&i.merge(c),e&&e(i),!0}},Scule.db.classes.CollectionFactory=function(){this.collections=Scule.getHashTable(),this.getCollection=function(t,e){if(this.collections.contains(t))return this.collections.get(t).c;e||(e={secret:"dummy"});var n=Scule.db.functions.parseCollectionURL(t);if(!(n.plugin in Scule.db.plugins))throw n.plugin+" is not a registered Scule plugin";if(!(n.engine in Scule.db.engines))throw n.engine+" is nto a registered Scule storage engine";var s=new Scule.db.engines[n.engine](e),i=new Scule.db.plugins[n.plugin](n.name);return i.setStorageEngine(s),i.open(),this.collections.put(t,{c:i,t:(new Date).getTime()}),this.collections.get(t).c}},Scule.db.functions.debug=function(t){Scule.db.variables.debug===!0&&console.log(t)},Scule.db.functions.unflattenObject=function(t){var e=function(t){if(!Scule.global.functions.isScalar(t))for(var n in t)if(t.hasOwnProperty(n)){var s=t[n];if(!Scule.global.functions.isScalar(s)&&s&&"$type"in s)switch(s.$type){case"date":t[n]=new Scule.db.classes.ObjectDate(s.sec,s.usec),t[n].ts=s.ts;break;case"id":t[n]=new Scule.db.classes.ObjectId(s.id);break;case"dbref":t[n]=new Scule.db.classes.DBRef(s.ref,s.id)}else e(s)}};e(t),Scule.global.constants.ID_FIELD in t||(t[Scule.global.constants.ID_FIELD]=new Scule.db.classes.ObjectId)},Scule.db.functions.parseCollectionURL=function(t){var e=t.match(/^([^\+]*)\+([^\/]*)\:\/\/(.*)/);if(!e||4!=e.length)throw t+" is an invalid collection url";return{plugin:e[1],engine:e[2],name:e[3]}},Scule.db.objects.core.collections.factory=new Scule.db.classes.CollectionFactory,Scule.debug=function(t){Scule.db.variables.debug=t},Scule.registerStorageEngine=function(t,e){if(t in Scule.db.engines)throw t+" storage engine is already registered";Scule.db.engines[t]=e},Scule.registerCollectionPlugin=function(t,e){if(t in Scule.db.plugins)throw t+" collection plugin is already registered";Scule.db.plugins[t]=e},function(){Scule.registerStorageEngine("memory",Scule.db.classes.MemoryStorageEngine),Scule.registerStorageEngine("dummy",Scule.db.classes.DummyStorageEngine),Scule.registerStorageEngine("local",Scule.db.classes.LocalStorageStorageEngine),Scule.registerCollectionPlugin("scule",Scule.db.classes.Collection)}(),Scule.factoryCollection=function(t,e){return Scule.db.objects.core.collections.factory.getCollection(t,e)},Scule.dropAll=function(){Scule.db.objects.core.collections.factory.collections.clear()},Scule.getIndex=function(){return new Scule.db.classes.Index},Scule.getHashTableIndex=function(t){return new Scule.db.classes.HashTableIndex(t)},Scule.getBPlusTreeIndex=function(t){return new Scule.db.classes.BPlusTreeIndex(t)},Scule.getObjectId=function(t){return new Scule.db.classes.ObjectId(t)},Scule.getObjectDate=function(t,e){return new Scule.db.classes.ObjectDate(t,e)},Scule.getObjectDateFromDate=function(t){if(!(t instanceof Date))throw Error("unable to factory ObjectDate from non-date object");var e=""+t.getTime(),n=parseInt(e.substring(0,10),10),s=parseInt(e.substring(10),10);return new Scule.db.classes.ObjectDate(n,s)},Scule.getDBRef=function(t,e){return new Scule.db.classes.DBRef(t,e)},Scule.getMemoryStorageEngine=function(t){return new Scule.db.classes.MemoryStorageEngine(t)},Scule.getLocalStorageStorageEngine=function(t){return new Scule.db.classes.LocalStorageStorageEngine(t)},Scule.getSimpleCryptographyProvider=function(){return new Scule.db.classes.SimpleCryptographyProvider},Scule.getBPlusHashingTree=function(t,e){return new Scule.db.classes.BPlusHashingTree(t,e)}}();